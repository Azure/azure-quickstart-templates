{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "allowedValues": [ "East US", "West US", "West Europe", "East Asia", "South East Asia" ],
            "metadata": {
                "description": "This is the location where the cluster will be deployed"
            }
        },
        "storageAccountName": {
            "type": "string",
            "metadata": {
                "description": "The name of the storage account where the virtual hard disks of the VMs are going to be stored"
            }
        },
        "swarmNodesNumber": {
            "type": "int",
            "defaultValue": 3,
            "metadata": {
                "description": "Number of swarm cluster nodes to deploy"
            }
        },
        "swarmClusterNodesSize": {
            "type": "string",
            "defaultValue": "Standard_A1",
            "allowedValues": [
                "Standard_A0",
                "Standard_A1",
                "Standard_A2",
                "Standard_A3",
                "Standard_A4"
            ],
            "metadata": {
                "description": "Size of the VMs for the cluster nodes"
            }
        },
        "adminUsername": {
            "type": "string",
            "defaultValue": "swarmAdmin",
            "metadata": {
                "description": "User name for the root user of the virtual machines"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "defaultValue": "Passw0rd!",
            "metadata": {
                "description": "Password of the root user account inside the virtual machines"
            }
        },
        "swarmMasterPublicIpDnsName": {
            "type": "string",
            "metadata": {
                "description": "Name of the DNS assigned to the master node to be able to access through internet"
            }

        },
        "swarmMasterPublicIpName": {
            "type": "string",
            "defaultValue": "swarmMasterPublicIp",
            "metadata": {
                "description": "Name of the public Ip assigned to the master node"
            }
        },
        "scriptsUri": {
            "type": "string",
            "defaultValue": "https://raw.githubusercontent.com/azure/azure-quickstart-templates/master/docker-experimental-swarm-cluster/",
            "metadata": {
                "description": "Public URL to get the .json templates for the deployment"
            }
        }

    },
    "variables": {
        "networkingSettings": {
            "virtualNetworkName": "dockerSwarmVnet",
            "virtualNetworkPrefix": "10.0.0.0/8",
            "subnetSwarmName": "Swarm-Subnet",
            "subnetSwarmPrefix": "10.0.1.0/24",
            "subnetManageName": "Manage-Subnet",
            "subnetManagePrefix": "10.0.0.0/24"
        }
    },
    "resources": [
        {
            "name": "shared-resources",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('scriptsUri'), 'shared-resources.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('networkingSettings').virtualNetworkName]"
                    },
                    "virtualNetworkPrefix": {
                        "value": "[variables('networkingSettings').virtualNetworkPrefix]"
                    },
                    "subnetSwarmName": {
                        "value": "[variables('networkingSettings').subnetSwarmName]"
                    },
                    "subnetSwarmPrefix": {
                        "value": "[variables('networkingSettings').subnetSwarmPrefix]"
                    },
                    "subnetManageName": {
                        "value": "[variables('networkingSettings').subnetManageName]"
                    },
                    "subnetManagePrefix": {
                        "value": "[variables('networkingSettings').subnetManagePrefix]"
                    }
                }
            }
        },
        {
            "name": "cluster-nodes",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/shared-resources"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('scriptsUri'), 'cluster-node-deploy.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('networkingSettings').virtualNetworkName]"
                    },
                    "subnetSwarmName": {
                        "value": "[variables('networkingSettings').subnetSwarmName]"
                    },
                    "swarmNodesNumber": {
                        "value": "[parameters('swarmNodesNumber')]"
                    },
                    "swarmClusterNodesSize": {
                        "value": "[parameters('swarmClusterNodesSize')]"
                    },
                    "adminUserName": {
                        "value": "[parameters('adminUserName')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "scriptsUri": {
                        "value": "[concat(parameters('scriptsUri'),'install-docker-node.sh')]"
                    }
                }
            }
        },
        {
            "name": "cluster-master",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/shared-resources",
                "Microsoft.Resources/deployments/cluster-nodes"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('scriptsUri'), 'master-node-deploy.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('networkingSettings').virtualNetworkName]"
                    },
                    "subnetSwarmName": {
                        "value": "[variables('networkingSettings').subnetSwarmName]"
                    },
                    "swarmNodesNumber": {
                        "value": "[parameters('swarmNodesNumber')]"
                    },
                    "swarmClusterNodesSize": {
                        "value": "[parameters('swarmClusterNodesSize')]"
                    },
                    "adminUserName": {
                        "value": "[parameters('adminUserName')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "swarmMasterPublicIpName": {
                        "value": "[parameters('swarmMasterPublicIpName')]"
                    },
                    "swarmMasterPublicIpDnsName": {
                        "value": "[parameters('swarmMasterPublicIpDnsName')]"
                    },
                    "scriptsUri": {
                        "value": "[concat(parameters('scriptsUri'),'install-docker-master.sh')]"
                    }
                }
            }
        }
    ]
}
