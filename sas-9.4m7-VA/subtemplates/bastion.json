{
  "type": "Microsoft.Network/publicIPAddresses",
  "apiVersion": "2019-12-01",
  "name": "bastionvmPublicIP",
  "location": "[parameters('location')]",
  "dependsOn": [
      "[resourceId('Microsoft.Compute/proximityPlacementGroups', parameters('proximity'))]"
  ],
  "sku": {
    "name": "Standard"
  },
  "properties": {
    "publicIPAllocationMethod": "Static"
  }
},
{
    "type": "Microsoft.Network/bastionHosts",
    "apiVersion": "2019-12-01",
    "name": "bastion",
    "condition": "[variables('hasBastion')]",
    "location": "[variables('location')]",
    "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
        "[resourceId('Microsoft.Compute/proximityPlacementGroups', variables('proximity'))]"
    ],
    "properties": {
        "ipConfigurations": [
            {
                "name": "IpConf",
                "properties": {
                    "privateIPAllocationMethod": "Dynamic",
                    "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('vnetName'),'-ip-bastion'))]"
                    },
                    "subnet": {
                        "id": "[resourceId(variables('vnetResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), 'AzureBastionSubnet')]"
                    }
                }
            }
        ]
    }
},
{
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2019-12-01",
      "name": "bastion_sg",
      "condition": "[variables('useNewNetwork')]",
      "dependsOn": [
          "[resourceId('Microsoft.Compute/proximityPlacementGroups', variables('proximity'))]"
      ],
      "location": "[variables('location')]",
      "properties": {
          "securityRules": [
              {
                  "name": "allow_https_from_ip_or_range",
                  "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                  "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "[variables('webIngressLocation')]",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 500,
                      "direction": "Inbound"
                  }
              },
              {
                  "name": "allow_https_from_gateway_manager",
                  "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                  "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "GatewayManager",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 501,
                      "direction": "Inbound"
                  }
              },
              {
                  "name": "allow_ssh_to_vnet",
                  "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                  "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 500,
                      "direction": "Outbound"
                  }
              },
              {
                  "name": "allow_rdp_to_vnet",
                  "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                  "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3389",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 501,
                      "direction": "Outbound"
                  }
              },
              {
                  "name": "allow_https_to_azurecloud",
                  "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                  "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "AzureCloud",
                      "access": "Allow",
                      "priority": 503,
                      "direction": "Outbound"
                  }
              }

          ]
      }
  },
