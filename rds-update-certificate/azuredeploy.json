{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {

        "applicationId": {
            "type": "string",
            "metadata": {
                "description": "AD application Id."
            }
        },
        "applicationPassword": {
            "type": "securestring",
            "metadata": {
                "description": "AD application password."
            }
        },
        "tenantId": {
            "type": "string",
            "metadata": {
                "description": "Tenant Id where Secure Principal was created."
            }
        },
        "vaultName": {
            "type": "string",
            "metadata": {
                "description": "Azure Key Vault name."
            }
        },
        "secretName": {
            "type": "string",
            "metadata": {
                "description": "Name of the secret in Azure Key Vault where the certificate is stored."
            }
        },
        "rdsRole": {
            "type": "string",
            "allowedValues": [
                "All",
                "RDGateway",
                "RDWebAccess",
                "RDRedirector",
                "RDPublishing"
            ],
            "metadata": {
                "description": "RDS role for which to configure the certificate."
            }
        },
        "certificatePassword": {
            "type": "securestring",
            "metadata": {
                "description": "`[Optional`] A password to secure the certificate with."
            }
        }
    },

    "variables": {
        "apiVersion": "2015-06-15",

        "p": {
            "appid": "[concat(' -appId ', parameters('applicationId'))]",
            "apppassword": "[concat(' -appPassword ', parameters('applicationPassword'))]",
            "tenantid": "[concat(' -tenantId ', parameters('tenantId'))]",
            "vault": "[concat(' -vaultName ', parameters('vaultName'))]",
            "secret": "[concat(' -secretName ', parameters('secretName'))]",
            "role": "[concat(' -roleName ', parameters('rdsRole'))]"
        },
        "scriptParameters": "[concat(variables('p').appid, variables('p').apppassword, variables('p').tenantid, variables('p').vault, variables('p').secret, variables('p').role)]"
    },

    "resources": [
        {
            "apiVersion": "[variables('apiversion')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "cb-vm/customscript",
            "location": "[resourceGroup().location]",
            "tags": {
                "displayName": "script"
            },
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.8",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [
                        "https://gallery.technet.microsoft.com/scriptcenter/Impersonate-a-User-9bfeff82/file/127189/1/New-ImpersonateUser.ps1",
                        "https://raw.githubusercontent.com/mmarch/azure-quickstart-templates/master/rds-update-certificate/Scripts/Script.ps1"
                    ]
                },
                "protectedSettings": {
                    "commandToExecute": "[concat( 'powershell -noninteractive -executionpolicy bypass -file script.ps1 ', variables('scriptParameters'), ' >> script.log 2>&1' )]"
                }
            }
        }
    ],
    "outputs": {
    }
}
