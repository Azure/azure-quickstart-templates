{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "westus",
      "allowedValues": [
        "westus",
        "eastus",
        "centralus"
      ],
      "metadata": {
        "description": "Location where all the resources deploy"
      }
    },
    "hdiclusterType": {
      "type": "string",
      "defaultValue": "hadoop",
      "allowedValues": [
        "hadoop",
        "hbase",
        "storm",
        "spark"
      ],
      "metadata": {
        "description": "The type of the HDInsight cluster to create."
      }
    },
    "hdiclusterName": {
      "type": "string",
      "defaultValue": "datameerhdi",
      "metadata": {
        "description": "The name of the HDInsight cluster to create."
      }
    },
    "hdiclusterLoginUserName": {
      "type": "string",
      "defaultValue": "demo",
      "metadata": {
        "description": "These credentials can be used to submit jobs to the cluster and to log into cluster dashboards."
      }
    },
    "hdiclusterLoginPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password must be at least 8 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
      }
    },
    "hdisshUserName": {
      "type": "string",
      "defaultValue": "demo",
      "metadata": {
        "description": "These credentials can be used to remotely access the cluster."
      }
    },
    "hdisshPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password must be at least 8 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
      }
    },
    "hdistorageAccount": {
      "type": "string",
      "defaultValue": "hadoopstgacc",
      "metadata": {
        "description": "The name of the storage account to use"
      }
    },
    "vmAdminNameTrendDSM": {
      "type": "string",
      "defaultValue": "demo",
      "metadata": {
        "description": "TrendMicro Deep Security Manager Virtual Machine admin username"
      }
    },
    "vmAdminPasswordTrendDSM": {
      "type": "securestring",
      "metadata": {
        "description": "TrendMicro Deep Security Manager Virtual Machine admin password"
      }
    },
    "vmSizeTrendDSM": {
      "type": "string",
      "defaultValue": "Standard_D2_v2",
      "allowedValues": [
        "Standard_D2_v2",
        "Standard_D3_v2",
        "Standard_D4_v2",
        "Standard_D5_v2"
      ],
      "metadata": {
        "description": "TrendMicro Deep Security Manager Virtual Machine size"
      }
    },
    "dsmAdminName": {
      "type": "string",
      "defaultValue": "demo",
      "metadata": {
        "description": "TrendMicro Deep Security Manager application username (To login to Trend DSM from browser)"
      }
    },
    "dsmAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "TrendMicro Deep Security Manager application password (To login to Trend DSM from browser)"
      }
    },
    "dbName": {
      "type": "string",
      "defaultValue": "dsm",
      "metadata": {
        "description": "TrendMicro Deep Security Manager database name"
      }
    },
    "dbAdminName": {
      "type": "string",
      "defaultValue": "demo",
      "metadata": {
        "description": "TrendMicro Deep Security Manager database admin user"
      }
    },
    "dbAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "TrendMicro Deep Security Manager database admin password"
      }
    },
    "publicIPDomainNameLabelTrendDSM": {
      "type": "string",
      "defaultValue": "publicdnstrenddsm",
      "metadata": {
        "description": "TrendMicro Deep Security Manager unique public DNS prefix"
      }
    },
    "managerPortTrendDSM": {
      "type": "string",
      "defaultValue": "443",
      "metadata": {
        "description": "TrendMicro Deep Security Manager management port"
      }
    },
    "heartbeatPortTrendDSM": {
      "type": "string",
      "defaultValue": "4120",
      "metadata": {
        "description": "TrendMicro Deep Security Manager heartbeat port"
      }
    },
    "vmAdminUsernameOrchServer": {
      "defaultValue": "demo",
      "type": "string",
      "metadata": {
        "description": "Orchestrator Server Virtual Machine admin username"
      }
    },
    "vmAdminPasswordOrchServer": {
      "type": "securestring",
      "metadata": {
        "description": "Orchestrator Server Virtual Machine admin password"
      }
    },
    "publicIPDomainNameLabelOrchServer": {
      "defaultValue": "publicdnsorcserver",
      "type": "string",
      "metadata": {
        "description": "Orchestrator Server unique public DNS prefix"
      }
    },
    "vmAdminUsernameChefServer": {
      "defaultValue": "demo",
      "type": "string",
      "metadata": {
        "description": "Chef Server Virtual Machine admin username"
      }
    },
    "vmAdminPasswordChefServer": {
      "type": "securestring",
      "metadata": {
        "description": "Chef Server Virtual Machine admin password"
      }
    },
    "vmSizeChefServer": {
      "type": "string",
      "defaultValue": "Standard_D2",
      "allowedValues": [
        "Standard_D2",
        "Standard_D3",
        "Standard_D4",
        "Standard_D2_v2",
        "Standard_D3_v2",
        "Standard_D4_v2"
      ],
      "metadata": {
        "description": "Chef Server Virtual Machine size"
      }
    },
    "publicIPDomainNameLabelChefServer": {
      "type": "string",
      "defaultValue": "publicdnschefserver",
      "metadata": {
        "description": "Chef Server unique public DNS prefix"
      }
    },
    "chefUserName": {
      "type": "string",
      "defaultValue": "chefuser",
      "metadata": {
        "description": "Chef user name"
      }
    },
    "chefUserFirstName": {
      "type": "string",
      "defaultValue": "chef",
      "metadata": {
        "description": "Chef user first name"
      }
    },
    "chefUserLastName": {
      "type": "string",
      "defaultValue": "user",
      "metadata": {
        "description": "Chef user last name"
      }
    },
    "chefUserEmail": {
      "type": "string",
      "defaultValue": "chef@noone.com",
      "metadata": {
        "description": "Chef user email"
      }
    },
    "chefUserPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Chef user password"
      }
    },
    "chefOrgShortName": {
      "type": "string",
      "defaultValue": "ct",
      "metadata": {
        "description": "Chef org short name"
      }
    },
    "chefOrgFullName": {
      "type": "string",
      "defaultValue": "Chef Test Inc",
      "metadata": {
        "description": "Chef Org full name"
      }
    },
    "adminUsernameChefWorkstation": {
      "type": "string",
      "defaultValue": "demo",
      "metadata": {
        "description": "Chef Workstation Virtual Machine admin username"
      }
    },
    "adminPasswordChefWorkstation": {
      "type": "securestring",
      "metadata": {
        "description": "Chef Workstation Virtual Machine admin password"
      }
    },
    "vmSizeChefWorkstation": {
      "type": "string",
      "defaultValue": "Standard_D2_v2",
      "allowedValues": [
        "Standard_D2_v2",
        "Standard_D3_v2",
        "Standard_D4_v2"
      ],
      "metadata": {
        "description": "Chef Workstation Virtual Machine size"
      }
    },
    "publicIPDomainNameLabelChefWorkstation": {
      "type": "string",
      "defaultValue": "publicdnschefws",
      "metadata": {
        "description": "Chef Workstation unique public DNS prefix"
      }
    },
    "adminUsernameDSAgentWindows": {
      "type": "string",
      "defaultValue": "demo",
      "metadata": {
        "description": "Windows Deep Security Agent Virtual Machine admin username"
      }
    },
    "adminPasswordDSAgentWindows": {
      "type": "securestring",
      "metadata": {
        "description": "Windows Deep Security Agent Virtual Machine admin password"
      }
    },
    "publicIPDomainNameLabelDSAgentWindows": {
      "type": "string",
      "defaultValue": "dnsdsagwin",
      "metadata": {
        "description": "Windows Deep Security Agent unique public DNS prefix"
      }
    },
    "windowsvmcount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Count of Windows Deep Security Agents to deploy"
      }
    },
    "adminUsernameDSAgent": {
      "type": "string",
      "defaultValue": "demo",
      "metadata": {
        "description": "Linux Deep Security Agent Virtual Machine admin username"
      }
    },
    "adminPasswordDSAgent": {
      "type": "securestring",
      "metadata": {
        "description": "Linux Deep Security Agent Virtual Machine admin password"
      }
    },
    "publicIPDomainNameLabelDSAgent": {
      "type": "string",
      "defaultValue": "dnsdsaglinux",
      "metadata": {
        "description": "Linux Deep Security Agent unique public DNS prefix"
      }
    },
    "linuxvmcount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Count of Linux Deep Security Agents to deploy"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "Artifactslocation"
      },
      "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/datameer-trend-chef-riskanalysis"
    },
    "_artifactsLocationSasToken": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Reserved for deploying using Visual Studio. Please keep it as an empty string"
      }
    }
  },
  "variables": {
    "location": "[parameters('location')]",
    "vmNameTrendDSM": "trendMicroDSM",
    "vmNameChefServer": "chefServer",
    "vmNameChefWorkstation": "chefWS",
    "vmNameDSAWindows": "dsawindows",
    "vmNameDSAgent": "dsalinux",
    "vmNameOrchServer": "orchestratorServer",
    "nicNameTrendDSM": "[concat(variables('vmNameTrendDSM'),'-nic')]",
    "networkInterfaceNameChefServer": "[concat(variables('vmNameChefServer'),'-nic')]",

    "networkInterfaceNameOrchServer": "[concat(variables('vmNameOrchServer'),'-nic')]",
    "securityGroupNameTrendDSM": "[concat(variables('nicNameTrendDSM'),'-nsg')]",
    "networkSecurityGroupNameChefServer": "[concat(variables('networkInterfaceNameChefServer'),'-nsg')]",
    "networkSecurityGroupNameOrchServer": "[concat(variables('networkInterfaceNameOrchServer'),'-nsg')]",
    "virtualNetworkName": "datameerP2PVnet",
    "vnetAddressPrefix": "10.7.0.0/16",
    "subnet1Name": "trendMicroDSMsubnet",
    "subnet1Prefix": "10.7.0.0/24",
    "subnet2Name": "chefServersubnet",
    "subnet2Prefix": "10.7.1.0/24",
    "subnet3StartAddress": "10.7.2.5",
    "subnet4Name": "vmsubnet",
    "subnet4Prefix": "10.7.3.0/24",
    "subnet3Name": "[concat(variables('datameerHDInsightCluster').clusterName,'subnet')]",
    "subnet3Prefix": "10.7.4.0/24",
    "publicIPAddressType": "Dynamic",
    "publicIPAddressNameTrendDSM": "publicIPTrendDSM",
    "publicIPAddressNameChefServer": "publicIPChefServer",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
    "subnet1Ref": "[concat(variables('vnetID'),'/subnets/',variables('subnet1Name'))]",
    "subnet2Ref": "[concat(variables('vnetID'),'/subnets/',variables('subnet2Name'))]",
    "subnet3Ref": "[concat(variables('vnetID'),'/subnets/',variables('subnet3Name'))]",
    "subnet4Ref": "[concat(variables('vnetID'),'/subnets/',variables('subnet4Name'))]",
    "storageAccountName": "[tolower(concat(trim(substring(concat(variables('vmNameTrendDSM'),'       '),0,6)),uniquestring(resourceGroup().id)))]",
    "storageAccountType": "Standard_LRS",
    "vmStorageAccountContainerName": "vhds",
    "newsqlServerName": "[tolower(concat(variables('vmNameTrendDSM'),uniquestring(resourceGroup().id),'-sql'))]",
    "storage-api-version": "2015-06-15",
    "deployment-api-version": "2015-11-01",
    "deployment-api-version2": "2015-01-01",
    "network-api-version": "2015-06-15",
    "compute-api-version": "2015-06-15",
    "automation-api-version": "2015-01-01-preview",
    "automation-api-version2": "2015-10-31",
    "publisherTrendDSM": "trendmicro",
    "publisherChefServer": "chef-software",
    "licenseMode": "10",
    "databaseOption": "new",
    "offerChoosedTrendDSM": "[variables(concat('offer', parameters('vmSizeTrendDSM')))]",
    "offerChoosedChefServer": "[variables(concat('offer', parameters('vmSizeChefServer')))]",
    "offerStandard_D2_v2": {
      "vmSize": "Standard_D2_v2",
      "vmSku": "dxxn25d2v2",
      "product": "deep-security-vm"
    },
    "offerStandard_D3_v2": {
      "vmSize": "Standard_D3_v2",
      "vmSku": "dxxn50d3v2",
      "product": "deep-security-vm"
    },
    "offerStandard_D4_v2": {
      "vmSize": "Standard_D4_v2",
      "vmSku": "dxxn100d4v2",
      "product": "deep-security-vm"
    },
    "offerStandard_D5_v2": {
      "vmSize": "Standard_D5_v2",
      "vmSku": "dxxn200d5v2",
      "product": "deep-security-vm"
    },
    "offerBYOL": {
      "vmSize": "[parameters('vmSizeTrendDSM')]",
      "vmSku": "dxxnbyol",
      "product": "deep-security-vm-byol"
    },
    "offerStandard_D2": {
      "vmSize": "Standard_D2",
      "vmSku": "azure_marketplace_25",
      "product": "chef-server"
    },
    "availabilitySetSettings": {
      "name": "[concat(variables('virtualNetworkName'), '-aset')]",
      "count": "[variables('availabilitySetCount')]",
      "fdCount": 3,
      "udCount": 5
    },
    "sshFrom": "0.0.0.0/0",
    "forwardedDataFrom": "0.0.0.0/0",
    "emptyTemplateUrl": "[concat(parameters('_artifactsLocation'),'/nested/empty-resources.json')]",
    "availabilitySetCount": 1,
    "linuxConfigurationChoosenTrendDSM": "[variables(concat('linuxConfiguration', variables('vmAuthTypeTrendDSM')))]",
    "linuxConfigurationpassword": {
      "disablePasswordAuthentication": "false"
    },
    "linuxConfigurationsshPublicKey": {
      "disablePasswordAuthentication": "true",
      "ssh": {
        "publicKeys": [
          {
            "path": "[concat('/home/',parameters('vmAdminNameTrendDSM'),'/.ssh/authorized_keys')]",
            "keyData": "[variables('vmAdminSshPublicKeyTrendDSM')]"
          }
        ]
      }
    },
    "imagePublisherWindows": "MicrosoftWindowsServer",
    "imageOfferWindows": "WindowsServer",
    "imagePublisherLinux": "Canonical",
    "imageOfferLinux": "UbuntuServer",
    "TenantIdentifier": "NA",
    "TenantActivationPassword": "NA",
    "tagvalues": {
      "program": "PushToPilot",
      "project": "DatameerTrendHDInsightChef"
    },
    "vmAuthTypeTrendDSM": "password",
    "vmAdminSshPublicKeyTrendDSM": "",
    "existingSQLServerName": "",
    "networkExists": "new",
    "ManagerAddress": "[concat(parameters('publicIPDomainNameLabelTrendDSM'),variables('uniqueString'),'.',parameters('location'),'.cloudapp.azure.com')]",
    "udpPort": "5005",
    "chefServerScriptUrl": "[concat(parameters('_artifactsLocation'),'/scripts/chefserver.sh')]",
    "chefprefix": "chef",
    "vmSizeDSAWindows": "Standard_D1",
    "windowsOSVersion": "2012-R2-Datacenter",
    "vmSizeDSAgent": "Standard_D1",
    "ubuntuOSVersion": "14.04.2-LTS",
    "uniqueString": "[uniquestring(resourceGroup().id)]",
    "keyName": "validatorkey",
    "resourcegroupName": "[resourceGroup().name]",
    "kmServerUrl": "[concat(parameters('publicIPDomainNameLabelOrchServer'),variables('uniqueString'),'.',variables('location'),'.cloudapp.azure.com')]",
    "chef_node_name": "chefnodedsagent",
    "chef_server_url": "[concat('https://',parameters('publicIPDomainNameLabelChefServer'),variables('uniqueString'),'.',parameters('location'),'.cloudapp.azure.com/organizations/',parameters('chefOrgShortName'))]",
    "validation_client_name": "[concat(parameters('chefOrgShortName'),'-validator')]",
    "validation_key_format": "base64encoded",
    "runlist": "recipe[trendmicro]",
    "vmSizeOrcServer": "Standard_D1",
    "orcServerubuntuOSVersion": "14.04.2-LTS",
    "installOrchTemplateurl": "[concat(parameters('_artifactsLocation'),'/nested/orchestrator-server-setup-trend.json')]",
    "chefnodeCustomScripturl": "[concat(parameters('_artifactsLocation'),'/scripts/p2pchefnodebootstrap.sh')]",
    "vnetstorageSciptrul": "[concat(parameters('_artifactsLocation'), '/nested/trendp2p-vnetstorage.json')]",
    "datameerHDInsightCluster": {
      "defaultApiVersion": "2015-05-01-preview",
      "clusterName": "[tolower(concat(trim(substring(concat(parameters('hdiclusterName'),'       '),0,6)),uniquestring(resourceGroup().id)))]",
      "standaloneTemplateUrl": "[concat(parameters('_artifactsLocation'), '/nested/datameer-hdinsight.json')]",
      "clusterType": "[parameters('hdiclusterType')]",
      "clusterLoginUserName": "[parameters('hdiclusterLoginUserName')]",
      "clusterLoginPassword": "[parameters('hdiclusterLoginPassword')]",
      "sshUserName": "[parameters('hdisshUserName')]",
      "sshPassword": "[parameters('hdisshPassword')]",
      "storageAccount": "[tolower(concat(trim(substring(concat(parameters('hdistorageAccount'),'       '),0,6)),uniquestring(resourceGroup().id)))]"
    },
    "datameerTags": {
      "type": "object",
      "provider": "ED5CBF45-2AA4-4408-B52D-1C76DFCA0BD7"
    },
    "trendmicroTags": {
      "type": "object",
      "provider": "F0253A01-8156-4D41-BD91-E182158D4972"
    },
    "chefSoftwareTags":{
      "type":"object",
      "provider":"33194f91-eb5f-4110-827a-e95f640a9e46"
    },
    "quickstartTags": {
      "type": "object",
      "name": "datameer-trend-chef-riskanalysis"
      }
  },
  "resources": [
    {
      "comments": "Common",
      "name": "vnetstorage",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deployment-api-version2')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vnetstorageSciptrul')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "storage-api-version": {
            "value": "[variables('storage-api-version')]"
          },
          "storageAccountType": {
            "value": "[variables('storageAccountType')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "virtualNetworkName": {
            "value": "[variables('virtualNetworkName')]"
          },
          "vnetAddressPrefix": {
            "value": "[variables('vnetAddressPrefix')]"
          },
          "subnet1Name": {
            "value": "[variables('subnet1Name')]"
          },
          "subnet1Prefix": {
            "value": "[variables('subnet1Prefix')]"
          },
          "subnet2Name": {
            "value": "[variables('subnet2Name')]"
          },
          "subnet2Prefix": {
            "value": "[variables('subnet2Prefix')]"
          },
          "subnet3Name": {
            "value": "[variables('subnet3Name')]"
          },
          "subnet3Prefix": {
            "value": "[variables('subnet3Prefix')]"
          },
          "subnet4Name": {
            "value": "[variables('subnet4Name')]"
          },
          "subnet4Prefix": {
            "value": "[variables('subnet4Prefix')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "availabilitySetSettings": {
            "value": "[variables('availabilitySetSettings')]"
          },
          "datameerTags": {
            "value": "[variables('datameerTags')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "name": "trendmicrodsm",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deployment-api-version2')]",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/nested/trendp2p-trenddsm.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "publicIPDomainNameLabelTrendDSM": {
            "value": "[concat(parameters('publicIPDomainNameLabelTrendDSM'),variables('uniqueString'))]"
          },
          "publicIPAddressType": {
            "value": "[variables('publicIPAddressType')]"
          },
          "publicIPAddressNameTrendDSM": {
            "value": "[variables('publicIPAddressNameTrendDSM')]"
          },
          "nicNameTrendDSM": {
            "value": "[variables('nicNameTrendDSM')]"
          },
          "virtualNetworkName": {
            "value": "[variables('virtualNetworkName')]"
          },
          "subnet1Ref": {
            "value": "[variables('subnet1Ref')]"
          },
          "securityGroupNameTrendDSM": {
            "value": "[variables('securityGroupNameTrendDSM')]"
          },
          "managerPortTrendDSM": {
            "value": "[parameters('managerPortTrendDSM')]"
          },
          "heartbeatPortTrendDSM": {
            "value": "[parameters('heartbeatPortTrendDSM')]"
          },
          "vmNameTrendDSM": {
            "value": "[variables('vmNameTrendDSM')]"
          },
          "publisherTrendDSM": {
            "value": "[variables('publisherTrendDSM')]"
          },
          "offerChoosedTrendDSM": {
            "value": "[variables('offerChoosedTrendDSM')]"
          },
          "vmAdminNameTrendDSM": {
            "value": "[parameters('vmAdminNameTrendDSM')]"
          },
          "vmAdminPasswordTrendDSM": {
            "value": "[parameters('vmAdminPasswordTrendDSM')]"
          },
          "linuxConfigurationChoosenTrendDSM": {
            "value": "[variables('linuxConfigurationChoosenTrendDSM')]"
          },
          "deployment-api-version": {
            "value": "[variables('deployment-api-version')]"
          },
          "baseUrl": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "databaseOption": {
            "value": "[variables('databaseOption')]"
          },
          "newsqlServerName": {
            "value": "[variables('newsqlServerName')]"
          },
          "existingSQLServerName": {
            "value": "[variables('existingSQLServerName')]"
          },
          "dbAdminName": {
            "value": "[parameters('dbAdminName')]"
          },
          "dbAdminPassword": {
            "value": "[parameters('dbAdminPassword')]"
          },
          "dbName": {
            "value": "[parameters('dbName')]"
          },
          "dsmAdminName": {
            "value": "[parameters('dsmAdminName')]"
          },
          "dsmAdminPassword": {
            "value": "[parameters('dsmAdminPassword')]"
          },
          "datameerTags": {
            "value": "[variables('datameerTags')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "name": "orchestrator",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deployment-api-version2')]",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/nested/trendp2p-orchestrator.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "deployment-api-version2": {
            "value": "[variables('deployment-api-version2')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "publicIPDomainNameLabelOrchServer": {
            "value": "[concat(parameters('publicIPDomainNameLabelOrchServer'),variables('uniqueString'))]"
          },
          "vmNameOrchServer": {
            "value": "[variables('vmNameOrchServer')]"
          },
          "networkInterfaceNameOrchServer": {
            "value": "[variables('networkInterfaceNameOrchServer')]"
          },
          "networkSecurityGroupNameOrchServer": {
            "value": "[variables('networkSecurityGroupNameOrchServer')]"
          },
          "vmAdminUsernameOrchServer": {
            "value": "[parameters('vmAdminUsernameOrchServer')]"
          },
          "vmAdminPasswordOrchServer": {
            "value": "[parameters('vmAdminPasswordOrchServer')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "imagePublisherLinux": {
            "value": "[variables('imagePublisherLinux')]"
          },
          "imageOfferLinux": {
            "value": "[variables('imageOfferLinux')]"
          },
          "orcServerubuntuOSVersion": {
            "value": "[variables('orcServerubuntuOSVersion')]"
          },
          "vmSizeOrcServer": {
            "value": "[variables('vmSizeOrcServer')]"
          },
          "subnet2Ref": {
            "value": "[variables('subnet2Ref')]"
          },
          "installOrchTemplateurl": {
            "value": "[variables('installOrchTemplateurl')]"
          },
          "datameerTags": {
            "value": "[variables('datameerTags')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "name": "chefserver",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deployment-api-version2')]",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']",
        "['Microsoft.Resources/deployments/trendmicrodsm']",
        "['Microsoft.Resources/deployments/orchestrator']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/nested/trendp2p-chefserver.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "publicIPAddressNameChefServer": {
            "value": "[variables('publicIPAddressNameChefServer')]"
          },
          "publicIPDomainNameLabelChefServer": {
            "value": "[concat(parameters('publicIPDomainNameLabelChefServer'),variables('uniqueString'))]"
          },
          "networkSecurityGroupNameChefServer": {
            "value": "[variables('networkSecurityGroupNameChefServer')]"
          },
          "networkInterfaceNameChefServer": {
            "value": "[variables('networkInterfaceNameChefServer')]"
          },
          "vmNameChefServer": {
            "value": "[variables('vmNameChefServer')]"
          },
          "vmAdminUsernameChefServer": {
            "value": "[parameters('vmAdminUsernameChefServer')]"
          },
          "vmAdminPasswordChefServer": {
            "value": "[parameters('vmAdminPasswordChefServer')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "publisherChefServer": {
            "value": "[variables('publisherChefServer')]"
          },
          "offerChoosedChefServer": {
            "value": "[variables('offerChoosedChefServer')]"
          },
          "subnet2Ref": {
            "value": "[variables('subnet2Ref')]"
          },
          "publicIPAddressType": {
            "value": "[variables('publicIPAddressType')]"
          },
          "chefUserName": {
            "value": "[parameters('chefUserName')]"
          },
          "chefUserFirstName": {
            "value": "[parameters('chefUserFirstName')]"
          },
          "chefUserLastName": {
            "value": "[parameters('chefUserLastName')]"
          },
          "chefUserEmail": {
            "value": "[parameters('chefUserEmail')]"
          },
          "chefUserPassword": {
            "value": "[parameters('chefUserPassword')]"
          },
          "chefOrgShortName": {
            "value": "[parameters('chefOrgShortName')]"
          },
          "chefOrgFullName": {
            "value": "[parameters('chefOrgFullName')]"
          },
          "chefServerScriptUrl": {
            "value": "[variables('chefServerScriptUrl')]"
          },
          "publicIPDomainNameLabelOrchServer": {
            "value": "[concat(parameters('publicIPDomainNameLabelOrchServer'),variables('uniqueString'))]"
          },
          "datameerTags": {
            "value": "[variables('datameerTags')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('deployment-api-version2')]",
      "type": "Microsoft.Resources/deployments",
      "name": "dsagents",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']",
        "['Microsoft.Resources/deployments/trendmicrodsm']",
        "['Microsoft.Resources/deployments/chefserver']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/nested/trendp2p-dsagents.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "vmNameDSAWindows": {
            "value": "[variables('vmNameDSAWindows')]"
          },
          "vmSizeDSAWindows": {
            "value": "[variables('vmSizeDSAWindows')]"
          },
          "adminUsernameDSAgentWindows": {
            "value": "[parameters('adminUsernameDSAgentWindows')]"
          },
          "adminPasswordDSAgentWindows": {
            "value": "[parameters('adminPasswordDSAgentWindows')]"
          },
          "publicIPDomainNameLabelDSAgentWindows": {
            "value": "[concat(parameters('publicIPDomainNameLabelDSAgentWindows'),variables('uniqueString'))]"
          },
          "windowsOSVersion": {
            "value": "[variables('windowsOSVersion')]"
          },
          "windowsvmcount": {
            "value": "[parameters('windowsvmcount')]"
          },
          "vmNameDSAgent": {
            "value": "[variables('vmNameDSAgent')]"
          },
          "vmSizeDSAgent": {
            "value": "[variables('vmSizeDSAgent')]"
          },
          "adminUsernameDSAgent": {
            "value": "[parameters('adminUsernameDSAgent')]"
          },
          "adminPasswordDSAgent": {
            "value": "[parameters('adminPasswordDSAgent')]"
          },
          "publicIPDomainNameLabelDSAgent": {
            "value": "[concat(parameters('publicIPDomainNameLabelDSAgent'),variables('uniqueString'))]"
          },
          "ubuntuOSVersion": {
            "value": "[variables('ubuntuOSVersion')]"
          },
          "linuxvmcount": {
            "value": "[parameters('linuxvmcount')]"
          },
          "ManagerAddress": {
            "value": "[variables('ManagerAddress')]"
          },
          "subnet4Ref": {
            "value": "[variables('subnet4Ref')]"
          },
          "imagePublisherWindows": {
            "value": "[variables('imagePublisherWindows')]"
          },
          "imageOfferWindows": {
            "value": "[variables('imageOfferWindows')]"
          },
          "imagePublisherLinux": {
            "value": "[variables('imagePublisherLinux')]"
          },
          "imageOfferLinux": {
            "value": "[variables('imageOfferLinux')]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "ActivationPort": {
            "value": "[parameters('heartbeatPortTrendDSM')]"
          },
          "TenantIdentifier": {
            "value": "[variables('TenantIdentifier')]"
          },
          "TenantActivationPassword": {
            "value": "[variables('TenantActivationPassword')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "datameerTags": {
            "value": "[variables('datameerTags')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('deployment-api-version2')]",
      "type": "Microsoft.Resources/deployments",
      "name": "chefnodes",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']",
        "['Microsoft.Resources/deployments/trendmicrodsm']",
        "['Microsoft.Resources/deployments/chefserver']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/nested/trendp2p-chefnodes.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "deployment-api-version2": {
            "value": "[variables('deployment-api-version2')]"
          },
          "vmNameChefWorkstation": {
            "value": "[variables('vmNameChefWorkstation')]"
          },
          "vmSizeChefWorkstation": {
            "value": "[parameters('vmSizeChefWorkstation')]"
          },
          "adminUsernameChefWorkstation": {
            "value": "[parameters('adminUsernameChefWorkstation')]"
          },
          "adminPasswordChefWorkstation": {
            "value": "[parameters('adminPasswordChefWorkstation')]"
          },
          "publicIPDomainNameLabelChefWorkstation": {
            "value": "[concat(parameters('publicIPDomainNameLabelChefWorkstation'),variables('uniqueString'))]"
          },
          "vmNameDSAWindows": {
            "value": "[variables('vmNameDSAWindows')]"
          },
          "vmSizeDSAWindows": {
            "value": "[variables('vmSizeDSAWindows')]"
          },
          "adminUsernameDSAgentWindows": {
            "value": "[parameters('adminUsernameDSAgentWindows')]"
          },
          "adminPasswordDSAgentWindows": {
            "value": "[parameters('adminPasswordDSAgentWindows')]"
          },
          "publicIPDomainNameLabelDSAgentWindows": {
            "value": "[concat(parameters('publicIPDomainNameLabelDSAgentWindows'),variables('uniqueString'))]"
          },
          "windowsOSVersion": {
            "value": "[variables('windowsOSVersion')]"
          },
          "windowsvmcount": {
            "value": "[parameters('windowsvmcount')]"
          },
          "vmNameDSAgent": {
            "value": "[variables('vmNameDSAgent')]"
          },
          "vmSizeDSAgent": {
            "value": "[variables('vmSizeDSAgent')]"
          },
          "adminUsernameDSAgent": {
            "value": "[parameters('adminUsernameDSAgent')]"
          },
          "adminPasswordDSAgent": {
            "value": "[parameters('adminPasswordDSAgent')]"
          },
          "publicIPDomainNameLabelDSAgent": {
            "value": "[concat(parameters('publicIPDomainNameLabelDSAgent'),variables('uniqueString'))]"
          },
          "ubuntuOSVersion": {
            "value": "[variables('ubuntuOSVersion')]"
          },
          "linuxvmcount": {
            "value": "[parameters('linuxvmcount')]"
          },
          "ManagerAddress": {
            "value": "[variables('ManagerAddress')]"
          },
          "subnet4Ref": {
            "value": "[variables('subnet4Ref')]"
          },
          "imagePublisherWindows": {
            "value": "[variables('imagePublisherWindows')]"
          },
          "imageOfferWindows": {
            "value": "[variables('imageOfferWindows')]"
          },
          "imagePublisherLinux": {
            "value": "[variables('imagePublisherLinux')]"
          },
          "imageOfferLinux": {
            "value": "[variables('imageOfferLinux')]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "ActivationPort": {
            "value": "[parameters('heartbeatPortTrendDSM')]"
          },
          "TenantIdentifier": {
            "value": "[variables('TenantIdentifier')]"
          },
          "TenantActivationPassword": {
            "value": "[variables('TenantActivationPassword')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "chefprefix": {
            "value": "[variables('chefprefix')]"
          },
          "keyName": {
            "value": "[variables('keyName')]"
          },
          "kmServerUrl": {
            "value": "[variables('kmServerUrl')]"
          },
          "chef_node_name": {
            "value": "[variables('chef_node_name')]"
          },
          "chef_server_url": {
            "value": "[variables('chef_server_url')]"
          },
          "validation_client_name": {
            "value": "[variables('validation_client_name')]"
          },
          "validation_key_format": {
            "value": "[variables('validation_key_format')]"
          },
          "runlist": {
            "value": "[variables('runlist')]"
          },
          "resourcegroupName": {
            "value": "[variables('resourcegroupName')]"
          },
          "chefnodeCustomScripturl": {
            "value": "[variables('chefnodeCustomScripturl')]"
          },
          "baseUrl": {
            "value": "[parameters('_artifactsLocation')]"

          },
          "datameerTags": {
            "value": "[variables('datameerTags')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
        }
    },
    {
      "apiVersion": "[variables('deployment-api-version2')]",
      "type": "Microsoft.Resources/deployments",
      "name": "datameerhdinsight",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('datameerHDInsightCluster').standaloneTemplateUrl]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "clusterName": {
            "value": "[variables('datameerHDInsightCluster').clusterName]"
          },
          "clusterType": {
            "value": "[variables('datameerHDInsightCluster').clusterType]"
          }, 
          "clusterLoginUserName": {
            "value": "[variables('datameerHDInsightCluster').clusterLoginUserName]"
          }, 
          "clusterLoginPassword": {
            "value": "[variables('datameerHDInsightCluster').clusterLoginPassword]"
          }, 
          "sshUserName": {
            "value": "[variables('datameerHDInsightCluster').sshUserName]"
          }, 
          "sshPassword": {
            "value": "[variables('datameerHDInsightCluster').sshPassword]"
          }, 
          "storageAccount": {
            "value": "[variables('datameerHDInsightCluster').storageAccount]"
          },
          "clusterVNetName" :{
            "value": "[variables('virtualNetworkName')]"
          },
          "clusterVnetAddressSpace": {
            "value": "[variables('vnetAddressPrefix')]"
          },
          "clusterVNetSubnetAddressRange": {
            "value": "[variables('subnet3Prefix')]"
          },
          "clusterVNetSubnetName": {
            "value": "[variables('subnet3Name')]"
          },
          "datameerTags": {
            "value": "[variables('datameerTags')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    }    
  ],
  "outputs": {
    "TrendMicro DSM URI": {
      "type": "string",
      "value": "[reference('trendmicrodsm').outputs.trendmicrodsmUri.value]"
    },
    "Chef Server URI": {
      "type": "string",
      "value": "[reference('chefserver').outputs.chefserverUri.value]"
    },
    "Datameer App URI": {
      "type": "string",
      "value": "[reference('datameerhdinsight').outputs.datameerAppURL.value]"
    }
  }
}
