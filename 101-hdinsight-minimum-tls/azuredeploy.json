{
    "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{
       "clusterName":{
          "type":"string",
          "defaultValue":"[concat('hdi-', uniqueString(resourceGroup().id))]",
          "metadata":{
             "description":"The name of the cluster to create."
          }
       },
       "clusterVersion":{
          "type":"string",
          "defaultValue":"4.0",
          "metadata":{
             "description":"The HDInsight version to deploy."
          }
       },
       "headNodeSize":{
          "type":"string",
          "defaultValue":"Standard_D12_v2",
          "metadata":{
             "description":"The VM size of the head nodes."
          }
       },
       "workerNodeSize":{
          "type":"string",
          "defaultValue":"Standard_D13_v2",
          "metadata":{
             "description":"The VM size of the worker nodes."
          }
       },
       "workerNodeCount":{
          "type":"int",
          "defaultValue":4,
          "metadata":{
             "description":"The number of worker nodes in the cluster."
          }
       },
       "clusterLoginUserName":{
          "type":"string",
          "metadata":{
             "description":"These credentials can be used to submit jobs to the cluster and to log into cluster dashboards."
          }
       },
       "clusterLoginPassword":{
          "type":"securestring",
          "metadata":{
             "description":"The password must be at least 10 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
          }
       },
       "sshUserName":{
          "type":"string",
          "metadata":{
             "description":"These credentials can be used to remotely access the cluster."
          }
       },
       "sshPassword":{
          "type":"securestring",
          "metadata":{
             "description":"The password must be at least 10 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
          }
       },
       "existingClusterStorageResourceGroup":{
          "type":"string",
          "defaultValue":"[resourceGroup().name]",
          "metadata":{
             "description":"The resource group name of the storage account to use as the cluster's default storage."
          }
       },
       "existingClusterStorageAccountName":{
          "type":"string",
          "metadata":{
             "description":"The name of the storage account to use as the cluster's default storage."
          }
       },
       "newOrExistingClusterStorageContainerName":{
          "type":"string",
          "metadata":{
             "description":"The name of the storage container to use."
          }
       },
       "existingVirtualNetworkResourceGroup":{
          "type":"string",
          "defaultValue":"[resourceGroup().name]",
          "metadata":{
             "description":"The existing virtual network resource group name."
          }
       },
       "existingVirtualNetworkName":{
          "type":"string",
          "metadata":{
             "description":"The existing virtual network name."
          }
       },
       "existingVirtualNetworkSubnetName":{
          "type":"string",
          "metadata":{
             "description":"The existing virtual network subnet name."
          }
       },
       "location":{
          "type":"string",
          "defaultValue":"[resourceGroup().location]",
          "metadata":{
             "description":"Location for all resources."
          }
       }
    },
    "resources":[
       {
          "apiVersion":"2019-05-01",
          "name":"[variables('nestedtemplate_name')]",
          "type":"Microsoft.Resources/deployments",
          "resourceGroup":"[parameters('existingSQLServerResourceGroup')]",
          "properties":{
             "mode":"Incremental",
             "template":{
                "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion":"1.0.0.0",
                "resources":[
                   {
                      "type":"Microsoft.Sql/servers/databases",
                      "apiVersion":"2018-06-01-preview",
                      "location":"[parameters('location')]",
                      "name":"[variables('sqldbname')]",
                      "properties":{
                         "collation":"SQL_Latin1_General_CP1_CI_AS",
                         "maxSizeBytes":"268435456000",
                         "zoneRedundant":false,
                         "readScale":"Disabled",
                         "readReplicaCount":0
                      },
                      "sku":{
                         "name":"S2",
                         "tier":"Standard"
                      }
                   }
                ]
             }
          }
       },
       {
          "name":"[parameters('clusterName')]",
          "type":"Microsoft.HDInsight/clusters",
          "location":"[parameters('location')]",
          "apiVersion":"2018-06-01-preview",
          "dependsOn":[
             "[concat('Microsoft.Resources/deployments/', variables('nestedtemplate_name'))]"
          ],
          "properties":{
             "clusterVersion":"[parameters('clusterVersion')]",
             "osType":"Linux",
             "clusterDefinition":{
                "kind":"hadoop",
                "configurations":{
                   "gateway":{
                      "restAuthCredential.isEnabled":true,
                      "restAuthCredential.username":"[parameters('clusterLoginUserName')]",
                      "restAuthCredential.password":"[parameters('clusterLoginPassword')]"
                   }
                }
             },
             "storageProfile":{
                "storageaccounts":[
                   {          
                      "name": "[replace(replace(reference(resourceId(parameters('existingClusterStorageResourceGroup'), 'Microsoft.Storage/storageAccounts/', parameters('existingClusterStorageAccountName')), '2018-02-01').primaryEndpoints.blob,'https:',''),'/','')]",                      "isDefault":true,
                      "container":"[parameters('newOrExistingClusterStorageContainerName')]",
                      "key":"[listKeys(resourceId(parameters('existingClusterStorageResourceGroup'), 'Microsoft.Storage/storageAccounts', parameters('existingClusterStorageAccountName')), '2018-02-01').keys[0].value]"
                   }
                ]
             },
             "minSupportedTlsVersion": "1.2",
             "computeProfile":{
                "roles":[
                   {
                      "name":"headnode",
                      "targetInstanceCount":2,
                      "hardwareProfile":{
                         "vmSize":"[parameters('headNodeSize')]"
                      },
                      "osProfile":{
                         "linuxOperatingSystemProfile":{
                            "username":"[parameters('sshUserName')]",
                            "password":"[parameters('sshPassword')]"
                         }
                      },
                      "virtualNetworkProfile":{
                         "id":"[resourceId(parameters('existingVirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks', parameters('existingVirtualNetworkName'))]",
                         "subnet":"[resourceId(parameters('existingVirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('existingVirtualNetworkSubnetName'))]"
                      }
                   },
                   {
                      "name":"workernode",
                      "targetInstanceCount":"[parameters('workerNodeCount')]",
                      "hardwareProfile":{
                         "vmSize":"[parameters('workerNodeSize')]"
                      },
                      "osProfile":{
                         "linuxOperatingSystemProfile":{
                            "username":"[parameters('sshUserName')]",
                            "password":"[parameters('sshPassword')]"
                         }
                      },
                      "virtualNetworkProfile":{
                         "id":"[resourceId(parameters('existingVirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks', parameters('existingVirtualNetworkName'))]",
                         "subnet":"[resourceId(parameters('existingVirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('existingVirtualNetworkSubnetName'))]"
                      }
                   }
                ]
             }
          }
       }
    ],
    "outputs":{
       "cluster":{
          "type":"object",
          "value":"[reference(resourceId('Microsoft.HDInsight/clusters',parameters('clusterName')))]"
       }
    }
 }
 