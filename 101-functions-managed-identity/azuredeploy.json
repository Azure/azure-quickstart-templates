{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "functionAppName": {
          "type": "string",
          "metadata": {
              "description": "Specify the name of the function application"
            }
      },
      "ApplicationInsightsLocation": {
          "type": "string",
          "defaultValue": "West Europe",
          "allowedValues": [
            "East US",
            "South Central US",
            "North Europe",
            "West Europe",
            "Southeast Asia",
            "West US 2",
            "Central India",
            "Canada Central",
            "UK South"
          ],
          "metadata": {
            "description": "Specify the region for Application Insights data"
          }
        },
      "runtimeStack": {
          "type": "string",
          "defaultValue": "powershell",
          "allowedValues": [
              "powershell",
              "dotnet",
              "node",
              "java"
          ],
          "metadata": {
              "description": "Pick the language runtime that you want enabled"
            }
      }
  },
  "variables": {
      "hostingPlanName": "[parameters('functionAppName')]",
      "location": "[resourceGroup().location]",
      "storageAccountName": "[concat('storage', uniquestring(resourceGroup().id))]"
  },
  "resources": [
      {
          "name": "[parameters('functionAppName')]",
          "type": "Microsoft.Web/sites",            
          "dependsOn": [
              "[concat('Microsoft.Web/serverfarms/', variables('hostingPlanName'))]",
              "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
              "[resourceId('microsoft.insights/components/', parameters('functionAppName'))]"
          ],
          "identity": {
              "type": "SystemAssigned"
          },
          "properties": {
              "siteConfig": {
                  "appSettings": [
                      {
                          "name": "FUNCTIONS_WORKER_RUNTIME",
                          "value": "[parameters('runtimeStack')]"
                      },
                      {
                          "name": "AzureWebJobsStorage",
                          "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',variables('storageAccountName'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2015-05-01-preview').key1)]"
                      },
                      {
                          "name": "FUNCTIONS_EXTENSION_VERSION",
                          "value": "~2"
                      },
                      {
                          "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                          "value": "[reference(resourceId('microsoft.insights/components/', parameters('functionAppName')), '2015-05-01').InstrumentationKey]"
                      }
                  ]
              },
              "name": "[parameters('functionAppName')]",
              "clientAffinityEnabled": false,
              "serverFarmId": "[concat('/subscriptions/', subscription().subscriptionId,'/resourcegroups/', resourceGroup().name, '/providers/Microsoft.Web/serverfarms/', variables('hostingPlanName'))]"
          },
          "apiVersion": "2018-02-01",
          "location": "[variables('location')]",
          "kind": "functionapp"
      },
      {
          "type": "Microsoft.Web/serverfarms",
          "apiVersion": "2015-04-01",
          "name": "[variables('hostingPlanName')]",
          "location": "[resourceGroup().location]",
          "properties": {
              "name": "[variables('hostingPlanName')]",
              "computeMode": "Dynamic",
              "sku": "Dynamic"
          }
      },
      {
          "apiVersion": "2015-05-01-preview",
          "type": "Microsoft.Storage/storageAccounts",
          "name": "[variables('storageAccountName')]",
          "location": "[variables('location')]",
          "properties": {
              "accountType": "Standard_LRS"
          }
      },
      {
          "apiVersion": "2015-05-01",
          "name": "[parameters('functionAppName')]",
          "type": "Microsoft.Insights/components",
          "location": "[parameters('ApplicationInsightsLocation')]",
          "tags": {
              "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.Web/sites/', parameters('functionAppName'))]": "Resource"
          },
          "properties": {
              "ApplicationId": "[parameters('functionAppName')]"
          }
      }
  ],
  "outputs": {
      "principalId": {
        "type": "string",
        "value": "[reference(concat(resourceId('Microsoft.Web/sites/', parameters('functionAppName')), '/providers/Microsoft.ManagedIdentity/Identities/default'), '2015-08-31-PREVIEW').principalId]"
      }
  }
}
