{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "domainNamePrefix": {
            "type": "string",
            "metadata": {
                "description": "The public DNS name label for the service.  The pattern will follow: <domainNamePrefix>.<region>.cloudapp.azure.com"
            }
        },
        "resourceLocation": {
            "type": "string",
            "allowedValues": [
                "East US",
                "East US 2",
                "West US",
                "Central US",
                "South Central US",
                "North Central US",
                "North Europe",
                "West Europe",
                "Southeast Asia",
                "East Asia",
                "Japan West",
                "Japan East",
                "Brazil South",
                "Australia East",
                "Australia Southeast"
            ],
            "metadata": {
                "description": "Azure region where all resources will be deployed. This is distinct from resource group location."
            }
        },
        "vmSku": {
            "type": "string",
            "defaultValue": "Standard_A2",
            "metadata": {
                "description": "VM size for the VM Scale Set + the mgmt VM"
            }
        },
        "windowsOSVersion": {
            "type": "string",
            "defaultValue": "2012-R2-Datacenter",
            "metadata": {
                "description": "The Windows Server version for the VM. This will pick a fully patched image of this given Windows version"
            }
        },
        "vmssName": {
            "type": "string",
            "metadata": {
                "description": "String used as a base for naming resources (9 characters or less). A hash is prepended to this string for some resources, and resource-specific information is appended."
            },
            "maxLength": 9
        },
        "instanceCount": {
            "type": "int",
            "defaultValue": 5,
            "metadata": {
                "description": "Number of VM instances (100 or less)."
            },
            "maxValue": 100
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Admin username on all VMs."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Admin password on all VMs."
            }
        },
        "registrationKey": {
            "type": "securestring",
            "metadata": {
                "description": "Registration key to use to onboard to the Azure Automation DSC pull/reporting server"
            }
        },
        "registrationUrl": {
            "type": "string",
            "metadata": {
                "description": "Registration url of the Azure Automation DSC pull/reporting server"
            }
        },
        "nodeConfigurationName": {
            "type": "string",
            "defaultValue": "MyService.webServer",
            "metadata": {
                "description": "The name of the node configuration, on the Azure Automation DSC pull server, that this node will be configured as"
            }
        },
        "configurationMode": {
            "type": "string",
            "defaultValue": "ApplyAndAutoCorrect",
            "allowedValues": [
                "ApplyOnly",
                "ApplyAndMonitor",
                "ApplyAndAutoCorrect"
            ],
            "metadata": {
                "description": "DSC agent (LCM) configuration mode setting. ApplyOnly, ApplyAndMonitor, or ApplyAndAutoCorrect"
            }
        },
        "configurationModeFrequencyMins": {
            "type": "int",
            "defaultValue": 15,
            "metadata": {
                "description": "DSC agent (LCM) configuration mode frequency setting, in minutes"
            }
        },
        "refreshFrequencyMins": {
            "type": "int",
            "defaultValue": 30,
            "metadata": {
                "description": "DSC agent (LCM) refresh frequency setting, in minutes"
            }
        },
        "rebootNodeIfNeeded": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "DSC agent (LCM) rebootNodeIfNeeded setting"
            }
        },
        "actionAfterReboot": {
            "type": "string",
            "defaultValue": "ContinueConfiguration",
            "allowedValues": [
                "ContinueConfiguration",
                "StopConfiguration"
            ],
            "metadata": {
                "description": "DSC agent (LCM) actionAfterReboot setting. ContinueConfiguration or StopConfiguration"
            }
        },
        "allowModuleOverwrite": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "DSC agent (LCM) allowModuleOverwrite setting"
            }
        },
        "timestamp": {
            "type": "string",
            "defaultValue": "MM/dd/yyyy H:mm:ss tt",
            "metadata": {
                "description": "The current datetime, as a string, to force the request to go through ARM even if all fields are the same as last ARM deployment of this template; example in parameters file is in MM/dd/yyyy H:mm:ss tt format"
            }
        },
        "automationAccountName": {
            "type": "string",
            "defaultValue": "myAutomationAccount",
            "metadata": {
                "description": "The name of the Automation account to use.  Check the SKU and tags to make sure they match the existing account."
            }
        },
        "automationRegionId": {
            "type": "string",
            "defaultValue": "East US 2",
            "allowedValues": [
                "Japan East",
                "East US 2",
                "West Europe",
                "Southeast Asia",
                "South Central US",
                "Central India"
            ],
            "metadata": {
                "description": "The region the Automation account is located in."
            }
        },
        "configurationName": {
            "type": "string",
            "defaultValue": "MyService",
            "metadata": {
                "description": "The name of the DSC Configuration. The name must match the name in the URI."
            }
        },
        "configurationURI": {
            "type": "string",
            "defaultValue": "https://raw.github.com/Azure/azure-quickstart-templates/master/201-vmss-automation-dsc/webServer.ps1",
            "metadata": {
                "description": "The URI for the DSC configuration "
            }
        },
        "configurationDescription": {
            "type": "string",
            "defaultValue": "Web Server",
            "metadata": {
                "description": "The description of the configuration."
            }
        },
        "jobid": {
            "type": "string",
            "metadata": {
                "description": "The job id to compile the configuration"
            }
        }
    },
    "variables": {
        "computeApi": "2016-03-30",
        "networkApi": "2016-03-30",
        "storageApi": "2015-06-15",
        "insightsApi": "2015-04-01",
        "automationApiVersion": "2015-10-31",
        "storageAccountType": "Standard_LRS",
        "saCount": 5,
        "namingInfix": "[toLower(parameters('vmssName'))]",
        "newStorageAccountSuffix": "[concat(variables('namingInfix'), 'sa')]",
        "uniqueStringArray": [
            "[concat(uniqueString(concat(resourceGroup().id, deployment().name, variables('newStorageAccountSuffix'), '0')))]",
            "[concat(uniqueString(concat(resourceGroup().id, deployment().name, variables('newStorageAccountSuffix'), '1')))]",
            "[concat(uniqueString(concat(resourceGroup().id, deployment().name, variables('newStorageAccountSuffix'), '2')))]",
            "[concat(uniqueString(concat(resourceGroup().id, deployment().name, variables('newStorageAccountSuffix'), '3')))]",
            "[concat(uniqueString(concat(resourceGroup().id, deployment().name, variables('newStorageAccountSuffix'), '4')))]"
        ],
        "vhdContainerName": "[concat(variables('namingInfix'), 'vhd')]",
        "osDiskName": "[concat(variables('namingInfix'), 'osdisk')]",
        "virtualNetworkName": "[concat(variables('namingInfix'), 'vnet')]",
        "virtualNetworkID": "[resourceId('Microsoft.Network/virtualNetworks/',variables('virtualNetworkName'))]",
        "addressPrefix": "192.168.0.0/16",
        "subnetName": "[concat(variables('namingInfix'), 'subnet')]",
        "subnetID": "[concat(variables('virtualNetworkID'),'/subnets/',variables('subnetName'))]",
        "subnetPrefix": "192.168.0.0/24",
        "publicIPAddressName": "[concat(variables('namingInfix'), 'pip')]",
        "publicIPAddressID": "[resourceId('Microsoft.Network/publicIPAddresses/',variables('publicIPAddressName'))]",
        "loadBalancerName": "[concat(variables('namingInfix'), 'loadBalancer')]",
        "loadBalancerID": "[resourceId('Microsoft.Network/loadBalancers/',variables('loadBalancerName'))]",
        "frontendIPConfigurationsName": "[concat(variables('loadBalancerName'), 'frontendIPConfigurations')]",
        "frontEndIPConfigurationsID": "[concat(variables('loadBalancerID'),'/frontendIPConfigurations/',variables('frontendIPConfigurationsName'))]",
        "loadBalancingRulesName": "[concat(variables('loadBalancerName'), 'loadBalancingRules')]",
        "backendAddressPoolsName":"[concat(variables('loadBalancerName'), 'backendAddressPools')]",
        "backendAddressPoolID": "[concat(variables('loadBalancerID'),'/backendAddressPools/',variables('backendAddressPoolsName'))]",
        "httpProbeName": "[concat(variables('loadBalancerName'),'httpProbe')]",
        "httpProbeID": "[concat(variables('loadBalancerID'),'/probes/',variables('httpProbeName'))]",
        "httpProbeRequestPath": "/iisstart.htm",
        "natRDPPoolName": "[concat(variables('loadBalancerName'), 'natRDP')]",
        "natRDPPoolID": "[concat(variables('loadBalancerID'),'/inboundNatPools/',variables('natRDPPoolName'))]",
        "natRDPStartPort":50000,
        "natRDPEndPort":50119,
        "natRDPBackendPort":3389,
        "natWinRMPoolName": "[concat(variables('loadBalancerName'), 'natWinRM')]",
        "natWinRMPoolID": "[concat(variables('loadBalancerID'),'/inboundNatPools/',variables('natWinRMPoolName'))]",
        "natWinRMStartPort":51000,
        "natWinRMEndPort":51119,
        "natWinRMBackendPort":5896,
        "nicName": "[concat(variables('namingInfix'), 'nic')]",
        "ipConfigName": "[concat(variables('namingInfix'), 'ipconfig')]",
        "osType": {
            "publisher": "MicrosoftWindowsServer",
            "offer": "WindowsServer",
            "sku": "[parameters('windowsOSVersion')]",
            "version": "latest"
        },
        "imageReference": "[variables('osType')]",
        "automationPricingTier": "Free",
        "dscOverwrite": "true",
        "dscModules": {
            "xNetworking": {
                "moduleName": "xNetworking",
                "moduleUri": "https://raw.github.com/Azure/azure-quickstart-templates/master/201-vmss-automation-dsc/xNetworking.zip"
            }
        },
        "autoScaleWAD": "[concat(variables('namingInfix'), 'autoScale')]",
        "autoscaleProcProfile": "[concat(variables('namingInfix'), 'autoScaleProcProfile')]",
        "diagnosticsStorageAccountName": "[concat(variables('uniqueStringArray')[0], 'diagsa')]",
		"diagnosticsStorageAccountResourceGroup": "[resourceGroup().name]",
		"accountid": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',variables('diagnosticsStorageAccountResourceGroup'),'/providers/','Microsoft.Storage/storageAccounts/', variables('diagnosticsStorageAccountName'))]",
		"wadlogs": "<WadCfg> <DiagnosticMonitorConfiguration overallQuotaInMB=\"4096\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\"> <DiagnosticInfrastructureLogs scheduledTransferLogLevelFilter=\"Error\"/> <WindowsEventLog scheduledTransferPeriod=\"PT1M\" > <DataSource name=\"Application!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"Security!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"System!*[System[(Level = 1 or Level = 2)]]\" /></WindowsEventLog>",
		"wadperfcounters1": "<PerformanceCounters scheduledTransferPeriod=\"PT1M\"><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Processor Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU utilization\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Privileged Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU privileged time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% User Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU user time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor Information(_Total)\\Processor Frequency\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"CPU frequency\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\System\\Processes\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Processes\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Thread Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Threads\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Handle Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Handles\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\% Committed Bytes In Use\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Memory usage\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Available Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory available\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Committed Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory committed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Commit Limit\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory commit limit\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active time\" locale=\"en-us\"/></PerformanceCounterConfiguration>",
		"wadperfcounters2": "<PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Read Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active read time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Write Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active write time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Transfers/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Reads/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk read operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Writes/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk write operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Read Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk read speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Write Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk write speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\LogicalDisk(_Total)\\% Free Space\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk free space (percentage)\" locale=\"en-us\"/></PerformanceCounterConfiguration></PerformanceCounters>",
		"wadcfgxstart": "[concat(variables('wadlogs'),variables('wadperfcounters1'),variables('wadperfcounters2'),'<Metrics resourceId=\"')]",
		"wadmetricsresourceid": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name ,'/providers/','Microsoft.Compute/virtualMachineScaleSets/',parameters('vmssName'))]",
		"wadcfgxend": "[concat('\"><MetricAggregation scheduledTransferPeriod=\"PT1H\"/><MetricAggregation scheduledTransferPeriod=\"PT1M\"/></Metrics></DiagnosticMonitorConfiguration></WadCfg>')]"
    },
    "resources": [
        {
            "type": "Microsoft.Automation/automationAccounts",
            "name": "[parameters('automationAccountName')]",
            "apiVersion": "[variables('automationApiVersion')]",
            "location": "[parameters('automationRegionId')]",
            "dependsOn": [],
            "tags": {},
            "properties": {
                "sku": {
                    "name": "[variables('automationPricingTier')]"
                }
            },
            "resources": [
                {
                    "name": "[concat(parameters('automationAccountName'), '/', variables('dscModules').xNetworking.ModuleName)]",
                    "type": "microsoft.automation/automationAccounts/Modules",
                    "apiVersion": "[variables('automationApiVersion')]",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('dscModules').xNetworking.ModuleUri]"
                        }
                    }
                },
                {
                    "name": "[parameters('configurationName')]",
                    "type": "Configurations",
                    "apiVersion": "[variables('automationApiVersion')]",
                    "location": "[parameters('automationRegionId')]",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]"
                    ],
                    "properties": {
                        "logVerbose": "false",
                        "description": "[parameters('configurationDescription')]",
                        "state": "Published",
                        "overwrite": "[variables('dscOverwrite')]",
                        "Source": {
                            "type": "uri",
                            "Value": "[parameters('configurationURI')]"
                        }
                    }
                },
                {
                    "name": "[parameters('jobid')]",
                    "type": "Compilationjobs",
                    "apiVersion": "[variables('automationApiVersion')]",
                    "location": "parameters('automationRegionId')]",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'),'/Modules/',variables('dscModules').xNetworking.ModuleName)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'),'/Configurations/', parameters('configurationName'))]"
                    ],
                    "properties": {
                        "configuration": {
                            "name": "[parameters('configurationName')]"
                        }
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[concat(variables('uniqueStringArray')[copyIndex()], variables('newStorageAccountSuffix'))]",
            "location": "[parameters('resourceLocation')]",
            "apiVersion": "[variables('storageApi')]",
            "copy": {
                "name": "storageLoop",
                "count": "[variables('saCount')]"
            },
            "properties": {
                "accountType": "[variables('storageAccountType')]"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('diagnosticsStorageAccountName')]",
            "location": "[parameters('resourceLocation')]",
            "apiVersion": "[variables('storageApi')]",
            "properties": {
                "accountType": "[variables('storageAccountType')]"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "name": "[variables('virtualNetworkName')]",
            "location": "[parameters('resourceLocation')]",
            "apiVersion": "[variables('networkApi')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('addressPrefix')]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('subnetName')]",
                        "properties": {
                            "addressPrefix": "[variables('subnetPrefix')]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('publicIPAddressName')]",
            "location": "[parameters('resourceLocation')]",
            "apiVersion": "[variables('networkApi')]",
            "properties": {
                "publicIPAllocationMethod": "Dynamic",
                "dnsSettings": {
                    "domainNameLabel": "[parameters('domainNamePrefix')]"
                }
            }
        },
        {
            "type": "Microsoft.Network/loadBalancers",
            "name": "[variables('loadBalancerName')]",
            "location": "[parameters('resourceLocation')]",
            "apiVersion": "[variables('networkApi')]",
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
            ],
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "[variables('frontendIPConfigurationsName')]",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[variables('publicIPAddressID')]"
                            }
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "[variables('backendAddressPoolsName')]"
                    }
                ],
                "loadBalancingRules": [
                    {
                        "name": "[variables('loadBalancingRulesName')]",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('frontEndIPConfigurationsID')]"
                            },
                            "backendAddressPool": {
                                "id": "[variables('backendAddressPoolID')]"
                            },
                            "protocol": "tcp",
                            "frontendPort": 80,
                            "backendPort": 80,
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 5,
                            "probe": {
                                "id": "[variables('httpProbeID')]"
                            }
                        }
                    }
                ],
                "probes": [
                    {
                        "name": "[variables('httpProbeName')]",
                        "properties": {
                            "protocol": "http",
                            "port": 80,
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2,
                            "requestPath": "[variables('httpProbeRequestPath')]"
                        }
                    }
                ],
                "inboundNatPools": [
                    {
                        "name": "[variables('natRDPPoolName')]",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('frontEndIPConfigurationsID')]"
                            },
                            "protocol": "tcp",
                            "frontendPortRangeStart": "[variables('natRDPStartPort')]",
                            "frontendPortRangeEnd": "[variables('natRDPEndPort')]",
                            "backendPort": "[variables('natRDPBackendPort')]"
                        }
                    },
                    {
                        "name": "[variables('natWinRMPoolName')]",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('frontEndIPConfigurationsID')]"
                            },
                            "protocol": "tcp",
                            "frontendPortRangeStart": "[variables('natWinRMStartPort')]",
                            "frontendPortRangeEnd": "[variables('natWinRMEndPort')]",
                            "backendPort": "[variables('natWinRMBackendPort')]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "name": "[variables('namingInfix')]",
            "location": "[parameters('resourceLocation')]",
            "apiVersion": "[variables('computeApi')]",
            "dependsOn": [
                "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]",
                "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'),'/Modules/',variables('dscModules').xNetworking.ModuleName)]",
                "[concat('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'),'/Configurations/', parameters('configurationName'))]",
                "storageLoop",
                "[concat('Microsoft.Storage/storageAccounts/', variables('diagnosticsStorageAccountName'))]",
                "[concat('Microsoft.Network/loadBalancers/', variables('loadBalancerName'))]",
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]"
            ],
            "sku": {
                "name": "[parameters('vmSku')]",
                "tier": "Standard",
                "capacity": "[parameters('instanceCount')]"
            },
            "properties": {
	            "overprovision": "true", 
                "upgradePolicy": {
                    "mode": "Manual"
                },
                "virtualMachineProfile": {
                    "storageProfile": {
                        "osDisk": {
                            "vhdContainers": [
                                "[concat('https://', variables('uniqueStringArray')[0], variables('newStorageAccountSuffix'), '.blob.core.windows.net/', variables('vhdContainerName'))]",
                                "[concat('https://', variables('uniqueStringArray')[1], variables('newStorageAccountSuffix'), '.blob.core.windows.net/', variables('vhdContainerName'))]",
                                "[concat('https://', variables('uniqueStringArray')[2], variables('newStorageAccountSuffix'), '.blob.core.windows.net/', variables('vhdContainerName'))]",
                                "[concat('https://', variables('uniqueStringArray')[3], variables('newStorageAccountSuffix'), '.blob.core.windows.net/', variables('vhdContainerName'))]",
                                "[concat('https://', variables('uniqueStringArray')[4], variables('newStorageAccountSuffix'), '.blob.core.windows.net/', variables('vhdContainerName'))]"
                            ],
                            "name": "[variables('osDiskName')]",
                            "caching": "ReadOnly",
                            "createOption": "FromImage"
                        },
                        "imageReference": "[variables('imageReference')]"
                    },
                    "extensionProfile": {
                        "extensions": [
                            {
                                "name": "Microsoft.Powershell.DSC",
                                "properties": {
                                    "publisher": "Microsoft.Powershell",
                                    "type": "DSC",
                                    "typeHandlerVersion": "2.15",
				    "autoUpgradeMinorVersion": true,
                                    "protectedSettings": {
                                        "Items": {
                                            "registrationKeyPrivate": "[parameters('registrationKey')]"
                                        }
                                    },
                                    "settings": {
                                        "ModulesUrl": "https://raw.github.com/Azure/azure-quickstart-templates/master/201-vmss-automation-dsc/UpdateLCMforAAPull.zip",
                                        "SasToken": "",
                                        "ConfigurationFunction": "UpdateLCMforAAPull.ps1\\ConfigureLCMforAAPull",
                                        "Properties": [
                                            {
                                                "Name": "RegistrationKey",
                                                "Value": {
                                                    "UserName": "PLACEHOLDER_DONOTUSE",
                                                    "Password": "PrivateSettingsRef:registrationKeyPrivate"
                                                },
                                                "TypeName": "System.Management.Automation.PSCredential"
                                            },
                                            {
                                                "Name": "RegistrationUrl",
                                                "Value": "[parameters('registrationUrl')]",
                                                "TypeName": "System.String"
                                            },
                                            {
                                                "Name": "NodeConfigurationName",
                                                "Value": "[parameters('nodeConfigurationName')]",
                                                "TypeName": "System.String"
                                            },
                                            {
                                                "Name": "ConfigurationMode",
                                                "Value": "[parameters('configurationMode')]",
                                                "TypeName": "System.String"
                                            },
                                            {
                                                "Name": "ConfigurationModeFrequencyMins",
                                                "Value": "[parameters('configurationModeFrequencyMins')]",
                                                "TypeName": "System.Int32"
                                            },
                                            {
                                                "Name": "RefreshFrequencyMins",
                                                "Value": "[parameters('refreshFrequencyMins')]",
                                                "TypeName": "System.Int32"
                                            },
                                            {
                                                "Name": "RebootNodeIfNeeded",
                                                "Value": "[parameters('rebootNodeIfNeeded')]",
                                                "TypeName": "System.Boolean"
                                            },
                                            {
                                                "Name": "ActionAfterReboot",
                                                "Value": "[parameters('actionAfterReboot')]",
                                                "TypeName": "System.String"
                                            },
                                            {
                                                "Name": "AllowModuleOverwrite",
                                                "Value": "[parameters('allowModuleOverwrite')]",
                                                "TypeName": "System.Boolean"
                                            },
                                            {
                                                "Name": "Timestamp",
                                                "Value": "[parameters('timestamp')]",
                                                "TypeName": "System.String"
                                            }
                                        ]
                                    }
                                }
                            },
                            {
								"name": "Microsoft.Insights.VMDiagnosticsSettings",
								"properties": {
									"publisher": "Microsoft.Azure.Diagnostics",
									"type": "IaaSDiagnostics",
                                    "typeHandlerVersion": "1.5",
									"autoUpgradeMinorVersion": true,
									"settings": {
										"xmlCfg": "[base64(concat(variables('wadcfgxstart'),variables('wadmetricsresourceid'),variables('wadcfgxend')))]",
										"storageAccount": "[variables('diagnosticsStorageAccountName')]"
									},
									"protectedSettings": {
										"storageAccountName": "[variables('diagnosticsStorageAccountName')]",
										"storageAccountKey": "[listkeys(variables('accountid'), '2015-06-15').key1]",
										"storageAccountEndPoint": "https://core.windows.net"
									}
								}
							}
                        ]
                    },
                    "osProfile": {
                        "computerNamePrefix": "[variables('namingInfix')]",
                        "adminUsername": "[parameters('adminUsername')]",
                        "adminPassword": "[parameters('adminPassword')]"
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [
                            {
                                "name": "[variables('nicName')]",
                                "properties": {
                                    "primary": "true",
                                    "ipConfigurations": [
                                        {
                                            "name": "[variables('ipConfigName')]",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[variables('subnetID')]"
                                                },
                                                "loadBalancerBackendAddressPools": [
                                                    {
                                                        "id": "[variables('backendAddressPoolID')]"
                                                    }
                                                ],
                                                "loadBalancerInboundNatPools": [
                                                    {
                                                        "id": "[variables('natRDPPoolID')]"
                                                    },
                                                    {
                                                        "id": "[variables('natWinRMPoolID')]"
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            }
        },
        {
            "type": "Microsoft.Insights/autoscaleSettings",
            "apiVersion": "[variables('insightsApi')]",
            "name": "[variables('autoscalewad')]",
            "location":"[parameters('resourceLocation')]",
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachineScaleSets/', parameters('vmssName'))]"
            ],
            "properties": {
                "name": "[variables('autoscalewad')]",
                "targetResourceUri": "[concat('/subscriptions/',subscription().subscriptionId, '/resourceGroups/',  resourceGroup().name, '/providers/Microsoft.Compute/virtualMachineScaleSets/', parameters('vmssName'))]",
                "enabled": true,
                "profiles": [
                {
                    "name": "[variables('autoscaleProcProfile')]",
                    "capacity": {
                    "minimum": "2",
                    "maximum": "25",
                    "default": "2"
                    },
                    "rules": [
                    {
                        "metricTrigger":{
                                   "metricName":"\\Processor(_Total)\\% Processor Time",
                                   "metricNamespace":"",
                                   "metricResourceUri": "[concat('/subscriptions/',subscription().subscriptionId, '/resourceGroups/',  resourceGroup().name, '/providers/Microsoft.Compute/virtualMachineScaleSets/', variables('namingInfix'))]",
                                   "timeGrain":"PT1M",
                                   "statistic":"Average",
                                   "timeWindow":"PT5M",
                                   "timeAggregation":"Average",
                                   "operator":"GreaterThan",
                                   "threshold":50.0
                               },

                        "scaleAction": {
                        "direction": "Increase",
                        "type": "ChangeCount",
                        "value": "1",
                        "cooldown": "PT1M"
                        }
                    },
                    {
                        "metricTrigger":{
                                   "metricName":"\\Processor(_Total)\\% Processor Time",
                                   "metricNamespace":"",
                                   "metricResourceUri": "[concat('/subscriptions/',subscription().subscriptionId, '/resourceGroups/',  resourceGroup().name, '/providers/Microsoft.Compute/virtualMachineScaleSets/', variables('namingInfix'))]",
                                   "timeGrain":"PT1M",
                                   "statistic":"Average",
                                   "timeWindow":"PT5M",
                                   "timeAggregation":"Average",
                                   "operator":"LessThan",
                                   "threshold":50.0
                               },

                        "scaleAction": {
                        "direction": "Decrease",
                        "type": "ChangeCount",
                        "value": "1",
                        "cooldown": "PT1M"
                        }
                    }
                    ]
                }
                ]
            }
        }
    ],
    "outputs": {
		"fqdn": {
			"value": "[reference(variables('publicIPAddressID'),providers('Microsoft.Network','publicIPAddresses').apiVersions[0]).dnsSettings.fqdn]",
			"type": "string"
		},
		"ipaddress": {
			"value": "[reference(variables('publicIPAddressID'),providers('Microsoft.Network','publicIPAddresses').apiVersions[0]).ipAddress]",
			"type": "string"
		}
	}
}
