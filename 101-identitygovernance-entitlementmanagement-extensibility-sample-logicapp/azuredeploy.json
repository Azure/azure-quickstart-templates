{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"name": {
			"type": "String",
			"metadata": {
				"Description": "Name of the Logicapp"
			}
		},
		"location": {
			"type": "String",
			"defaultValue": "[resourceGroup().location]",
			"metadata": {
				"Description": "Deployment location"
			}
		},
		"catalogId": {
			"type": "String",
			"metadata": {
				"Description": "Catalog Id from ELM"
			}
		}
	},
	"variables": {
		"catalogIdExpression": "@{triggerBody()?['CatalogId']}"
	},
	"resources": [
		{
			"type": "Microsoft.Logic/workflows",
			"apiVersion": "2019-05-01",
			"name": "[parameters('name')]",
			"location": "[parameters('location')]",
			"properties": {
				"state": "Enabled",
				"definition": {
					"$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {},
					"triggers": {
						"manual": {
							"type": "Request",
							"kind": "Http",
							"inputs": {
								"schema": {
									"properties": {
										"AccessPackageId": {
											"type": "string"
										},
										"AccessPackageName": {
											"type": "string"
										},
										"AccessPackagePolicyName": {
											"type": "string"
										},
										"CatalogId": {
											"type": "string"
										},
										"CatalogName": {
											"type": "string"
										},
										"ConnectedOrganizationName": {
											"type": "string"
										},
										"Event": {
											"type": "string"
										},
										"GrantRequestCreatedDateTime": {
											"type": "string"
										},
										"Roles": {
											"items": {
												"properties": {
													"Id": {
														"type": "string"
													},
													"Name": {
														"type": "string"
													},
													"ResourceId": {
														"type": "string"
													},
													"ResourceName": {
														"type": "string"
													}
												},
												"required": [
													"Id",
													"Name",
													"ResourceId",
													"ResourceName"
												],
												"type": "object"
											},
											"type": "array"
										},
										"UserEmail": {
											"type": "string"
										},
										"UserId": {
											"type": "string"
										},
										"UserName": {
											"type": "string"
										}
									},
									"type": "object"
								}
							},
							"operationOptions": "IncludeAuthorizationHeadersInOutputs"
						}
					},
					"actions": {
						"Condition": {
							"else": {
								"actions": {
									"Response": {
										"inputs": {
											"body": "[concat('CatalogId mismatch, expected CatalogId:  ',  parameters('catalogId'), ' Provided CatalogId: ', variables('catalogIdExpression'))]",
											"statusCode": 400
										},
										"kind": "http",
										"type": "Response"
									}
								}
							},
							"expression": {
								"and": [
									{
										"equals": [
											"[variables('catalogIdExpression')]",
											"[parameters('catalogId')]"
										]
									}
								]
							},
							"type": "If"
						}
					},
					"outputs": {}
				},
				"parameters": {},
				"accessControl": {
					"triggers": {
						"openAuthenticationPolicies": {
							"policies": {
								"ELMAuthPolicy": {
									"type": "AAD",
									"claims": [
										{
											"name": "iss",
											"value": "[concat('https://sts.windows.net/', subscription().tenantId, '/')]"
										},
										{
											"name": "aud",
											"value": "[environment().authentication.audiences[0]]"
										},
										{
											"name": "appid",
											"value": "810dcf14-1858-4bf2-8134-4c369fa3235b"
										}
									]
								}
							}
						}
					}
				}
			}
		}
	]
}
