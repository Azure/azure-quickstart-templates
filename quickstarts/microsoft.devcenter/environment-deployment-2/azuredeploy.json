{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "devcenterIdentityPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "The principal/object ID of the existing Dev Center identity"
      }
    },
    "projectEnvironmentTypeName": {
      "type": "string",
      "metadata": {
        "description": "The name of environment type for the Project. Should be the same as the existing Dev Center environment type"
      }
    },
    "resourceLocation": {
      "type": "string",
      "metadata": {
        "description": "Location of the previously deployed resources"
      }
    },
    "guidSeed": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "GUID seed to generate unique name"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[parameters('guidSeed')]",
      "location": "[parameters('resourceLocation')]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [
            {
              "type": "Microsoft.DevCenter/projects/environmentTypes",
              "apiVersion": "2023-04-01",
              "name": "[parameters('projectEnvironmentTypeName')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "status": "Enabled",
                "deploymentTargetId": "[subscription().id]",
                "creatorRoleAssignment": {
                  "roles": {
                    "8e3af657-a8ff-443c-a75c-2fe8c4bcb635": "[createObject()]"
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid('User Access Administrator', parameters('guidSeed'))]",
      "properties": {
        "description": "Lets you manage user access to Azure resources.",
        "principalId": "[parameters('devcenterIdentityPrincipalId')]",
        "principalType": "ServicePrincipal",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid('Contributor', parameters('guidSeed'))]",
      "properties": {
        "description": "Grants full access to manage all resources, but does not allow you to assign roles in Azure RBAC, manage assignments in Azure Blueprints, or share image galleries.",
        "principalId": "[parameters('devcenterIdentityPrincipalId')]",
        "principalType": "ServicePrincipal",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
      }
    }
  ]
}
