{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "dev",
      "templateHash": "5336278593853148904"
    }
  },
  "parameters": {
    "artifactsLocation": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/ARM-wvd-templates/DSC/Configuration.zip",
      "metadata": {
        "description": "The base URI where artifacts required by this template are located."
      }
    },
    "hostpoolName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Hostpool to be created."
      }
    },
    "hostpoolFriendlyName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The friendly name of the Hostpool to be created."
      }
    },
    "hostpoolDescription": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The description of the Hostpool to be created."
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location where the resources will be deployed."
      }
    },
    "workSpaceName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of the workspace to be attach to new Applicaiton Group."
      }
    },
    "workspaceLocation": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The location of the workspace."
      }
    },
    "workspaceResourceGroup": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The workspace resource group Name."
      }
    },
    "allApplicationGroupReferences": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The existing app groups references of the workspace selected."
      }
    },
    "addToWorkspace": {
      "type": "bool",
      "metadata": {
        "description": "Whether to add applicationGroup to workspace."
      }
    },
    "administratorAccountUsername": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "A username in the domain that has privileges to join the session hosts to the domain. For example, 'vmjoiner@contoso.com'."
      }
    },
    "administratorAccountPassword": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "The password that corresponds to the existing domain username."
      }
    },
    "vmAdministratorAccountUsername": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "A username to be used as the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
      }
    },
    "vmAdministratorAccountPassword": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "The password associated with the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
      }
    },
    "availabilityOption": {
      "type": "string",
      "defaultValue": "None",
      "metadata": {
        "description": "Select the availability options for the VMs."
      },
      "allowedValues": [
        "None",
        "AvailabilitySet",
        "AvailabilityZone"
      ]
    },
    "availabilitySetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of avaiability set to be used when create the VMs."
      }
    },
    "createAvailabilitySet": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to create a new availability set for the VMs."
      }
    },
    "availabilitySetUpdateDomainCount": {
      "type": "int",
      "defaultValue": 5,
      "metadata": {
        "description": "The platform update domain count of avaiability set to be created."
      },
      "allowedValues": [
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10,
        11,
        12,
        13,
        14,
        15,
        16,
        17,
        18,
        19,
        20
      ]
    },
    "availabilitySetFaultDomainCount": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "The platform fault domain count of avaiability set to be created."
      },
      "allowedValues": [
        1,
        2,
        3
      ]
    },
    "availabilityZone": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "The number of availability zone to be used when create the VMs."
      },
      "allowedValues": [
        1,
        2,
        3
      ]
    },
    "vmResourceGroup": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The resource group of the session host VMs."
      }
    },
    "vmLocation": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The location of the session host VMs."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The size of the session host VMs."
      }
    },
    "vmNumberOfInstances": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "Number of session hosts that will be created and added to the hostpool."
      }
    },
    "vmNamePrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "This prefix will be used in combination with the VM number to create the VM name. If using 'rdsh' as the prefix, VMs would be named 'rdsh-0', 'rdsh-1', etc. You should use a unique prefix to reduce name collisions in Active Directory."
      }
    },
    "vmImageType": {
      "type": "string",
      "defaultValue": "Gallery",
      "metadata": {
        "description": "Select the image source for the session host vms. VMs from a Gallery image will be created with Managed Disks."
      },
      "allowedValues": [
        "CustomVHD",
        "CustomImage",
        "Gallery"
      ]
    },
    "vmGalleryImageOffer": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Required when vmImageType = Gallery) Gallery image Offer."
      }
    },
    "vmGalleryImagePublisher": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Required when vmImageType = Gallery) Gallery image Publisher."
      }
    },
    "vmGalleryImageSKU": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Required when vmImageType = Gallery) Gallery image SKU."
      }
    },
    "vmImageVhdUri": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Required when vmImageType = CustomVHD) URI of the sysprepped image vhd file to be used to create the session host VMs. For example, https://rdsstorage.blob.core.windows.net/vhds/sessionhostimage.vhd"
      }
    },
    "vmCustomImageSourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Required when vmImageType = CustomImage) Resource ID of the image"
      }
    },
    "vmDiskType": {
      "type": "string",
      "defaultValue": "StandardSSD_LRS",
      "metadata": {
        "description": "The VM disk type for the VM: HDD or SSD."
      },
      "allowedValues": [
        "Premium_LRS",
        "StandardSSD_LRS",
        "Standard_LRS"
      ]
    },
    "vmUseManagedDisks": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "True indicating you would like to use managed disks or false indicating you would like to use unmanaged disks."
      }
    },
    "storageAccountResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Required when vmUseManagedDisks = False) The resource group containing the storage account of the image vhd file."
      }
    },
    "existingVnetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of the virtual network the VMs will be connected to."
      }
    },
    "existingSubnetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The subnet the VMs will be placed in."
      }
    },
    "virtualNetworkResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The resource group containing the existing virtual network."
      }
    },
    "createNetworkSecurityGroup": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to create a new network security group or use an existing one"
      }
    },
    "networkSecurityGroupId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The resource id of an existing network security group"
      }
    },
    "networkSecurityGroupRules": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "The rules to be given to the new network security group"
      }
    },
    "hostpoolType": {
      "type": "string",
      "metadata": {
        "description": "Set this parameter to Personal if you would like to enable Persistent Desktop experience. Defaults to false."
      },
      "allowedValues": [
        "Personal",
        "Pooled"
      ]
    },
    "personalDesktopAssignmentType": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Set the type of assignment for a Personal hostpool type"
      },
      "allowedValues": [
        "Automatic",
        "Direct",
        ""
      ]
    },
    "maxSessionLimit": {
      "type": "int",
      "defaultValue": 99999,
      "metadata": {
        "description": "Maximum number of sessions."
      }
    },
    "loadBalancerType": {
      "type": "string",
      "defaultValue": "BreadthFirst",
      "metadata": {
        "description": "Type of load balancer algorithm."
      },
      "allowedValues": [
        "BreadthFirst",
        "DepthFirst",
        "Persistent"
      ]
    },
    "customRdpProperty": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Hostpool rdp properties"
      }
    },
    "vmTemplate": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The necessary information for adding more VMs to this Hostpool"
      }
    },
    "tokenExpirationTime": {
      "type": "string",
      "metadata": {
        "description": "Hostpool token expiration time"
      }
    },
    "hostpoolTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "The tags to be assigned to the hostpool"
      }
    },
    "applicationGroupTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "The tags to be assigned to the application group"
      }
    },
    "availabilitySetTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "The tags to be assigned to the availability set"
      }
    },
    "networkInterfaceTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "The tags to be assigned to the network interfaces"
      }
    },
    "networkSecurityGroupTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "The tags to be assigned to the network security groups"
      }
    },
    "virtualMachineTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "The tags to be assigned to the virtual machines"
      }
    },
    "imageTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "The tags to be assigned to the images"
      }
    },
    "apiVersion": {
      "type": "string",
      "defaultValue": "2019-12-10-preview",
      "metadata": {
        "description": "WVD api version"
      }
    },
    "deploymentId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "GUID for the deployment"
      }
    },
    "validationEnvironment": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to use validation enviroment."
      }
    },
    "preferredAppGroupType": {
      "type": "string",
      "defaultValue": "Desktop",
      "metadata": {
        "description": "Preferred App Group type to display"
      }
    },
    "ouPath": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "OUPath for the domain join"
      }
    },
    "domain": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Domain to join"
      }
    },
    "aadJoin": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "IMPORTANT: Please don't use this parameter as AAD Join is not supported yet. True if AAD Join, false if AD join"
      }
    },
    "intune": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "IMPORTANT: Please don't use this parameter as intune enrollment is not supported yet. True if intune enrollment is selected.  False otherwise"
      }
    }
  },
  "functions": [],
  "variables": {
    "copy": [
      {
        "name": "rdshVmNamesOutput",
        "count": "[length(range(0, if(variables('createVMs'), parameters('vmNumberOfInstances'), 1)))]",
        "input": {
          "name": "[format('{0}{1}', variables('rdshPrefix'), range(0, if(variables('createVMs'), parameters('vmNumberOfInstances'), 1))[copyIndex('rdshVmNamesOutput')])]"
        }
      }
    ],
    "createVMs": "[greater(parameters('vmNumberOfInstances'), 0)]",
    "rdshManagedDisks": "[if(equals(parameters('vmImageType'), 'CustomVHD'), parameters('vmUseManagedDisks'), bool('true'))]",
    "rdshPrefix": "[format('{0}-', parameters('vmNamePrefix'))]",
    "avSetSKU": "[if(variables('rdshManagedDisks'), 'Aligned', 'Classic')]",
    "vhds": "[format('vhds/{0}', variables('rdshPrefix'))]",
    "subnet_id": "[resourceId(parameters('virtualNetworkResourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVnetName'), parameters('existingSubnetName'))]",
    "hostpoolName_var": "[replace(parameters('hostpoolName'), '\"', '')]",
    "appGroupName_var": "[format('{0}-DAG', variables('hostpoolName_var'))]",
    "appGroupResourceId": [
      "[resourceId('Microsoft.DesktopVirtualization/applicationgroups/', variables('appGroupName_var'))]"
    ],
    "workspaceResourceGroup_var": "[if(empty(parameters('workspaceResourceGroup')), resourceGroup().name, parameters('workspaceResourceGroup'))]",
    "applicationGroupReferencesArr": "[if(equals('', parameters('allApplicationGroupReferences')), variables('appGroupResourceId'), concat(split(parameters('allApplicationGroupReferences'), ','), variables('appGroupResourceId')))]",
    "hostpoolRequiredProps": {
      "friendlyName": "[parameters('hostpoolFriendlyName')]",
      "description": "[parameters('hostpoolDescription')]",
      "hostpoolType": "[parameters('hostpoolType')]",
      "personalDesktopAssignmentType": "[parameters('personalDesktopAssignmentType')]",
      "maxSessionLimit": "[parameters('maxSessionLimit')]",
      "loadBalancerType": "[parameters('loadBalancerType')]",
      "validationEnvironment": "[parameters('validationEnvironment')]",
      "preferredAppGroupType": "[parameters('preferredAppGroupType')]",
      "ring": null,
      "registrationInfo": {
        "expirationTime": "[parameters('tokenExpirationTime')]",
        "token": null,
        "registrationTokenOperation": "Update"
      },
      "vmTemplate": "[parameters('vmTemplate')]"
    },
    "hostpoolOptionalProps": {
      "customRdpProperty": "[parameters('customRdpProperty')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.DesktopVirtualization/hostPools",
      "apiVersion": "2019-12-10-preview",
      "name": "[parameters('hostpoolName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('hostpoolTags')]",
      "properties": "[if(empty(parameters('customRdpProperty')), variables('hostpoolRequiredProps'), union(variables('hostpoolOptionalProps'), variables('hostpoolRequiredProps')))]"
    },
    {
      "type": "Microsoft.DesktopVirtualization/applicationGroups",
      "apiVersion": "2019-12-10-preview",
      "name": "[variables('appGroupName_var')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('applicationGroupTags')]",
      "properties": {
        "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostpoolName'))]",
        "friendlyName": "Default Desktop",
        "description": "Desktop Application Group created through the Hostpool Wizard",
        "applicationGroupType": "Desktop"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostpoolName'))]"
      ]
    },
    {
      "condition": "[parameters('addToWorkspace')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('Workspace-linkedTemplate-{0}', parameters('deploymentId'))]",
      "resourceGroup": "[variables('workspaceResourceGroup_var')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "workSpaceName": {
            "value": "[parameters('workSpaceName')]"
          },
          "workspaceLocation": {
            "value": "[parameters('workspaceLocation')]"
          },
          "applicationGroupReferencesArr": {
            "value": "[variables('applicationGroupReferencesArr')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "dev",
              "templateHash": "11596780352137584181"
            }
          },
          "parameters": {
            "workSpaceName": {
              "type": "string"
            },
            "workspaceLocation": {
              "type": "string"
            },
            "applicationGroupReferencesArr": {
              "type": "array"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/workspaces",
              "apiVersion": "2019-12-10-preview",
              "name": "[parameters('workSpaceName')]",
              "location": "[parameters('workspaceLocation')]",
              "properties": {
                "applicationGroupReferences": "[parameters('applicationGroupReferencesArr')]"
              }
            }
          ]
        }
      }
    },
    {
      "condition": "[and(and(variables('createVMs'), equals(parameters('availabilityOption'), 'AvailabilitySet')), parameters('createAvailabilitySet'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "AVSet-deployment",
      "resourceGroup": "[parameters('vmResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "availabilitySetName": {
            "value": "[parameters('availabilitySetName')]"
          },
          "vmLocation": {
            "value": "[parameters('vmLocation')]"
          },
          "availabilitySetTags": {
            "value": "[parameters('availabilitySetTags')]"
          },
          "availabilitySetUpdateDomainCount": {
            "value": "[parameters('availabilitySetUpdateDomainCount')]"
          },
          "availabilitySetFaultDomainCount": {
            "value": "[parameters('availabilitySetFaultDomainCount')]"
          },
          "avSetSKU": {
            "value": "[variables('avSetSKU')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "dev",
              "templateHash": "871329429336967058"
            }
          },
          "parameters": {
            "availabilitySetName": {
              "type": "string"
            },
            "vmLocation": {
              "type": "string"
            },
            "availabilitySetTags": {
              "type": "object"
            },
            "availabilitySetUpdateDomainCount": {
              "type": "int"
            },
            "availabilitySetFaultDomainCount": {
              "type": "int"
            },
            "avSetSKU": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Compute/availabilitySets",
              "apiVersion": "2018-10-01",
              "name": "[parameters('availabilitySetName')]",
              "location": "[parameters('vmLocation')]",
              "tags": "[parameters('availabilitySetTags')]",
              "properties": {
                "platformUpdateDomainCount": "[parameters('availabilitySetUpdateDomainCount')]",
                "platformFaultDomainCount": "[parameters('availabilitySetFaultDomainCount')]"
              },
              "sku": {
                "name": "[parameters('avSetSKU')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', variables('appGroupName_var'))]"
      ]
    },
    {
      "condition": "[and(and(variables('createVMs'), equals(parameters('vmImageType'), 'CustomVHD')), parameters('vmUseManagedDisks'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('vmCreation-linkedTemplate-{0}-managedDisks-customvhdvm', parameters('deploymentId'))]",
      "resourceGroup": "[parameters('vmResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "artifactsLocation": {
            "value": "[parameters('artifactsLocation')]"
          },
          "availabilityOption": {
            "value": "[parameters('availabilityOption')]"
          },
          "availabilitySetName": {
            "value": "[parameters('availabilitySetName')]"
          },
          "availabilityZone": {
            "value": "[parameters('availabilityZone')]"
          },
          "vmImageVhdUri": {
            "value": "[parameters('vmImageVhdUri')]"
          },
          "storageAccountResourceGroupName": {
            "value": "[parameters('storageAccountResourceGroupName')]"
          },
          "vmGalleryImageOffer": {
            "value": "[parameters('vmGalleryImageOffer')]"
          },
          "vmGalleryImagePublisher": {
            "value": "[parameters('vmGalleryImagePublisher')]"
          },
          "vmGalleryImageSKU": {
            "value": "[parameters('vmGalleryImageSKU')]"
          },
          "rdshPrefix": {
            "value": "[variables('rdshPrefix')]"
          },
          "rdshNumberOfInstances": {
            "value": "[parameters('vmNumberOfInstances')]"
          },
          "rdshVMDiskType": {
            "value": "[parameters('vmDiskType')]"
          },
          "rdshVmSize": {
            "value": "[parameters('vmSize')]"
          },
          "enableAcceleratedNetworking": {
            "value": false
          },
          "vmAdministratorAccountUsername": {
            "value": "[parameters('vmAdministratorAccountUsername')]"
          },
          "vmAdministratorAccountPassword": {
            "value": "[parameters('vmAdministratorAccountPassword')]"
          },
          "administratorAccountUsername": {
            "value": "[parameters('administratorAccountUsername')]"
          },
          "administratorAccountPassword": {
            "value": "[parameters('administratorAccountPassword')]"
          },
          "subnet_id": {
            "value": "[variables('subnet_id')]"
          },
          "vhds": {
            "value": "[variables('vhds')]"
          },
          "rdshImageSourceId": {
            "value": "[parameters('vmCustomImageSourceId')]"
          },
          "location": {
            "value": "[parameters('vmLocation')]"
          },
          "createNetworkSecurityGroup": {
            "value": "[parameters('createNetworkSecurityGroup')]"
          },
          "networkSecurityGroupId": {
            "value": "[parameters('networkSecurityGroupId')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('networkSecurityGroupRules')]"
          },
          "networkInterfaceTags": {
            "value": "[parameters('networkInterfaceTags')]"
          },
          "networkSecurityGroupTags": {
            "value": "[parameters('networkSecurityGroupTags')]"
          },
          "virtualMachineTags": {
            "value": "[parameters('virtualMachineTags')]"
          },
          "imageTags": {
            "value": "[parameters('imageTags')]"
          },
          "hostpoolToken": {
            "value": "[reference(parameters('hostpoolName')).registrationInfo.token]"
          },
          "hostpoolName": {
            "value": "[parameters('hostpoolName')]"
          },
          "domain": {
            "value": "[parameters('domain')]"
          },
          "ouPath": {
            "value": "[parameters('ouPath')]"
          },
          "aadJoin": {
            "value": "[parameters('aadJoin')]"
          },
          "intune": {
            "value": "[parameters('intune')]"
          },
          "guidValue": {
            "value": "[parameters('deploymentId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "dev",
              "templateHash": "16380997742108041127"
            }
          },
          "parameters": {
            "artifactsLocation": {
              "type": "string",
              "defaultValue": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/ARM-wvd-templates/DSC/Configuration.zip",
              "metadata": {
                "description": "The base URI where artifacts required by this template are located."
              }
            },
            "availabilityOption": {
              "type": "string",
              "defaultValue": "None",
              "metadata": {
                "description": "The availability option for the VMs."
              },
              "allowedValues": [
                "None",
                "AvailabilitySet",
                "AvailabilityZone"
              ]
            },
            "availabilitySetName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of avaiability set to be used when create the VMs."
              }
            },
            "availabilityZone": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "The number of availability zone to be used when create the VMs."
              },
              "allowedValues": [
                1,
                2,
                3
              ]
            },
            "vmImageVhdUri": {
              "type": "string",
              "metadata": {
                "description": "URI of the sysprepped image vhd file to be used to create the session host VMs. For example, https://rdsstorage.blob.core.windows.net/vhds/sessionhostimage.vhd"
              }
            },
            "storageAccountResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The storage account containing the custom VHD."
              }
            },
            "vmGalleryImageOffer": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image Offer."
              }
            },
            "vmGalleryImagePublisher": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image Publisher."
              }
            },
            "vmGalleryImageSKU": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image SKU."
              }
            },
            "rdshPrefix": {
              "type": "string",
              "defaultValue": "[take(toLower(resourceGroup().name), 10)]",
              "metadata": {
                "description": "This prefix will be used in combination with the VM number to create the VM name. This value includes the dash, so if using “rdsh” as the prefix, VMs would be named “rdsh-0”, “rdsh-1”, etc. You should use a unique prefix to reduce name collisions in Active Directory."
              }
            },
            "rdshNumberOfInstances": {
              "type": "int",
              "metadata": {
                "description": "Number of session hosts that will be created and added to the hostpool."
              }
            },
            "rdshVMDiskType": {
              "type": "string",
              "metadata": {
                "description": "The VM disk type for the VM: HDD or SSD."
              },
              "allowedValues": [
                "Premium_LRS",
                "StandardSSD_LRS",
                "Standard_LRS"
              ]
            },
            "rdshVmSize": {
              "type": "string",
              "defaultValue": "Standard_A2",
              "metadata": {
                "description": "The size of the session host VMs."
              }
            },
            "enableAcceleratedNetworking": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enables Accelerated Networking feature, notice that VM size must support it, this is supported in most of general purpose and compute-optimized instances with 2 or more vCPUs, on instances that supports hyperthreading it is required minimum of 4 vCPUs."
              }
            },
            "administratorAccountUsername": {
              "type": "string",
              "metadata": {
                "description": "The username for the domain admin."
              }
            },
            "administratorAccountPassword": {
              "type": "secureString",
              "metadata": {
                "description": "The password that corresponds to the existing domain username."
              }
            },
            "vmAdministratorAccountUsername": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A username to be used as the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
              }
            },
            "vmAdministratorAccountPassword": {
              "type": "secureString",
              "defaultValue": "",
              "metadata": {
                "description": "The password associated with the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
              }
            },
            "vhds": {
              "type": "string",
              "metadata": {
                "description": "The URL to store unmanaged disks."
              }
            },
            "subnet_id": {
              "type": "string",
              "metadata": {
                "description": "The unique id of the subnet for the nics."
              }
            },
            "rdshImageSourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of the image."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Location for all resources to be created in."
              }
            },
            "createNetworkSecurityGroup": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to create a new network security group or use an existing one"
              }
            },
            "networkSecurityGroupId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource id of an existing network security group"
              }
            },
            "networkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The rules to be given to the new network security group"
              }
            },
            "networkInterfaceTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the network interfaces"
              }
            },
            "networkSecurityGroupTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the network security groups"
              }
            },
            "virtualMachineTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the virtual machines"
              }
            },
            "imageTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the images"
              }
            },
            "vmInitialNumber": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "VM name prefix initial number."
              }
            },
            "guidValue": {
              "type": "string",
              "defaultValue": "[newGuid()]"
            },
            "hostpoolToken": {
              "type": "string",
              "metadata": {
                "description": "The token for adding VMs to the hostpool"
              }
            },
            "hostpoolName": {
              "type": "string",
              "metadata": {
                "description": "The name of the hostpool"
              }
            },
            "ouPath": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "OUPath for the domain join"
              }
            },
            "domain": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Domain to join"
              }
            },
            "aadJoin": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "IMPORTANT: Please don't use this parameter as AAD Join is not supported yet. True if AAD Join, false if AD join"
              }
            },
            "intune": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "IMPORTANT: Please don't use this parameter as intune enrollment is not supported yet. True if intune enrollment is selected.  False otherwise"
              }
            }
          },
          "functions": [],
          "variables": {
            "emptyArray": [],
            "domain_var": "[if(equals(parameters('domain'), ''), last(split(parameters('administratorAccountUsername'), '@')), parameters('domain'))]",
            "storageAccountType": "[parameters('rdshVMDiskType')]",
            "imageName_var": "[format('{0}image', parameters('rdshPrefix'))]",
            "newNsgName": "[format('{0}nsg-{1}', parameters('rdshPrefix'), parameters('guidValue'))]",
            "nsgId": "[if(parameters('createNetworkSecurityGroup'), resourceId('Microsoft.Network/networkSecurityGroups', variables('newNsgName')), parameters('networkSecurityGroupId'))]",
            "isVMAdminAccountCredentialsProvided": "[and(not(equals(parameters('vmAdministratorAccountUsername'), '')), not(equals(parameters('vmAdministratorAccountPassword'), '')))]",
            "vmAdministratorUsername": "[if(variables('isVMAdminAccountCredentialsProvided'), parameters('vmAdministratorAccountUsername'), first(split(parameters('administratorAccountUsername'), '@')))]",
            "vmAdministratorPassword": "[if(variables('isVMAdminAccountCredentialsProvided'), parameters('vmAdministratorAccountPassword'), parameters('administratorAccountPassword'))]",
            "vmAvailabilitySetResourceId": {
              "id": "[resourceId('Microsoft.Compute/availabilitySets/', parameters('availabilitySetName'))]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/images",
              "apiVersion": "2018-10-01",
              "name": "[variables('imageName_var')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('imageTags')]",
              "properties": {
                "storageProfile": {
                  "osDisk": {
                    "osType": "Windows",
                    "osState": "Generalized",
                    "blobUri": "[parameters('vmImageVhdUri')]",
                    "storageAccountType": "[variables('storageAccountType')]"
                  }
                }
              }
            },
            {
              "copy": {
                "name": "nic",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2018-11-01",
              "name": "[format('{0}{1}-nic', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('networkInterfaceTags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('subnet_id')]"
                      }
                    }
                  }
                ],
                "enableAcceleratedNetworking": "[parameters('enableAcceleratedNetworking')]",
                "networkSecurityGroup": "[if(empty(parameters('networkSecurityGroupId')), json('null'), json(format('{{\"id\": \"{0}\"}}', variables('nsgId'))))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'NSG-linkedTemplate')]"
              ]
            },
            {
              "copy": {
                "name": "vm",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2018-10-01",
              "name": "[concat(parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('virtualMachineTags')]",
              "identity": {
                "type": "[if(parameters('aadJoin'), 'SystemAssigned', 'None')]"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('rdshVmSize')]"
                },
                "availabilitySet": "[if(equals(parameters('availabilityOption'), 'AvailabilitySet'), variables('vmAvailabilitySetResourceId'), json('null'))]",
                "osProfile": {
                  "computerName": "[concat(parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
                  "adminUsername": "[variables('vmAdministratorUsername')]",
                  "adminPassword": "[variables('vmAdministratorPassword')]"
                },
                "storageProfile": {
                  "osDisk": {
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "[variables('storageAccountType')]"
                    }
                  },
                  "imageReference": {
                    "id": "[resourceId('Microsoft.Compute/images', variables('imageName_var'))]"
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}{1}-nic', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber'))))]"
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": false
                  }
                },
                "licenseType": "Windows_Client"
              },
              "zones": "[if(equals(parameters('availabilityOption'), 'AvailabilityZone'), array(parameters('availabilityZone')), variables('emptyArray'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Compute/images', variables('imageName_var'))]",
                "nic"
              ]
            },
            {
              "copy": {
                "name": "vm_DSC",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/Microsoft.PowerShell.DSC', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "modulesUrl": "[parameters('artifactsLocation')]",
                  "configurationFunction": "Configuration.ps1\\AddSessionHost",
                  "properties": {
                    "hostPoolName": "[parameters('hostpoolName')]",
                    "registrationInfoToken": "[parameters('hostpoolToken')]",
                    "aadJoin": "[parameters('aadJoin')]"
                  }
                }
              },
              "dependsOn": [
                "vm"
              ]
            },
            {
              "condition": "[and(parameters('aadJoin'), not(parameters('intune')))]",
              "copy": {
                "name": "vm_AADLoginForWindows",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/AADLoginForWindows', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "condition": "[and(parameters('aadJoin'), parameters('intune'))]",
              "copy": {
                "name": "vm_AADLoginForWindowsWithIntune",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/AADLoginForWindowsWithIntune', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "mdmId": "0000000a-0000-0000-c000-000000000000"
                }
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "condition": "[not(parameters('aadJoin'))]",
              "copy": {
                "name": "vm_joindomain",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/joindomain', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "name": "[variables('domain_var')]",
                  "ouPath": "[parameters('ouPath')]",
                  "user": "[parameters('administratorAccountUsername')]",
                  "restart": "true",
                  "options": "3"
                },
                "protectedSettings": {
                  "password": "[parameters('administratorAccountPassword')]"
                }
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "NSG-linkedTemplate",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "createNetworkSecurityGroup": {
                    "value": "[parameters('createNetworkSecurityGroup')]"
                  },
                  "newNsgName": {
                    "value": "[variables('newNsgName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "networkSecurityGroupTags": {
                    "value": "[parameters('networkSecurityGroupTags')]"
                  },
                  "networkSecurityGroupRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "dev",
                      "templateHash": "9768223943364163858"
                    }
                  },
                  "parameters": {
                    "createNetworkSecurityGroup": {
                      "type": "bool"
                    },
                    "newNsgName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "networkSecurityGroupTags": {
                      "type": "object"
                    },
                    "networkSecurityGroupRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[parameters('createNetworkSecurityGroup')]",
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2019-02-01",
                      "name": "[parameters('newNsgName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('networkSecurityGroupTags')]",
                      "properties": {
                        "securityRules": "[parameters('networkSecurityGroupRules')]"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vmResourceGroup')), 'Microsoft.Resources/deployments', 'AVSet-deployment')]"
      ]
    },
    {
      "condition": "[and(and(variables('createVMs'), equals(parameters('vmImageType'), 'CustomVHD')), not(parameters('vmUseManagedDisks')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('vmCreation-linkedTemplate-{0}-unmanagedDisks-customvhdvm', parameters('deploymentId'))]",
      "resourceGroup": "[parameters('vmResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "artifactsLocation": {
            "value": "[parameters('artifactsLocation')]"
          },
          "availabilityOption": {
            "value": "[parameters('availabilityOption')]"
          },
          "availabilitySetName": {
            "value": "[parameters('availabilitySetName')]"
          },
          "availabilityZone": {
            "value": "[parameters('availabilityZone')]"
          },
          "vmImageVhdUri": {
            "value": "[parameters('vmImageVhdUri')]"
          },
          "storageAccountResourceGroupName": {
            "value": "[parameters('storageAccountResourceGroupName')]"
          },
          "vmGalleryImageOffer": {
            "value": "[parameters('vmGalleryImageOffer')]"
          },
          "vmGalleryImagePublisher": {
            "value": "[parameters('vmGalleryImagePublisher')]"
          },
          "vmGalleryImageSKU": {
            "value": "[parameters('vmGalleryImageSKU')]"
          },
          "rdshPrefix": {
            "value": "[variables('rdshPrefix')]"
          },
          "rdshNumberOfInstances": {
            "value": "[parameters('vmNumberOfInstances')]"
          },
          "rdshVMDiskType": {
            "value": "[parameters('vmDiskType')]"
          },
          "rdshVmSize": {
            "value": "[parameters('vmSize')]"
          },
          "enableAcceleratedNetworking": {
            "value": false
          },
          "vmAdministratorAccountUsername": {
            "value": "[parameters('vmAdministratorAccountUsername')]"
          },
          "vmAdministratorAccountPassword": {
            "value": "[parameters('vmAdministratorAccountPassword')]"
          },
          "administratorAccountUsername": {
            "value": "[parameters('administratorAccountUsername')]"
          },
          "administratorAccountPassword": {
            "value": "[parameters('administratorAccountPassword')]"
          },
          "subnet_id": {
            "value": "[variables('subnet_id')]"
          },
          "vhds": {
            "value": "[variables('vhds')]"
          },
          "rdshImageSourceId": {
            "value": "[parameters('vmCustomImageSourceId')]"
          },
          "location": {
            "value": "[parameters('vmLocation')]"
          },
          "createNetworkSecurityGroup": {
            "value": "[parameters('createNetworkSecurityGroup')]"
          },
          "networkSecurityGroupId": {
            "value": "[parameters('networkSecurityGroupId')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('networkSecurityGroupRules')]"
          },
          "networkInterfaceTags": {
            "value": "[parameters('networkInterfaceTags')]"
          },
          "networkSecurityGroupTags": {
            "value": "[parameters('networkSecurityGroupTags')]"
          },
          "virtualMachineTags": {
            "value": "[parameters('virtualMachineTags')]"
          },
          "imageTags": {
            "value": "[parameters('imageTags')]"
          },
          "hostpoolToken": {
            "value": "[reference(parameters('hostpoolName')).registrationInfo.token]"
          },
          "hostpoolName": {
            "value": "[parameters('hostpoolName')]"
          },
          "domain": {
            "value": "[parameters('domain')]"
          },
          "ouPath": {
            "value": "[parameters('ouPath')]"
          },
          "aadJoin": {
            "value": "[parameters('aadJoin')]"
          },
          "intune": {
            "value": "[parameters('intune')]"
          },
          "guidValue": {
            "value": "[parameters('deploymentId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "dev",
              "templateHash": "3622114365539263083"
            }
          },
          "parameters": {
            "artifactsLocation": {
              "type": "string",
              "defaultValue": "ttps://raw.githubusercontent.com/Azure/RDS-Templates/master/ARM-wvd-templates/DSC/Configuration.zip",
              "metadata": {
                "description": "The base URI where artifacts required by this template are located."
              }
            },
            "availabilityOption": {
              "type": "string",
              "defaultValue": "None",
              "metadata": {
                "description": "The availability option for the VMs."
              },
              "allowedValues": [
                "None",
                "AvailabilitySet",
                "AvailabilityZone"
              ]
            },
            "availabilitySetName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of avaiability set to be used when create the VMs."
              }
            },
            "availabilityZone": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "The number of availability zone to be used when create the VMs."
              },
              "allowedValues": [
                1,
                2,
                3
              ]
            },
            "vmImageVhdUri": {
              "type": "string",
              "metadata": {
                "description": "URI of the sysprepped image vhd file to be used to create the session host VMs. For example, https://rdsstorage.blob.core.windows.net/vhds/sessionhostimage.vhd"
              }
            },
            "storageAccountResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The storage account containing the custom VHD."
              }
            },
            "vmGalleryImageOffer": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image Offer."
              }
            },
            "vmGalleryImagePublisher": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image Publisher."
              }
            },
            "vmGalleryImageSKU": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image SKU."
              }
            },
            "rdshPrefix": {
              "type": "string",
              "defaultValue": "[take(toLower(resourceGroup().name), 10)]",
              "metadata": {
                "description": "This prefix will be used in combination with the VM number to create the VM name. This value includes the dash, so if using “rdsh” as the prefix, VMs would be named “rdsh-0”, “rdsh-1”, etc. You should use a unique prefix to reduce name collisions in Active Directory."
              }
            },
            "rdshNumberOfInstances": {
              "type": "int",
              "metadata": {
                "description": "Number of session hosts that will be created and added to the hostpool."
              }
            },
            "rdshVMDiskType": {
              "type": "string",
              "metadata": {
                "description": "The VM disk type for the VM: HDD or SSD."
              },
              "allowedValues": [
                "Premium_LRS",
                "StandardSSD_LRS",
                "Standard_LRS"
              ]
            },
            "rdshVmSize": {
              "type": "string",
              "defaultValue": "Standard_A2",
              "metadata": {
                "description": "The size of the session host VMs."
              }
            },
            "enableAcceleratedNetworking": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enables Accelerated Networking feature, notice that VM size must support it, this is supported in most of general purpose and compute-optimized instances with 2 or more vCPUs, on instances that supports hyperthreading it is required minimum of 4 vCPUs."
              }
            },
            "administratorAccountUsername": {
              "type": "string",
              "metadata": {
                "description": "The username for the domain admin."
              }
            },
            "administratorAccountPassword": {
              "type": "secureString",
              "metadata": {
                "description": "The password that corresponds to the existing domain username."
              }
            },
            "vmAdministratorAccountUsername": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A username to be used as the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
              }
            },
            "vmAdministratorAccountPassword": {
              "type": "secureString",
              "defaultValue": "",
              "metadata": {
                "description": "The password associated with the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
              }
            },
            "vhds": {
              "type": "string",
              "metadata": {
                "description": "The URL to store unmanaged disks."
              }
            },
            "subnet_id": {
              "type": "string",
              "metadata": {
                "description": "The unique id of the subnet for the nics."
              }
            },
            "rdshImageSourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of the image."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Location for all resources to be created in."
              }
            },
            "createNetworkSecurityGroup": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to create a new network security group or use an existing one"
              }
            },
            "networkSecurityGroupId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource id of an existing network security group"
              }
            },
            "networkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The rules to be given to the new network security group"
              }
            },
            "networkInterfaceTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the network interfaces"
              }
            },
            "networkSecurityGroupTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the network security groups"
              }
            },
            "virtualMachineTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the virtual machines"
              }
            },
            "imageTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the images"
              }
            },
            "vmInitialNumber": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "VM name prefix initial number."
              }
            },
            "guidValue": {
              "type": "string",
              "defaultValue": "[newGuid()]"
            },
            "hostpoolToken": {
              "type": "string",
              "metadata": {
                "description": "The token for adding VMs to the hostpool"
              }
            },
            "hostpoolName": {
              "type": "string",
              "metadata": {
                "description": "The name of the hostpool"
              }
            },
            "ouPath": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "OUPath for the domain join"
              }
            },
            "domain": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Domain to join"
              }
            },
            "aadJoin": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "IMPORTANT: Please don't use this parameter as AAD Join is not supported yet. True if AAD Join, false if AD join"
              }
            },
            "intune": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "IMPORTANT: Please don't use this parameter as intune enrollment is not supported yet. True if intune enrollment is selected.  False otherwise"
              }
            }
          },
          "functions": [],
          "variables": {
            "emptyArray": [],
            "domain_var": "[if(equals(parameters('domain'), ''), last(split(parameters('administratorAccountUsername'), '@')), parameters('domain'))]",
            "storageAccountName": "[split(split(parameters('vmImageVhdUri'), '/')[2], '.')[0]]",
            "storageaccount": "[concat(resourceId(parameters('storageAccountResourceGroupName'), 'Microsoft.Storage/storageAccounts', variables('storageAccountName')))]",
            "newNsgName": "[format('{0}nsg-{1}', parameters('rdshPrefix'), parameters('guidValue'))]",
            "nsgId": "[if(parameters('createNetworkSecurityGroup'), resourceId('Microsoft.Network/networkSecurityGroups', variables('newNsgName')), parameters('networkSecurityGroupId'))]",
            "isVMAdminAccountCredentialsProvided": "[and(not(equals(parameters('vmAdministratorAccountUsername'), '')), not(equals(parameters('vmAdministratorAccountPassword'), '')))]",
            "vmAdministratorUsername": "[if(variables('isVMAdminAccountCredentialsProvided'), parameters('vmAdministratorAccountUsername'), first(split(parameters('administratorAccountUsername'), '@')))]",
            "vmAdministratorPassword": "[if(variables('isVMAdminAccountCredentialsProvided'), parameters('vmAdministratorAccountPassword'), parameters('administratorAccountPassword'))]",
            "vmAvailabilitySetResourceId": {
              "id": "[resourceId('Microsoft.Compute/availabilitySets/', parameters('availabilitySetName'))]"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "nic",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2018-11-01",
              "name": "[format('{0}{1}-nic', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('networkInterfaceTags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('subnet_id')]"
                      }
                    }
                  }
                ],
                "enableAcceleratedNetworking": "[parameters('enableAcceleratedNetworking')]",
                "networkSecurityGroup": "[if(empty(parameters('networkSecurityGroupId')), json('null'), json(format('{{\"id\": \"{0}\"}}', variables('nsgId'))))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'NSG-linkedTemplate')]"
              ]
            },
            {
              "copy": {
                "name": "vm",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2018-10-01",
              "name": "[concat(parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('virtualMachineTags')]",
              "identity": {
                "type": "[if(parameters('aadJoin'), 'SystemAssigned', 'None')]"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('rdshVmSize')]"
                },
                "availabilitySet": "[if(equals(parameters('availabilityOption'), 'AvailabilitySet'), variables('vmAvailabilitySetResourceId'), json('null'))]",
                "osProfile": {
                  "computerName": "[concat(parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
                  "adminUsername": "[variables('vmAdministratorUsername')]",
                  "adminPassword": "[variables('vmAdministratorPassword')]"
                },
                "storageProfile": {
                  "osDisk": {
                    "name": "[format('{0}{1}-osDisk', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
                    "osType": "Windows",
                    "caching": "ReadWrite",
                    "createOption": "FromImage",
                    "image": {
                      "uri": "[parameters('vmImageVhdUri')]"
                    },
                    "vhd": {
                      "uri": "[format('{0}{1}{2}-osdisk.vhd', reference(variables('storageaccount'), '2018-11-01').primaryEndpoints.blob, parameters('vhds'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]"
                    }
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}{1}-nic', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber'))))]"
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": false
                  }
                },
                "licenseType": "Windows_Client"
              },
              "zones": "[if(equals(parameters('availabilityOption'), 'AvailabilityZone'), array(parameters('availabilityZone')), variables('emptyArray'))]",
              "dependsOn": [
                "nic"
              ]
            },
            {
              "copy": {
                "name": "vm_DSC",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/Microsoft.PowerShell.DSC', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "modulesUrl": "[parameters('artifactsLocation')]",
                  "configurationFunction": "Configuration.ps1\\AddSessionHost",
                  "properties": {
                    "hostPoolName": "[parameters('hostpoolName')]",
                    "registrationInfoToken": "[parameters('hostpoolToken')]",
                    "aadJoin": "[parameters('aadJoin')]"
                  }
                }
              },
              "dependsOn": [
                "vm"
              ]
            },
            {
              "condition": "[and(parameters('aadJoin'), not(parameters('intune')))]",
              "copy": {
                "name": "vm_AADLoginForWindows",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/AADLoginForWindows', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "condition": "[and(parameters('aadJoin'), parameters('intune'))]",
              "copy": {
                "name": "vm_AADLoginForWindowsWithIntune",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/AADLoginForWindowsWithIntune', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "mdmId": "0000000a-0000-0000-c000-000000000000"
                }
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "condition": "[not(parameters('aadJoin'))]",
              "copy": {
                "name": "vm_joindomain",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/joindomain', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "name": "[variables('domain_var')]",
                  "ouPath": "[parameters('ouPath')]",
                  "user": "[parameters('administratorAccountUsername')]",
                  "restart": "true",
                  "options": "3"
                },
                "protectedSettings": {
                  "password": "[parameters('administratorAccountPassword')]"
                }
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "NSG-linkedTemplate",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "createNetworkSecurityGroup": {
                    "value": "[parameters('createNetworkSecurityGroup')]"
                  },
                  "newNsgName": {
                    "value": "[variables('newNsgName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "networkSecurityGroupTags": {
                    "value": "[parameters('networkSecurityGroupTags')]"
                  },
                  "networkSecurityGroupRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "dev",
                      "templateHash": "9768223943364163858"
                    }
                  },
                  "parameters": {
                    "createNetworkSecurityGroup": {
                      "type": "bool"
                    },
                    "newNsgName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "networkSecurityGroupTags": {
                      "type": "object"
                    },
                    "networkSecurityGroupRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[parameters('createNetworkSecurityGroup')]",
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2019-02-01",
                      "name": "[parameters('newNsgName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('networkSecurityGroupTags')]",
                      "properties": {
                        "securityRules": "[parameters('networkSecurityGroupRules')]"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vmResourceGroup')), 'Microsoft.Resources/deployments', 'AVSet-deployment')]"
      ]
    },
    {
      "condition": "[and(variables('createVMs'), equals(parameters('vmImageType'), 'CustomImage'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('vmCreation-linkedTemplate-{0}-managedDisks-customimagevm', parameters('deploymentId'))]",
      "resourceGroup": "[parameters('vmResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "artifactsLocation": {
            "value": "[parameters('artifactsLocation')]"
          },
          "availabilityOption": {
            "value": "[parameters('availabilityOption')]"
          },
          "availabilitySetName": {
            "value": "[parameters('availabilitySetName')]"
          },
          "availabilityZone": {
            "value": "[parameters('availabilityZone')]"
          },
          "vmImageVhdUri": {
            "value": "[parameters('vmImageVhdUri')]"
          },
          "storageAccountResourceGroupName": {
            "value": "[parameters('storageAccountResourceGroupName')]"
          },
          "vmGalleryImageOffer": {
            "value": "[parameters('vmGalleryImageOffer')]"
          },
          "vmGalleryImagePublisher": {
            "value": "[parameters('vmGalleryImagePublisher')]"
          },
          "vmGalleryImageSKU": {
            "value": "[parameters('vmGalleryImageSKU')]"
          },
          "rdshPrefix": {
            "value": "[variables('rdshPrefix')]"
          },
          "rdshNumberOfInstances": {
            "value": "[parameters('vmNumberOfInstances')]"
          },
          "rdshVMDiskType": {
            "value": "[parameters('vmDiskType')]"
          },
          "rdshVmSize": {
            "value": "[parameters('vmSize')]"
          },
          "enableAcceleratedNetworking": {
            "value": false
          },
          "vmAdministratorAccountUsername": {
            "value": "[parameters('vmAdministratorAccountUsername')]"
          },
          "vmAdministratorAccountPassword": {
            "value": "[parameters('vmAdministratorAccountPassword')]"
          },
          "administratorAccountUsername": {
            "value": "[parameters('administratorAccountUsername')]"
          },
          "administratorAccountPassword": {
            "value": "[parameters('administratorAccountPassword')]"
          },
          "subnet_id": {
            "value": "[variables('subnet_id')]"
          },
          "vhds": {
            "value": "[variables('vhds')]"
          },
          "rdshImageSourceId": {
            "value": "[parameters('vmCustomImageSourceId')]"
          },
          "location": {
            "value": "[parameters('vmLocation')]"
          },
          "createNetworkSecurityGroup": {
            "value": "[parameters('createNetworkSecurityGroup')]"
          },
          "networkSecurityGroupId": {
            "value": "[parameters('networkSecurityGroupId')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('networkSecurityGroupRules')]"
          },
          "networkInterfaceTags": {
            "value": "[parameters('networkInterfaceTags')]"
          },
          "networkSecurityGroupTags": {
            "value": "[parameters('networkSecurityGroupTags')]"
          },
          "virtualMachineTags": {
            "value": "[parameters('virtualMachineTags')]"
          },
          "imageTags": {
            "value": "[parameters('imageTags')]"
          },
          "hostpoolToken": {
            "value": "[reference(parameters('hostpoolName')).registrationInfo.token]"
          },
          "hostpoolName": {
            "value": "[parameters('hostpoolName')]"
          },
          "domain": {
            "value": "[parameters('domain')]"
          },
          "ouPath": {
            "value": "[parameters('ouPath')]"
          },
          "aadJoin": {
            "value": "[parameters('aadJoin')]"
          },
          "intune": {
            "value": "[parameters('intune')]"
          },
          "guidValue": {
            "value": "[parameters('deploymentId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "dev",
              "templateHash": "13456880223628676085"
            }
          },
          "parameters": {
            "artifactsLocation": {
              "type": "string",
              "defaultValue": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/ARM-wvd-templates/DSC/Configuration.zip",
              "metadata": {
                "description": "The base URI where artifacts required by this template are located."
              }
            },
            "availabilityOption": {
              "type": "string",
              "defaultValue": "None",
              "metadata": {
                "description": "The availability option for the VMs."
              },
              "allowedValues": [
                "None",
                "AvailabilitySet",
                "AvailabilityZone"
              ]
            },
            "availabilitySetName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of avaiability set to be used when create the VMs."
              }
            },
            "availabilityZone": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "The number of availability zone to be used when create the VMs."
              },
              "allowedValues": [
                1,
                2,
                3
              ]
            },
            "vmImageVhdUri": {
              "type": "string",
              "metadata": {
                "description": "URI of the sysprepped image vhd file to be used to create the session host VMs. For example, https://rdsstorage.blob.core.windows.net/vhds/sessionhostimage.vhd"
              }
            },
            "storageAccountResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The storage account containing the custom VHD."
              }
            },
            "vmGalleryImageOffer": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image Offer."
              }
            },
            "vmGalleryImagePublisher": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image Publisher."
              }
            },
            "vmGalleryImageSKU": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image SKU."
              }
            },
            "rdshPrefix": {
              "type": "string",
              "defaultValue": "[take(toLower(resourceGroup().name), 10)]",
              "metadata": {
                "description": "This prefix will be used in combination with the VM number to create the VM name. This value includes the dash, so if using “rdsh” as the prefix, VMs would be named “rdsh-0”, “rdsh-1”, etc. You should use a unique prefix to reduce name collisions in Active Directory."
              }
            },
            "rdshNumberOfInstances": {
              "type": "int",
              "metadata": {
                "description": "Number of session hosts that will be created and added to the hostpool."
              }
            },
            "rdshVMDiskType": {
              "type": "string",
              "metadata": {
                "description": "The VM disk type for the VM: HDD or SSD."
              },
              "allowedValues": [
                "Premium_LRS",
                "StandardSSD_LRS",
                "Standard_LRS"
              ]
            },
            "rdshVmSize": {
              "type": "string",
              "defaultValue": "Standard_A2",
              "metadata": {
                "description": "The size of the session host VMs."
              }
            },
            "enableAcceleratedNetworking": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enables Accelerated Networking feature, notice that VM size must support it, this is supported in most of general purpose and compute-optimized instances with 2 or more vCPUs, on instances that supports hyperthreading it is required minimum of 4 vCPUs."
              }
            },
            "administratorAccountUsername": {
              "type": "string",
              "metadata": {
                "description": "The username for the domain admin."
              }
            },
            "administratorAccountPassword": {
              "type": "secureString",
              "metadata": {
                "description": "The password that corresponds to the existing domain username."
              }
            },
            "vmAdministratorAccountUsername": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A username to be used as the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
              }
            },
            "vmAdministratorAccountPassword": {
              "type": "secureString",
              "defaultValue": "",
              "metadata": {
                "description": "The password associated with the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
              }
            },
            "vhds": {
              "type": "string",
              "metadata": {
                "description": "The URL to store unmanaged disks."
              }
            },
            "subnet_id": {
              "type": "string",
              "metadata": {
                "description": "The unique id of the subnet for the nics."
              }
            },
            "rdshImageSourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of the image."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Location for all resources to be created in."
              }
            },
            "createNetworkSecurityGroup": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to create a new network security group or use an existing one"
              }
            },
            "networkSecurityGroupId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource id of an existing network security group"
              }
            },
            "networkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The rules to be given to the new network security group"
              }
            },
            "networkInterfaceTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the network interfaces"
              }
            },
            "networkSecurityGroupTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the network security groups"
              }
            },
            "virtualMachineTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the virtual machines"
              }
            },
            "imageTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the images"
              }
            },
            "vmInitialNumber": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "VM name prefix initial number."
              }
            },
            "guidValue": {
              "type": "string",
              "defaultValue": "[newGuid()]"
            },
            "hostpoolToken": {
              "type": "string",
              "metadata": {
                "description": "The token for adding VMs to the hostpool"
              }
            },
            "hostpoolName": {
              "type": "string",
              "metadata": {
                "description": "The name of the hostpool"
              }
            },
            "ouPath": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "OUPath for the domain join"
              }
            },
            "domain": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Domain to join"
              }
            },
            "aadJoin": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "IMPORTANT: Please don't use this parameter as AAD Join is not supported yet. True if AAD Join, false if AD join"
              }
            },
            "intune": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "IMPORTANT: Please don't use this parameter as intune enrollment is not supported yet. True if intune enrollment is selected.  False otherwise"
              }
            }
          },
          "functions": [],
          "variables": {
            "emptyArray": [],
            "domain_var": "[if(equals(parameters('domain'), ''), last(split(parameters('administratorAccountUsername'), '@')), parameters('domain'))]",
            "storageAccountType": "[parameters('rdshVMDiskType')]",
            "newNsgName": "[format('{0}nsg-{1}', parameters('rdshPrefix'), parameters('guidValue'))]",
            "nsgId": "[if(parameters('createNetworkSecurityGroup'), resourceId('Microsoft.Network/networkSecurityGroups', variables('newNsgName')), parameters('networkSecurityGroupId'))]",
            "isVMAdminAccountCredentialsProvided": "[and(not(equals(parameters('vmAdministratorAccountUsername'), '')), not(equals(parameters('vmAdministratorAccountPassword'), '')))]",
            "vmAdministratorUsername": "[if(variables('isVMAdminAccountCredentialsProvided'), parameters('vmAdministratorAccountUsername'), first(split(parameters('administratorAccountUsername'), '@')))]",
            "vmAdministratorPassword": "[if(variables('isVMAdminAccountCredentialsProvided'), parameters('vmAdministratorAccountPassword'), parameters('administratorAccountPassword'))]",
            "vmAvailabilitySetResourceId": {
              "id": "[resourceId('Microsoft.Compute/availabilitySets/', parameters('availabilitySetName'))]"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "nic",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2018-11-01",
              "name": "[format('{0}{1}-nic', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('networkInterfaceTags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('subnet_id')]"
                      }
                    }
                  }
                ],
                "enableAcceleratedNetworking": "[parameters('enableAcceleratedNetworking')]",
                "networkSecurityGroup": "[if(empty(parameters('networkSecurityGroupId')), json('null'), json(format('{{\"id\": \"{0}\"}}', variables('nsgId'))))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'NSG-linkedTemplate')]"
              ]
            },
            {
              "copy": {
                "name": "vm",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2018-10-01",
              "name": "[concat(parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('virtualMachineTags')]",
              "identity": {
                "type": "[if(parameters('aadJoin'), 'SystemAssigned', 'None')]"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('rdshVmSize')]"
                },
                "availabilitySet": "[if(equals(parameters('availabilityOption'), 'AvailabilitySet'), variables('vmAvailabilitySetResourceId'), json('null'))]",
                "osProfile": {
                  "computerName": "[concat(parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
                  "adminUsername": "[variables('vmAdministratorUsername')]",
                  "adminPassword": "[variables('vmAdministratorPassword')]"
                },
                "storageProfile": {
                  "osDisk": {
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "[variables('storageAccountType')]"
                    }
                  },
                  "imageReference": {
                    "id": "[parameters('rdshImageSourceId')]"
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}{1}-nic', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber'))))]"
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": false
                  }
                },
                "licenseType": "Windows_Client"
              },
              "zones": "[if(equals(parameters('availabilityOption'), 'AvailabilityZone'), array(parameters('availabilityZone')), variables('emptyArray'))]",
              "dependsOn": [
                "nic"
              ]
            },
            {
              "copy": {
                "name": "vm_DSC",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/Microsoft.PowerShell.DSC', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "modulesUrl": "[parameters('artifactsLocation')]",
                  "configurationFunction": "Configuration.ps1\\AddSessionHost",
                  "properties": {
                    "hostPoolName": "[parameters('hostpoolName')]",
                    "registrationInfoToken": "[parameters('hostpoolToken')]",
                    "aadJoin": "[parameters('aadJoin')]"
                  }
                }
              },
              "dependsOn": [
                "vm"
              ]
            },
            {
              "condition": "[and(parameters('aadJoin'), not(parameters('intune')))]",
              "copy": {
                "name": "vm_AADLoginForWindows",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/AADLoginForWindows', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "condition": "[and(parameters('aadJoin'), parameters('intune'))]",
              "copy": {
                "name": "vm_AADLoginForWindowsWithIntune",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/AADLoginForWindowsWithIntune', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "mdmId": "0000000a-0000-0000-c000-000000000000"
                }
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "condition": "[not(parameters('aadJoin'))]",
              "copy": {
                "name": "vm_joindomain",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/joindomain', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "name": "[variables('domain_var')]",
                  "ouPath": "[parameters('ouPath')]",
                  "user": "[parameters('administratorAccountUsername')]",
                  "restart": "true",
                  "options": "3"
                },
                "protectedSettings": {
                  "password": "[parameters('administratorAccountPassword')]"
                }
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "NSG-linkedTemplate",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "createNetworkSecurityGroup": {
                    "value": "[parameters('createNetworkSecurityGroup')]"
                  },
                  "newNsgName": {
                    "value": "[variables('newNsgName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "networkSecurityGroupTags": {
                    "value": "[parameters('networkSecurityGroupTags')]"
                  },
                  "networkSecurityGroupRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "dev",
                      "templateHash": "9768223943364163858"
                    }
                  },
                  "parameters": {
                    "createNetworkSecurityGroup": {
                      "type": "bool"
                    },
                    "newNsgName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "networkSecurityGroupTags": {
                      "type": "object"
                    },
                    "networkSecurityGroupRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[parameters('createNetworkSecurityGroup')]",
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2019-02-01",
                      "name": "[parameters('newNsgName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('networkSecurityGroupTags')]",
                      "properties": {
                        "securityRules": "[parameters('networkSecurityGroupRules')]"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vmResourceGroup')), 'Microsoft.Resources/deployments', 'AVSet-deployment')]"
      ]
    },
    {
      "condition": "[and(and(variables('createVMs'), equals(parameters('vmImageType'), 'Gallery')), parameters('vmUseManagedDisks'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('vmCreation-linkedTemplate-{0}-managedDisks-galleryvm', parameters('deploymentId'))]",
      "resourceGroup": "[parameters('vmResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "artifactsLocation": {
            "value": "[parameters('artifactsLocation')]"
          },
          "availabilityOption": {
            "value": "[parameters('availabilityOption')]"
          },
          "availabilitySetName": {
            "value": "[parameters('availabilitySetName')]"
          },
          "availabilityZone": {
            "value": "[parameters('availabilityZone')]"
          },
          "vmImageVhdUri": {
            "value": "[parameters('vmImageVhdUri')]"
          },
          "storageAccountResourceGroupName": {
            "value": "[parameters('storageAccountResourceGroupName')]"
          },
          "vmGalleryImageOffer": {
            "value": "[parameters('vmGalleryImageOffer')]"
          },
          "vmGalleryImagePublisher": {
            "value": "[parameters('vmGalleryImagePublisher')]"
          },
          "vmGalleryImageSKU": {
            "value": "[parameters('vmGalleryImageSKU')]"
          },
          "rdshPrefix": {
            "value": "[variables('rdshPrefix')]"
          },
          "rdshNumberOfInstances": {
            "value": "[parameters('vmNumberOfInstances')]"
          },
          "rdshVMDiskType": {
            "value": "[parameters('vmDiskType')]"
          },
          "rdshVmSize": {
            "value": "[parameters('vmSize')]"
          },
          "enableAcceleratedNetworking": {
            "value": false
          },
          "vmAdministratorAccountUsername": {
            "value": "[parameters('vmAdministratorAccountUsername')]"
          },
          "vmAdministratorAccountPassword": {
            "value": "[parameters('vmAdministratorAccountPassword')]"
          },
          "administratorAccountUsername": {
            "value": "[parameters('administratorAccountUsername')]"
          },
          "administratorAccountPassword": {
            "value": "[parameters('administratorAccountPassword')]"
          },
          "subnet_id": {
            "value": "[variables('subnet_id')]"
          },
          "vhds": {
            "value": "[variables('vhds')]"
          },
          "rdshImageSourceId": {
            "value": "[parameters('vmCustomImageSourceId')]"
          },
          "location": {
            "value": "[parameters('vmLocation')]"
          },
          "createNetworkSecurityGroup": {
            "value": "[parameters('createNetworkSecurityGroup')]"
          },
          "networkSecurityGroupId": {
            "value": "[parameters('networkSecurityGroupId')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('networkSecurityGroupRules')]"
          },
          "networkInterfaceTags": {
            "value": "[parameters('networkInterfaceTags')]"
          },
          "networkSecurityGroupTags": {
            "value": "[parameters('networkSecurityGroupTags')]"
          },
          "virtualMachineTags": {
            "value": "[parameters('virtualMachineTags')]"
          },
          "imageTags": {
            "value": "[parameters('imageTags')]"
          },
          "hostpoolToken": {
            "value": "[reference(parameters('hostpoolName')).registrationInfo.token]"
          },
          "hostpoolName": {
            "value": "[parameters('hostpoolName')]"
          },
          "domain": {
            "value": "[parameters('domain')]"
          },
          "ouPath": {
            "value": "[parameters('ouPath')]"
          },
          "aadJoin": {
            "value": "[parameters('aadJoin')]"
          },
          "intune": {
            "value": "[parameters('intune')]"
          },
          "guidValue": {
            "value": "[parameters('deploymentId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "dev",
              "templateHash": "3774652722909324444"
            }
          },
          "parameters": {
            "artifactsLocation": {
              "type": "string",
              "defaultValue": "https://raw.githubusercontent.com/Azure/RDS-Templates/master/ARM-wvd-templates/DSC/Configuration.zip",
              "metadata": {
                "description": "The base URI where artifacts required by this template are located."
              }
            },
            "availabilityOption": {
              "type": "string",
              "defaultValue": "None",
              "metadata": {
                "description": "The availability option for the VMs."
              },
              "allowedValues": [
                "None",
                "AvailabilitySet",
                "AvailabilityZone"
              ]
            },
            "availabilitySetName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of avaiability set to be used when create the VMs."
              }
            },
            "availabilityZone": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "The number of availability zone to be used when create the VMs."
              },
              "allowedValues": [
                1,
                2,
                3
              ]
            },
            "vmImageVhdUri": {
              "type": "string",
              "metadata": {
                "description": "URI of the sysprepped image vhd file to be used to create the session host VMs. For example, https://rdsstorage.blob.core.windows.net/vhds/sessionhostimage.vhd"
              }
            },
            "storageAccountResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The storage account containing the custom VHD."
              }
            },
            "vmGalleryImageOffer": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image Offer."
              }
            },
            "vmGalleryImagePublisher": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image Publisher."
              }
            },
            "vmGalleryImageSKU": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "(Required when vmImageType = Gallery) Gallery image SKU."
              }
            },
            "rdshPrefix": {
              "type": "string",
              "defaultValue": "[take(toLower(resourceGroup().name), 10)]",
              "metadata": {
                "description": "This prefix will be used in combination with the VM number to create the VM name. This value includes the dash, so if using “rdsh” as the prefix, VMs would be named “rdsh-0”, “rdsh-1”, etc. You should use a unique prefix to reduce name collisions in Active Directory."
              }
            },
            "rdshNumberOfInstances": {
              "type": "int",
              "metadata": {
                "description": "Number of session hosts that will be created and added to the hostpool."
              }
            },
            "rdshVMDiskType": {
              "type": "string",
              "metadata": {
                "description": "The VM disk type for the VM: HDD or SSD."
              },
              "allowedValues": [
                "Premium_LRS",
                "StandardSSD_LRS",
                "Standard_LRS"
              ]
            },
            "rdshVmSize": {
              "type": "string",
              "defaultValue": "Standard_A2",
              "metadata": {
                "description": "The size of the session host VMs."
              }
            },
            "enableAcceleratedNetworking": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enables Accelerated Networking feature, notice that VM size must support it, this is supported in most of general purpose and compute-optimized instances with 2 or more vCPUs, on instances that supports hyperthreading it is required minimum of 4 vCPUs."
              }
            },
            "administratorAccountUsername": {
              "type": "string",
              "metadata": {
                "description": "The username for the domain admin."
              }
            },
            "administratorAccountPassword": {
              "type": "secureString",
              "metadata": {
                "description": "The password that corresponds to the existing domain username."
              }
            },
            "vmAdministratorAccountUsername": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A username to be used as the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
              }
            },
            "vmAdministratorAccountPassword": {
              "type": "secureString",
              "defaultValue": "",
              "metadata": {
                "description": "The password associated with the virtual machine administrator account. The vmAdministratorAccountUsername and  vmAdministratorAccountPassword parameters must both be provided. Otherwise, domain administrator credentials provided by administratorAccountUsername and administratorAccountPassword will be used."
              }
            },
            "vhds": {
              "type": "string",
              "metadata": {
                "description": "The URL to store unmanaged disks."
              }
            },
            "subnet_id": {
              "type": "string",
              "metadata": {
                "description": "The unique id of the subnet for the nics."
              }
            },
            "rdshImageSourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of the image."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Location for all resources to be created in."
              }
            },
            "createNetworkSecurityGroup": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to create a new network security group or use an existing one"
              }
            },
            "networkSecurityGroupId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource id of an existing network security group"
              }
            },
            "networkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The rules to be given to the new network security group"
              }
            },
            "networkInterfaceTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the network interfaces"
              }
            },
            "networkSecurityGroupTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the network security groups"
              }
            },
            "virtualMachineTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the virtual machines"
              }
            },
            "imageTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to be assigned to the images"
              }
            },
            "vmInitialNumber": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "VM name prefix initial number."
              }
            },
            "guidValue": {
              "type": "string",
              "defaultValue": "[newGuid()]"
            },
            "hostpoolToken": {
              "type": "string",
              "metadata": {
                "description": "The token for adding VMs to the hostpool"
              }
            },
            "hostpoolName": {
              "type": "string",
              "metadata": {
                "description": "The name of the hostpool"
              }
            },
            "ouPath": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "OUPath for the domain join"
              }
            },
            "domain": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Domain to join"
              }
            },
            "aadJoin": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "IMPORTANT: Please don't use this parameter as AAD Join is not supported yet. True if AAD Join, false if AD join"
              }
            },
            "intune": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "IMPORTANT: Please don't use this parameter as intune enrollment is not supported yet. True if intune enrollment is selected.  False otherwise"
              }
            }
          },
          "functions": [],
          "variables": {
            "emptyArray": [],
            "domain_var": "[if(equals(parameters('domain'), ''), last(split(parameters('administratorAccountUsername'), '@')), parameters('domain'))]",
            "storageAccountType": "[parameters('rdshVMDiskType')]",
            "newNsgName": "[format('{0}nsg-{1}', parameters('rdshPrefix'), parameters('guidValue'))]",
            "nsgId": "[if(parameters('createNetworkSecurityGroup'), resourceId('Microsoft.Network/networkSecurityGroups', variables('newNsgName')), parameters('networkSecurityGroupId'))]",
            "isVMAdminAccountCredentialsProvided": "[and(not(equals(parameters('vmAdministratorAccountUsername'), '')), not(equals(parameters('vmAdministratorAccountPassword'), '')))]",
            "vmAdministratorUsername": "[if(variables('isVMAdminAccountCredentialsProvided'), parameters('vmAdministratorAccountUsername'), first(split(parameters('administratorAccountUsername'), '@')))]",
            "vmAdministratorPassword": "[if(variables('isVMAdminAccountCredentialsProvided'), parameters('vmAdministratorAccountPassword'), parameters('administratorAccountPassword'))]",
            "vmAvailabilitySetResourceId": {
              "id": "[resourceId('Microsoft.Compute/availabilitySets/', parameters('availabilitySetName'))]"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "nic",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2018-11-01",
              "name": "[format('{0}{1}-nic', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('networkInterfaceTags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('subnet_id')]"
                      }
                    }
                  }
                ],
                "enableAcceleratedNetworking": "[parameters('enableAcceleratedNetworking')]",
                "networkSecurityGroup": "[if(empty(parameters('networkSecurityGroupId')), json('null'), json(format('{{\"id\": \"{0}\"}}', variables('nsgId'))))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'NSG-linkedTemplate')]"
              ]
            },
            {
              "copy": {
                "name": "vm",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2018-10-01",
              "name": "[concat(parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('virtualMachineTags')]",
              "identity": {
                "type": "[if(parameters('aadJoin'), 'SystemAssigned', 'None')]"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('rdshVmSize')]"
                },
                "availabilitySet": "[if(equals(parameters('availabilityOption'), 'AvailabilitySet'), variables('vmAvailabilitySetResourceId'), json('null'))]",
                "osProfile": {
                  "computerName": "[concat(parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
                  "adminUsername": "[variables('vmAdministratorUsername')]",
                  "adminPassword": "[variables('vmAdministratorPassword')]"
                },
                "storageProfile": {
                  "imageReference": {
                    "publisher": "[parameters('vmGalleryImagePublisher')]",
                    "offer": "[parameters('vmGalleryImageOffer')]",
                    "sku": "[parameters('vmGalleryImageSKU')]",
                    "version": "latest"
                  },
                  "osDisk": {
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "[variables('storageAccountType')]"
                    }
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}{1}-nic', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber'))))]"
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": false
                  }
                },
                "licenseType": "Windows_Client"
              },
              "zones": "[if(equals(parameters('availabilityOption'), 'AvailabilityZone'), array(parameters('availabilityZone')), variables('emptyArray'))]",
              "dependsOn": [
                "nic"
              ]
            },
            {
              "copy": {
                "name": "vm_DSC",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/Microsoft.PowerShell.DSC', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "modulesUrl": "[parameters('artifactsLocation')]",
                  "configurationFunction": "Configuration.ps1\\AddSessionHost",
                  "properties": {
                    "hostPoolName": "[parameters('hostpoolName')]",
                    "registrationInfoToken": "[parameters('hostpoolToken')]",
                    "aadJoin": "[parameters('aadJoin')]"
                  }
                }
              },
              "dependsOn": [
                "vm"
              ]
            },
            {
              "condition": "[and(parameters('aadJoin'), not(parameters('intune')))]",
              "copy": {
                "name": "vm_AADLoginForWindows",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/AADLoginForWindows', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "condition": "[and(parameters('aadJoin'), parameters('intune'))]",
              "copy": {
                "name": "vm_AADLoginForWindowsWithIntune",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/AADLoginForWindowsWithIntune', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "mdmId": "0000000a-0000-0000-c000-000000000000"
                }
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "condition": "[not(parameters('aadJoin'))]",
              "copy": {
                "name": "vm_joindomain",
                "count": "[length(range(0, parameters('rdshNumberOfInstances')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2018-10-01",
              "name": "[format('{0}{1}/joindomain', parameters('rdshPrefix'), add(range(0, parameters('rdshNumberOfInstances'))[copyIndex()], parameters('vmInitialNumber')))]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "name": "[variables('domain_var')]",
                  "ouPath": "[parameters('ouPath')]",
                  "user": "[parameters('administratorAccountUsername')]",
                  "restart": "true",
                  "options": "3"
                },
                "protectedSettings": {
                  "password": "[parameters('administratorAccountPassword')]"
                }
              },
              "dependsOn": [
                "vm_DSC"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "NSG-linkedTemplate",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "createNetworkSecurityGroup": {
                    "value": "[parameters('createNetworkSecurityGroup')]"
                  },
                  "newNsgName": {
                    "value": "[variables('newNsgName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "networkSecurityGroupTags": {
                    "value": "[parameters('networkSecurityGroupTags')]"
                  },
                  "networkSecurityGroupRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "dev",
                      "templateHash": "9768223943364163858"
                    }
                  },
                  "parameters": {
                    "createNetworkSecurityGroup": {
                      "type": "bool"
                    },
                    "newNsgName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "networkSecurityGroupTags": {
                      "type": "object"
                    },
                    "networkSecurityGroupRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[parameters('createNetworkSecurityGroup')]",
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2019-02-01",
                      "name": "[parameters('newNsgName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('networkSecurityGroupTags')]",
                      "properties": {
                        "securityRules": "[parameters('networkSecurityGroupRules')]"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vmResourceGroup')), 'Microsoft.Resources/deployments', 'AVSet-deployment')]"
      ]
    }
  ],
  "outputs": {
    "rdshVmNamesObject": {
      "type": "array",
      "value": "[variables('rdshVmNamesOutput')]"
    }
  }
}