{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.19.5.34762",
      "templateHash": "1525929317396632830"
    }
  },
  "parameters": {
    "networkFabricName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Network Fabric"
      }
    },
    "networkToNetworkInterconnectName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Network To Network Interconnect"
      }
    },
    "nniType": {
      "type": "string",
      "defaultValue": "CE",
      "allowedValues": [
        "CE",
        "NPB"
      ],
      "metadata": {
        "description": "Type of NNI used"
      }
    },
    "isManagementType": {
      "type": "string",
      "defaultValue": "True",
      "allowedValues": [
        "True",
        "False"
      ],
      "metadata": {
        "description": "Configuration to use NNI for Infrastructure Management"
      }
    },
    "useOptionB": {
      "type": "string",
      "allowedValues": [
        "True",
        "False"
      ],
      "metadata": {
        "description": "Based on this parameter the layer2/layer3 is made as mandatory"
      }
    },
    "layer2Configuration": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Common properties for Layer2Configuration"
      }
    },
    "optionBLayer3Configuration": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Common properties for optionBLayer3Configuration"
      }
    },
    "npbStaticRouteConfiguration": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "NPB Static Route Configuration properties"
      }
    },
    "importRoutePolicy": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Import Route Policy configuration"
      }
    },
    "exportRoutePolicy": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Export Route Policy configuration"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.ManagedNetworkFabric/networkFabrics/networkToNetworkInterconnects",
      "apiVersion": "2023-06-15",
      "name": "[format('{0}/{1}', parameters('networkFabricName'), parameters('networkToNetworkInterconnectName'))]",
      "properties": {
        "nniType": "[parameters('nniType')]",
        "isManagementType": "[parameters('isManagementType')]",
        "useOptionB": "[parameters('useOptionB')]",
        "layer2Configuration": "[if(not(empty(parameters('layer2Configuration'))), createObject('interfaces', if(contains(parameters('layer2Configuration'), 'interfaces'), parameters('layer2Configuration').interfaces, null()), 'mtu', if(contains(parameters('layer2Configuration'), 'mtu'), parameters('layer2Configuration').mtu, null())), null())]",
        "optionBLayer3Configuration": "[if(not(empty(parameters('optionBLayer3Configuration'))), createObject('peerASN', parameters('optionBLayer3Configuration').peerASN, 'vlanId', parameters('optionBLayer3Configuration').vlanId, 'primaryIpv4Prefix', if(contains(parameters('optionBLayer3Configuration'), 'primaryIpv4Prefix'), parameters('optionBLayer3Configuration').primaryIpv4Prefix, null()), 'primaryIpv6Prefix', if(contains(parameters('optionBLayer3Configuration'), 'primaryIpv6Prefix'), parameters('optionBLayer3Configuration').primaryIpv6Prefix, null()), 'secondaryIpv4Prefix', if(contains(parameters('optionBLayer3Configuration'), 'secondaryIpv4Prefix'), parameters('optionBLayer3Configuration').secondaryIpv4Prefix, null()), 'secondaryIpv6Prefix', if(contains(parameters('optionBLayer3Configuration'), 'secondaryIpv6Prefix'), parameters('optionBLayer3Configuration').secondaryIpv6Prefix, null())), null())]",
        "importRoutePolicy": "[if(not(empty(parameters('importRoutePolicy'))), createObject('importIpv4RoutePolicyId', if(contains(parameters('importRoutePolicy'), 'importIpv4RoutePolicyId'), parameters('importRoutePolicy').importIpv4RoutePolicyId, null()), 'importIpv6RoutePolicyId', if(contains(parameters('importRoutePolicy'), 'importIpv6RoutePolicyId'), parameters('importRoutePolicy').importIpv6RoutePolicyId, null())), null())]",
        "exportRoutePolicy": "[if(not(empty(parameters('exportRoutePolicy'))), createObject('exportIpv4RoutePolicyId', if(contains(parameters('exportRoutePolicy'), 'exportIpv4RoutePolicyId'), parameters('exportRoutePolicy').exportIpv4RoutePolicyId, null()), 'exportIpv6RoutePolicyId', if(contains(parameters('exportRoutePolicy'), 'exportIpv6RoutePolicyId'), parameters('exportRoutePolicy').exportIpv6RoutePolicyId, null())), null())]"
      }
    }
  ]
}