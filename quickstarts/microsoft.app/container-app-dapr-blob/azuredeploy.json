{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.11.1.770",
      "templateHash": "12349458310726309764"
    }
  },
  "parameters": {
    "clientAppName": {
      "type": "string",
      "defaultValue": "app-py-generate",
      "metadata": {
        "description": "Specifies the name of the client container app."
      }
    },
    "serviceAppName": {
      "type": "string",
      "defaultValue": "app-node-consume",
      "metadata": {
        "description": "Specifies the name of the service container app."
      }
    },
    "containerAppEnvName": {
      "type": "string",
      "defaultValue": "[format('env-{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Specifies the name of the container app environment."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Specifies the location for all resources."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[parameters('containerAppEnvName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "nameseed": {
            "value": "stateapp"
          },
          "applicationEntityName": {
            "value": "appdata"
          },
          "daprComponentType": {
            "value": "state.azure.blobstorage"
          },
          "daprComponentScopes": {
            "value": [
              "[parameters('serviceAppName')]"
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "17061185190568727130"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Specifies the location for all resources."
              }
            },
            "nameseed": {
              "type": "string",
              "metadata": {
                "description": "Used to name the Azure resources that are created"
              }
            },
            "environmentAlreadyExists": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Indicates if we should deploy the Dapr components to an existing environment"
              }
            },
            "containerAppEnvName": {
              "type": "string",
              "defaultValue": "[format('env-{0}', parameters('nameseed'))]",
              "metadata": {
                "description": "Specifies the name of the container app environment."
              }
            },
            "applicationEntityName": {
              "type": "string",
              "defaultValue": "[parameters('nameseed')]",
              "metadata": {
                "description": "The application relevant name for the dapr component you are implementing"
              },
              "maxLength": 8
            },
            "daprComponentType": {
              "type": "string",
              "metadata": {
                "description": "The dapr application component type to configure in the Environment"
              },
              "allowedValues": [
                "pubsub.azure.servicebus",
                "state.azure.blobstorage",
                "state.azure.cosmosdb"
              ]
            },
            "daprComponentName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of the dapr component, this will be autogenerated if not provided"
              }
            },
            "daprComponentScopes": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Names of container apps that can use this dapr component"
              }
            },
            "infrastructureSubnetId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "For deploying in your own Virtual Network, provide the Infrastructure Subnet Id"
              }
            },
            "zoneRedundant": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Zone Redundant (needs infrastructureSubnetId)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Any tags that are to be applied to the Environment Components"
              }
            }
          },
          "variables": {
            "autoDaprComponentNameMap": {
              "pubsub.azure.servicebus": "[format('{0}pubsub', toLower(parameters('applicationEntityName')))]",
              "state.azure.blobstorage": "[format('{0}statestore', toLower(parameters('applicationEntityName')))]",
              "state.azure.cosmosdb": "[format('{0}statestore', toLower(parameters('applicationEntityName')))]"
            },
            "autoDaprComponentName": "[if(empty(parameters('daprComponentName')), variables('autoDaprComponentNameMap')[parameters('daprComponentType')], parameters('daprComponentName'))]"
          },
          "resources": [
            {
              "condition": "[not(parameters('environmentAlreadyExists'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('containerAppEnv-{0}', parameters('nameseed'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "nameseed": {
                    "value": "[parameters('nameseed')]"
                  },
                  "infraSubnetId": {
                    "value": "[parameters('infrastructureSubnetId')]"
                  },
                  "zoneRedundant": {
                    "value": "[parameters('zoneRedundant')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "15032274980026305573"
                    }
                  },
                  "parameters": {
                    "nameseed": {
                      "type": "string"
                    },
                    "containerAppEnvName": {
                      "type": "string",
                      "defaultValue": "[format('env-{0}', parameters('nameseed'))]",
                      "metadata": {
                        "description": "Specifies the name of the container app environment."
                      }
                    },
                    "containerAppLogAnalyticsName": {
                      "type": "string",
                      "defaultValue": "[format('log-{0}', parameters('nameseed'))]",
                      "metadata": {
                        "description": "Specifies the name of the log analytics workspace."
                      }
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "Consumption",
                      "allowedValues": [
                        "Consumption",
                        "Premium"
                      ]
                    },
                    "zoneRedundant": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "logRetentionDays": {
                      "type": "int",
                      "defaultValue": 30
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the location for all resources."
                      }
                    },
                    "infraSubnetId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "runtimeSubnetId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "internalVirtualIp": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Sets the environment to only have a internal load balancer"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.App/managedEnvironments",
                      "apiVersion": "2022-06-01-preview",
                      "name": "[parameters('containerAppEnvName')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "[parameters('sku')]"
                      },
                      "properties": {
                        "zoneRedundant": "[parameters('zoneRedundant')]",
                        "appLogsConfiguration": {
                          "destination": "log-analytics",
                          "logAnalyticsConfiguration": {
                            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('containerAppLogAnalyticsName'))).customerId]",
                            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('containerAppLogAnalyticsName')), '2022-10-01').primarySharedKey]"
                          }
                        },
                        "vnetConfiguration": {
                          "infrastructureSubnetId": "[parameters('infraSubnetId')]",
                          "runtimeSubnetId": "[parameters('runtimeSubnetId')]",
                          "internal": "[parameters('internalVirtualIp')]"
                        },
                        "daprAIInstrumentationKey": "[reference(resourceId('Microsoft.Resources/deployments', format('appInsights-{0}', parameters('nameseed')))).outputs.instrumentationKey.value]"
                      },
                      "tags": "[parameters('tags')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', format('appInsights-{0}', parameters('nameseed')))]",
                        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('containerAppLogAnalyticsName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2022-10-01",
                      "name": "[parameters('containerAppLogAnalyticsName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "name": "PerGB2018"
                        },
                        "retentionInDays": "[parameters('logRetentionDays')]"
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('appInsights-{0}', parameters('nameseed'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsId": {
                            "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('containerAppLogAnalyticsName'))]"
                          },
                          "nameseed": {
                            "value": "[parameters('nameseed')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "12893374766320771628"
                            }
                          },
                          "parameters": {
                            "nameseed": {
                              "type": "string"
                            },
                            "logAnalyticsId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/components",
                              "apiVersion": "2020-02-02",
                              "name": "[format('ai-{0}', parameters('nameseed'))]",
                              "location": "[parameters('location')]",
                              "kind": "web",
                              "properties": {
                                "Application_Type": "web",
                                "WorkspaceResourceId": "[parameters('logAnalyticsId')]",
                                "IngestionMode": "LogAnalytics"
                              }
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Insights/components', format('ai-{0}', parameters('nameseed')))]"
                            },
                            "name": {
                              "type": "string",
                              "value": "[format('ai-{0}', parameters('nameseed'))]"
                            },
                            "instrumentationKey": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Insights/components', format('ai-{0}', parameters('nameseed')))).InstrumentationKey]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('containerAppLogAnalyticsName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "containerAppEnvironmentName": {
                      "type": "string",
                      "value": "[parameters('containerAppEnvName')]"
                    },
                    "logAnalyticsName": {
                      "type": "string",
                      "value": "[parameters('containerAppLogAnalyticsName')]"
                    },
                    "logAnalyticsId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('containerAppLogAnalyticsName'))]"
                    },
                    "appInsightsInstrumentationKey": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('appInsights-{0}', parameters('nameseed')))).outputs.instrumentationKey.value]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[equals(parameters('daprComponentType'), 'pubsub.azure.servicebus')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('dapr-sb-{0}', parameters('nameseed'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "componentName": {
                    "value": "[variables('autoDaprComponentName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "containerAppEnvName": {
                    "value": "[if(parameters('environmentAlreadyExists'), parameters('containerAppEnvName'), reference(resourceId('Microsoft.Resources/deployments', format('containerAppEnv-{0}', parameters('nameseed'))), '2020-10-01').outputs.containerAppEnvironmentName.value)]"
                  },
                  "entityName": {
                    "value": "[parameters('applicationEntityName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "1490041037123059482"
                    }
                  },
                  "parameters": {
                    "componentName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "entityName": {
                      "type": "string"
                    },
                    "containerAppEnvName": {
                      "type": "string"
                    },
                    "createAzureServiceForComponent": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "scopes": {
                      "type": "array",
                      "defaultValue": []
                    }
                  },
                  "variables": {
                    "daprComponent": "pubsub.azure.servicebus",
                    "serviceBusConnectionStringName": "sb-root-connectionstring"
                  },
                  "resources": [
                    {
                      "condition": "[parameters('createAzureServiceForComponent')]",
                      "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
                      "apiVersion": "2021-11-01",
                      "name": "[format('{0}/{1}/{2}', format('sb-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))), parameters('entityName'), parameters('entityName'))]",
                      "properties": {
                        "deadLetteringOnFilterEvaluationExceptions": true,
                        "deadLetteringOnMessageExpiration": true,
                        "maxDeliveryCount": 10
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces/topics', format('sb-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))), parameters('entityName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('createAzureServiceForComponent')]",
                      "type": "Microsoft.ServiceBus/namespaces/topics",
                      "apiVersion": "2021-11-01",
                      "name": "[format('{0}/{1}', format('sb-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))), parameters('entityName'))]",
                      "properties": {
                        "supportOrdering": true
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces', format('sb-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.App/managedEnvironments/daprComponents",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('containerAppEnvName'), parameters('componentName'))]",
                      "properties": {
                        "componentType": "[variables('daprComponent')]",
                        "version": "v1",
                        "secrets": [
                          {
                            "name": "[variables('serviceBusConnectionStringName')]",
                            "value": "[format('{0};EntityPath={1}', listKeys(resourceId('Microsoft.ServiceBus/namespaces/AuthorizationRules', format('sb-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))), 'RootManageSharedAccessKey'), '2021-11-01').primaryConnectionString, parameters('entityName'))]"
                          }
                        ],
                        "metadata": [
                          {
                            "name": "connectionString",
                            "secretRef": "[variables('serviceBusConnectionStringName')]"
                          },
                          {
                            "name": "consumerID",
                            "value": "[parameters('entityName')]"
                          }
                        ],
                        "scopes": "[parameters('scopes')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces', format('sb-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))))]"
                      ]
                    },
                    {
                      "condition": "[parameters('createAzureServiceForComponent')]",
                      "type": "Microsoft.ServiceBus/namespaces",
                      "apiVersion": "2021-11-01",
                      "name": "[format('sb-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location')))]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Standard",
                        "tier": "Standard"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('containerAppEnv-{0}', parameters('nameseed')))]"
              ]
            },
            {
              "condition": "[equals(parameters('daprComponentType'), 'state.azure.blobstorage')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('dapr-state-stor-{0}', parameters('nameseed'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[variables('autoDaprComponentName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "containerAppEnvName": {
                    "value": "[if(parameters('environmentAlreadyExists'), parameters('containerAppEnvName'), reference(resourceId('Microsoft.Resources/deployments', format('containerAppEnv-{0}', parameters('nameseed'))), '2020-10-01').outputs.containerAppEnvironmentName.value)]"
                  },
                  "entityName": {
                    "value": "[parameters('applicationEntityName')]"
                  },
                  "scopes": {
                    "value": "[parameters('daprComponentScopes')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "5324293688587926095"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "entityName": {
                      "type": "string"
                    },
                    "containerAppEnvName": {
                      "type": "string"
                    },
                    "createAzureServiceForComponent": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "scopes": {
                      "type": "array",
                      "defaultValue": []
                    }
                  },
                  "variables": {
                    "daprComponent": "state.azure.blobstorage",
                    "rawStorageAccountName": "[format('st{0}{1}', parameters('name'), uniqueString(resourceGroup().id, parameters('name')))]",
                    "storageAccountName": "[if(greater(length(variables('rawStorageAccountName')), 24), substring(toLower(variables('rawStorageAccountName')), 0, 24), variables('rawStorageAccountName'))]"
                  },
                  "resources": [
                    {
                      "condition": "[and(parameters('createAzureServiceForComponent'), equals(variables('daprComponent'), 'state.azure.blobstorage'))]",
                      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                      "apiVersion": "2021-09-01",
                      "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', toLower(parameters('entityName')))]",
                      "properties": {
                        "publicAccess": "None"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('createAzureServiceForComponent'), equals(variables('daprComponent'), 'state.azure.blobstorage'))]",
                      "type": "Microsoft.Storage/storageAccounts/blobServices",
                      "apiVersion": "2021-09-01",
                      "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
                      ]
                    },
                    {
                      "condition": "[equals(variables('daprComponent'), 'state.azure.blobstorage')]",
                      "type": "Microsoft.App/managedEnvironments/daprComponents",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('containerAppEnvName'), format('{0}-state', parameters('name')))]",
                      "properties": {
                        "componentType": "[variables('daprComponent')]",
                        "version": "v1",
                        "secrets": [
                          {
                            "name": "storageaccountkey",
                            "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-09-01').keys[0].value]"
                          }
                        ],
                        "metadata": [
                          {
                            "name": "accountKey",
                            "secretRef": "storageaccountkey"
                          },
                          {
                            "name": "accountName",
                            "value": "[variables('storageAccountName')]"
                          },
                          {
                            "name": "containerName",
                            "value": "[parameters('entityName')]"
                          }
                        ],
                        "scopes": "[parameters('scopes')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
                      ]
                    },
                    {
                      "condition": "[and(parameters('createAzureServiceForComponent'), equals(variables('daprComponent'), 'state.azure.blobstorage'))]",
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2021-09-01",
                      "name": "[variables('storageAccountName')]",
                      "kind": "StorageV2",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Standard_LRS"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('containerAppEnv-{0}', parameters('nameseed')))]"
              ]
            },
            {
              "condition": "[equals(parameters('daprComponentType'), 'state.azure.cosmosdb')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('dapr-state-cosmos-{0}', parameters('nameseed'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "containerAppEnvName": {
                    "value": "[if(parameters('environmentAlreadyExists'), parameters('containerAppEnvName'), reference(resourceId('Microsoft.Resources/deployments', format('containerAppEnv-{0}', parameters('nameseed'))), '2020-10-01').outputs.containerAppEnvironmentName.value)]"
                  },
                  "componentName": {
                    "value": "[variables('autoDaprComponentName')]"
                  },
                  "entityName": {
                    "value": "[parameters('applicationEntityName')]"
                  },
                  "scopes": {
                    "value": "[parameters('daprComponentScopes')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "997573331547175945"
                    }
                  },
                  "parameters": {
                    "componentName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "entityName": {
                      "type": "string"
                    },
                    "containerAppEnvName": {
                      "type": "string"
                    },
                    "createAzureServiceForComponent": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "scopes": {
                      "type": "array",
                      "defaultValue": []
                    }
                  },
                  "variables": {
                    "daprComponent": "state.azure.cosmosdb",
                    "databaseKeyName": "masterkey",
                    "databaseName": "[format('{0}Db', parameters('entityName'))]",
                    "databaseLocations": [
                      {
                        "locationName": "[parameters('location')]",
                        "failoverPriority": 0,
                        "isZoneRedundant": false
                      }
                    ]
                  },
                  "resources": [
                    {
                      "condition": "[parameters('createAzureServiceForComponent')]",
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
                      "apiVersion": "2022-05-15",
                      "name": "[format('{0}/{1}/{2}', format('cosmos-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))), variables('databaseName'), parameters('entityName'))]",
                      "properties": {
                        "resource": {
                          "id": "[parameters('entityName')]",
                          "partitionKey": {
                            "paths": [
                              "/partitionKey"
                            ],
                            "kind": "Hash"
                          }
                        },
                        "options": {
                          "autoscaleSettings": {
                            "maxThroughput": 4000
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', format('cosmos-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))), variables('databaseName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('createAzureServiceForComponent')]",
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
                      "apiVersion": "2022-05-15",
                      "name": "[format('{0}/{1}', format('cosmos-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))), variables('databaseName'))]",
                      "properties": {
                        "resource": {
                          "id": "[variables('databaseName')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))))]"
                      ]
                    },
                    {
                      "type": "Microsoft.App/managedEnvironments/daprComponents",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('containerAppEnvName'), parameters('componentName'))]",
                      "properties": {
                        "componentType": "[variables('daprComponent')]",
                        "version": "v1",
                        "secrets": [
                          {
                            "name": "[variables('databaseKeyName')]",
                            "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location')))), '2022-05-15').primaryMasterKey]"
                          }
                        ],
                        "metadata": [
                          {
                            "name": "url",
                            "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location')))), '2022-05-15').documentEndpoint]"
                          },
                          {
                            "name": "database",
                            "value": "[variables('databaseName')]"
                          },
                          {
                            "name": "collection",
                            "value": "[parameters('entityName')]"
                          },
                          {
                            "name": "[variables('databaseKeyName')]",
                            "secretRef": "[variables('databaseKeyName')]"
                          }
                        ],
                        "scopes": "[parameters('scopes')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location'))))]"
                      ]
                    },
                    {
                      "condition": "[parameters('createAzureServiceForComponent')]",
                      "type": "Microsoft.DocumentDB/databaseAccounts",
                      "apiVersion": "2022-05-15",
                      "name": "[format('cosmos-{0}-{1}', parameters('componentName'), uniqueString(resourceGroup().id, parameters('location')))]",
                      "kind": "GlobalDocumentDB",
                      "location": "[parameters('location')]",
                      "properties": {
                        "consistencyPolicy": {
                          "defaultConsistencyLevel": "Session"
                        },
                        "locations": "[variables('databaseLocations')]",
                        "databaseAccountOfferType": "Standard"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('containerAppEnv-{0}', parameters('nameseed')))]"
              ]
            }
          ],
          "outputs": {
            "containerAppEnvironmentName": {
              "type": "string",
              "value": "[if(parameters('environmentAlreadyExists'), parameters('containerAppEnvName'), reference(resourceId('Microsoft.Resources/deployments', format('containerAppEnv-{0}', parameters('nameseed'))), '2020-10-01').outputs.containerAppEnvironmentName.value)]",
              "metadata": {
                "description": "The name of the created Azure Container Apps Environment"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "value": "[if(parameters('environmentAlreadyExists'), '', reference(resourceId('Microsoft.Resources/deployments', format('containerAppEnv-{0}', parameters('nameseed'))), '2020-10-01').outputs.appInsightsInstrumentationKey.value)]",
              "metadata": {
                "description": "The Azure Applications Insights (telemetry) instrumentation key"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "stateNodeApp",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "containerAppName": {
            "value": "[parameters('serviceAppName')]"
          },
          "containerAppEnvName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', parameters('containerAppEnvName'))).outputs.containerAppEnvironmentName.value]"
          },
          "containerImage": {
            "value": "ghcr.io/dapr/samples/hello-k8s-node:latest"
          },
          "targetPort": {
            "value": 3000
          },
          "externalIngress": {
            "value": false
          },
          "createUserManagedId": {
            "value": false
          },
          "environmentVariables": {
            "value": [
              {
                "name": "APP_PORT",
                "value": "3000"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "18066693510890011191"
            }
          },
          "parameters": {
            "containerAppName": {
              "type": "string",
              "defaultValue": "[format('containerapp-{0}', uniqueString(resourceGroup().id))]",
              "metadata": {
                "description": "Specifies the name of the container app."
              }
            },
            "containerAppEnvName": {
              "type": "string",
              "metadata": {
                "description": "Specifies the name of the container app environment to target, must be in the same resourceGroup."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Specifies the location for all resources."
              }
            },
            "containerImage": {
              "type": "string",
              "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "metadata": {
                "description": "Specifies the docker container image to deploy."
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 80,
              "metadata": {
                "description": "Specifies the container port."
              }
            },
            "daprAppPort": {
              "type": "int",
              "defaultValue": "[parameters('targetPort')]",
              "metadata": {
                "description": "Specifies the dapr app port."
              }
            },
            "daprAppProtocol": {
              "type": "string",
              "defaultValue": "http",
              "metadata": {
                "description": "Tells Dapr which protocol your application is using. Valid options are http and grpc. Default is http"
              },
              "allowedValues": [
                "http",
                "grpc",
                ""
              ]
            },
            "revisionMode": {
              "type": "string",
              "defaultValue": "Single",
              "metadata": {
                "description": "Controls how active revisions are handled for the Container app"
              },
              "allowedValues": [
                "Single",
                "Multiple"
              ]
            },
            "cpuCore": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "Number of CPU cores the container can use. Can be with a maximum of two decimals places. Max of 2.0. Valid values include, 0.5 1.25 1.4"
              }
            },
            "memorySize": {
              "type": "string",
              "defaultValue": "1",
              "metadata": {
                "description": "Amount of memory (in gibibytes, GiB) allocated to the container up to 4GiB. Can be with a maximum of two decimals. Ratio with CPU cores must be equal to 2."
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "maxValue": 25,
              "minValue": 0,
              "metadata": {
                "description": "Minimum number of replicas that will be deployed"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "maxValue": 25,
              "minValue": 0,
              "metadata": {
                "description": "Maximum number of replicas that will be deployed"
              }
            },
            "externalIngress": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Should the app be exposed on an external endpoint"
              }
            },
            "enableIngress": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Does the app expect traffic, or should it operate headless"
              }
            },
            "revisionSuffix": {
              "type": "string",
              "defaultValue": "[uniqueString(utcNow())]",
              "metadata": {
                "description": "Revisions to the container app need to be unique"
              }
            },
            "environmentVariables": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Any environment variables that your container needs"
              }
            },
            "azureContainerRegistry": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "An ACR name can be optionally passed if thats where the container app image is homed"
              }
            },
            "createUserManagedId": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Will create a user managed identity for the application to access other Azure resoruces as"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Any tags that are to be applied to the Container App"
              }
            }
          },
          "resources": [
            {
              "condition": "[empty(parameters('azureContainerRegistry'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[parameters('containerAppName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "containerAppEnvName": {
                    "value": "[parameters('containerAppEnvName')]"
                  },
                  "containerAppName": {
                    "value": "[parameters('containerAppName')]"
                  },
                  "containerImage": {
                    "value": "[parameters('containerImage')]"
                  },
                  "cpuCore": {
                    "value": "[parameters('cpuCore')]"
                  },
                  "createUserManagedId": {
                    "value": "[parameters('createUserManagedId')]"
                  },
                  "daprAppPort": {
                    "value": "[parameters('daprAppPort')]"
                  },
                  "daprAppProtocol": {
                    "value": "[parameters('daprAppProtocol')]"
                  },
                  "enableIngress": {
                    "value": "[parameters('enableIngress')]"
                  },
                  "environmentVariables": {
                    "value": "[parameters('environmentVariables')]"
                  },
                  "externalIngress": {
                    "value": "[parameters('externalIngress')]"
                  },
                  "maxReplicas": {
                    "value": "[parameters('maxReplicas')]"
                  },
                  "memorySize": {
                    "value": "[parameters('memorySize')]"
                  },
                  "minReplicas": {
                    "value": "[parameters('minReplicas')]"
                  },
                  "revisionMode": {
                    "value": "[parameters('revisionMode')]"
                  },
                  "revisionSuffix": {
                    "value": "[parameters('revisionSuffix')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "targetPort": {
                    "value": "[parameters('targetPort')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "7009689267588982199"
                    }
                  },
                  "parameters": {
                    "containerAppName": {
                      "type": "string",
                      "defaultValue": "[format('containerapp-{0}', uniqueString(resourceGroup().id))]",
                      "metadata": {
                        "description": "Specifies the name of the container app."
                      }
                    },
                    "containerAppEnvName": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the name of the container app environment to target, must be in the same resourceGroup."
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the location for all resources."
                      }
                    },
                    "containerImage": {
                      "type": "string",
                      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
                      "metadata": {
                        "description": "Specifies the docker container image to deploy."
                      }
                    },
                    "targetPort": {
                      "type": "int",
                      "defaultValue": 80,
                      "metadata": {
                        "description": "Specifies the container port."
                      }
                    },
                    "daprAppPort": {
                      "type": "int",
                      "defaultValue": "[parameters('targetPort')]",
                      "metadata": {
                        "description": "Specifies the dapr app port."
                      }
                    },
                    "daprAppProtocol": {
                      "type": "string",
                      "defaultValue": "http",
                      "metadata": {
                        "description": "Tells Dapr which protocol your application is using. Valid options are http and grpc. Default is http"
                      },
                      "allowedValues": [
                        "http",
                        "grpc",
                        ""
                      ]
                    },
                    "revisionMode": {
                      "type": "string",
                      "defaultValue": "Single",
                      "metadata": {
                        "description": "Controls how active revisions are handled for the Container app"
                      },
                      "allowedValues": [
                        "Single",
                        "Multiple"
                      ]
                    },
                    "cpuCore": {
                      "type": "string",
                      "defaultValue": "0.5",
                      "metadata": {
                        "description": "Number of CPU cores the container can use. Can be with a maximum of two decimals places. Max of 2.0. Valid values include, 0.5 1.25 1.4"
                      }
                    },
                    "memorySize": {
                      "type": "string",
                      "defaultValue": "1",
                      "metadata": {
                        "description": "Amount of memory (in gibibytes, GiB) allocated to the container up to 4GiB. Can be with a maximum of two decimals. Ratio with CPU cores must be equal to 2."
                      }
                    },
                    "minReplicas": {
                      "type": "int",
                      "defaultValue": 1,
                      "maxValue": 25,
                      "minValue": 0,
                      "metadata": {
                        "description": "Minimum number of replicas that will be deployed"
                      }
                    },
                    "maxReplicas": {
                      "type": "int",
                      "defaultValue": 3,
                      "maxValue": 25,
                      "minValue": 0,
                      "metadata": {
                        "description": "Maximum number of replicas that will be deployed"
                      }
                    },
                    "externalIngress": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Should the app be exposed on an external endpoint"
                      }
                    },
                    "enableIngress": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Does the app expect traffic, or should it operate headless"
                      }
                    },
                    "revisionSuffix": {
                      "type": "string",
                      "defaultValue": "[uniqueString(utcNow())]",
                      "metadata": {
                        "description": "Revisions to the container app need to be unique"
                      }
                    },
                    "environmentVariables": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Any environment variables that your container needs"
                      }
                    },
                    "createUserManagedId": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Will create a user managed identity for the application to access other Azure resoruces as"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Any tags that are to be applied to the Container App"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.App/containerApps",
                      "apiVersion": "2022-06-01-preview",
                      "name": "[parameters('containerAppName')]",
                      "location": "[parameters('location')]",
                      "identity": "[if(parameters('createUserManagedId'), createObject('type', 'UserAssigned', 'userAssignedIdentities', createObject(format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))), createObject())), createObject('type', 'None'))]",
                      "properties": {
                        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppEnvName'))]",
                        "configuration": {
                          "ingress": "[if(parameters('enableIngress'), createObject('external', parameters('externalIngress'), 'targetPort', parameters('targetPort'), 'allowInsecure', false(), 'traffic', createArray(createObject('latestRevision', true(), 'weight', 100))), null())]",
                          "dapr": {
                            "appId": "[parameters('containerAppName')]",
                            "appProtocol": "[if(not(empty(parameters('daprAppProtocol'))), parameters('daprAppProtocol'), null())]",
                            "appPort": "[if(equals(parameters('enableIngress'), true()), parameters('daprAppPort'), null())]",
                            "enabled": true
                          },
                          "activeRevisionsMode": "[parameters('revisionMode')]"
                        },
                        "template": {
                          "revisionSuffix": "[parameters('revisionSuffix')]",
                          "containers": [
                            {
                              "name": "[parameters('containerAppName')]",
                              "image": "[parameters('containerImage')]",
                              "resources": {
                                "cpu": "[json(parameters('cpuCore'))]",
                                "memory": "[format('{0}Gi', parameters('memorySize'))]"
                              },
                              "env": "[parameters('environmentVariables')]"
                            }
                          ],
                          "scale": {
                            "minReplicas": "[parameters('minReplicas')]",
                            "maxReplicas": "[parameters('maxReplicas')]"
                          }
                        }
                      },
                      "tags": "[parameters('tags')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('createUserManagedId')]",
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2022-01-31-preview",
                      "name": "[format('id-{0}', parameters('containerAppName'))]",
                      "location": "[parameters('location')]"
                    }
                  ],
                  "outputs": {
                    "containerAppFQDN": {
                      "type": "string",
                      "value": "[if(parameters('enableIngress'), reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName'))).configuration.ingress.fqdn, '')]",
                      "metadata": {
                        "description": "If ingress is enabled, this is the FQDN that the Container App is exposed on"
                      }
                    },
                    "userAssignedIdPrincipalId": {
                      "type": "string",
                      "value": "[if(parameters('createUserManagedId'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), '2022-01-31-preview').principalId, '')]",
                      "metadata": {
                        "description": "The Principal Id of the Container Apps Managed Identity"
                      }
                    }
                  }
                }
              }
            },
            {
              "condition": "[not(empty(parameters('azureContainerRegistry')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-acr', parameters('containerAppName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "containerAppEnvName": {
                    "value": "[parameters('containerAppEnvName')]"
                  },
                  "azureContainerRegistry": {
                    "value": "[parameters('azureContainerRegistry')]"
                  },
                  "containerAppName": {
                    "value": "[parameters('containerAppName')]"
                  },
                  "containerImage": {
                    "value": "[parameters('containerImage')]"
                  },
                  "cpuCore": {
                    "value": "[parameters('cpuCore')]"
                  },
                  "createUserManagedId": {
                    "value": "[parameters('createUserManagedId')]"
                  },
                  "daprAppPort": {
                    "value": "[parameters('daprAppPort')]"
                  },
                  "daprAppProtocol": {
                    "value": "[parameters('daprAppProtocol')]"
                  },
                  "enableIngress": {
                    "value": "[parameters('enableIngress')]"
                  },
                  "environmentVariables": {
                    "value": "[parameters('environmentVariables')]"
                  },
                  "externalIngress": {
                    "value": "[parameters('externalIngress')]"
                  },
                  "maxReplicas": {
                    "value": "[parameters('maxReplicas')]"
                  },
                  "memorySize": {
                    "value": "[parameters('memorySize')]"
                  },
                  "minReplicas": {
                    "value": "[parameters('minReplicas')]"
                  },
                  "revisionMode": {
                    "value": "[parameters('revisionMode')]"
                  },
                  "revisionSuffix": {
                    "value": "[parameters('revisionSuffix')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "targetPort": {
                    "value": "[parameters('targetPort')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "1021504825763956878"
                    }
                  },
                  "parameters": {
                    "containerAppName": {
                      "type": "string",
                      "defaultValue": "[format('containerapp-{0}', uniqueString(resourceGroup().id))]",
                      "metadata": {
                        "description": "Specifies the name of the container app."
                      }
                    },
                    "containerAppEnvName": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the name of the container app environment to target, must be in the same resourceGroup."
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the location for all resources."
                      }
                    },
                    "containerImage": {
                      "type": "string",
                      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
                      "metadata": {
                        "description": "Specifies the docker container image to deploy."
                      }
                    },
                    "targetPort": {
                      "type": "int",
                      "defaultValue": 80,
                      "metadata": {
                        "description": "Specifies the container port."
                      }
                    },
                    "daprAppPort": {
                      "type": "int",
                      "defaultValue": "[parameters('targetPort')]",
                      "metadata": {
                        "description": "Specifies the dapr app port."
                      }
                    },
                    "daprAppProtocol": {
                      "type": "string",
                      "defaultValue": "http",
                      "metadata": {
                        "description": "Tells Dapr which protocol your application is using. Valid options are http and grpc. Default is http"
                      },
                      "allowedValues": [
                        "http",
                        "grpc",
                        ""
                      ]
                    },
                    "revisionMode": {
                      "type": "string",
                      "defaultValue": "Single",
                      "metadata": {
                        "description": "Controls how active revisions are handled for the Container app"
                      },
                      "allowedValues": [
                        "Single",
                        "Multiple"
                      ]
                    },
                    "cpuCore": {
                      "type": "string",
                      "defaultValue": "0.5",
                      "metadata": {
                        "description": "Number of CPU cores the container can use. Can be with a maximum of two decimals places. Max of 2.0. Valid values include, 0.5 1.25 1.4"
                      }
                    },
                    "memorySize": {
                      "type": "string",
                      "defaultValue": "1",
                      "metadata": {
                        "description": "Amount of memory (in gibibytes, GiB) allocated to the container up to 4GiB. Can be with a maximum of two decimals. Ratio with CPU cores must be equal to 2."
                      }
                    },
                    "minReplicas": {
                      "type": "int",
                      "defaultValue": 1,
                      "maxValue": 25,
                      "minValue": 0,
                      "metadata": {
                        "description": "Minimum number of replicas that will be deployed"
                      }
                    },
                    "maxReplicas": {
                      "type": "int",
                      "defaultValue": 3,
                      "maxValue": 25,
                      "minValue": 0,
                      "metadata": {
                        "description": "Maximum number of replicas that will be deployed"
                      }
                    },
                    "externalIngress": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Should the app be exposed on an external endpoint"
                      }
                    },
                    "enableIngress": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Does the app expect traffic, or should it operate headless"
                      }
                    },
                    "revisionSuffix": {
                      "type": "string",
                      "defaultValue": "[uniqueString(utcNow())]",
                      "metadata": {
                        "description": "Revisions to the container app need to be unique"
                      }
                    },
                    "environmentVariables": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Any environment variables that your container needs"
                      }
                    },
                    "azureContainerRegistry": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "An ACR name can be optionally passed if thats where the container app image is homed"
                      }
                    },
                    "createUserManagedId": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Will create a user managed identity for the application to access other Azure resoruces as"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Any tags that are to be applied to the Container App"
                      }
                    }
                  },
                  "variables": {
                    "acrPullRole": "[resourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.App/containerApps",
                      "apiVersion": "2022-06-01-preview",
                      "name": "[parameters('containerAppName')]",
                      "location": "[parameters('location')]",
                      "identity": "[if(parameters('createUserManagedId'), createObject('type', 'UserAssigned', 'userAssignedIdentities', createObject(format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))), createObject())), createObject('type', 'None'))]",
                      "properties": {
                        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppEnvName'))]",
                        "configuration": {
                          "ingress": "[if(parameters('enableIngress'), createObject('external', parameters('externalIngress'), 'targetPort', parameters('targetPort'), 'allowInsecure', false(), 'traffic', createArray(createObject('latestRevision', true(), 'weight', 100))), null())]",
                          "dapr": {
                            "appId": "[parameters('containerAppName')]",
                            "appProtocol": "[if(not(empty(parameters('daprAppProtocol'))), parameters('daprAppProtocol'), null())]",
                            "appPort": "[if(equals(parameters('enableIngress'), true()), parameters('daprAppPort'), null())]",
                            "enabled": true
                          },
                          "activeRevisionsMode": "[parameters('revisionMode')]",
                          "registries": [
                            {
                              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))]",
                              "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('azureContainerRegistry')), '2022-02-01-preview').loginServer]"
                            }
                          ]
                        },
                        "template": {
                          "revisionSuffix": "[parameters('revisionSuffix')]",
                          "containers": [
                            {
                              "name": "[parameters('containerAppName')]",
                              "image": "[parameters('containerImage')]",
                              "resources": {
                                "cpu": "[json(parameters('cpuCore'))]",
                                "memory": "[format('{0}Gi', parameters('memorySize'))]"
                              },
                              "env": "[parameters('environmentVariables')]"
                            }
                          ],
                          "scale": {
                            "minReplicas": "[parameters('minReplicas')]",
                            "maxReplicas": "[parameters('maxReplicas')]"
                          }
                        }
                      },
                      "tags": "[parameters('tags')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', format('wait-{0}', parameters('containerAppName')))]",
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('createUserManagedId')]",
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2022-01-31-preview",
                      "name": "[format('id-{0}', parameters('containerAppName'))]",
                      "location": "[parameters('location')]"
                    },
                    {
                      "condition": "[and(parameters('createUserManagedId'), not(empty(parameters('azureContainerRegistry'))))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('azureContainerRegistry'))]",
                      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('azureContainerRegistry')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), variables('acrPullRole'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('acrPullRole')]",
                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), '2022-01-31-preview').principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))]"
                      ],
                      "metadata": {
                        "description": "This allows the managed identity of the container app to access the registry"
                      }
                    },
                    {
                      "condition": "[and(parameters('createUserManagedId'), not(empty(parameters('azureContainerRegistry'))))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('wait-{0}', parameters('containerAppName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "waitSeconds": {
                            "value": 30
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.8.9.13224",
                              "templateHash": "2218759242619531802"
                            }
                          },
                          "parameters": {
                            "waitSeconds": {
                              "type": "int",
                              "metadata": {
                                "description": "The number of seconds to wait for"
                              },
                              "maxValue": 180,
                              "minValue": 1
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]",
                              "metadata": {
                                "description": "The location to deploy the resources to"
                              }
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deploymentScripts",
                              "apiVersion": "2020-10-01",
                              "name": "DeployDelay",
                              "location": "[parameters('location')]",
                              "kind": "AzurePowerShell",
                              "properties": {
                                "retentionInterval": "PT1H",
                                "azPowerShellVersion": "6.4",
                                "cleanupPreference": "OnSuccess",
                                "environmentVariables": [
                                  {
                                    "name": "waitSeconds",
                                    "value": "[format('{0}', parameters('waitSeconds'))]"
                                  }
                                ],
                                "scriptContent": "write-output \"Sleeping for $Env:waitSeconds\"; start-sleep -Seconds $Env:waitSeconds"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.ContainerRegistry/registries', parameters('azureContainerRegistry')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('azureContainerRegistry')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), variables('acrPullRole')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "containerAppFQDN": {
                      "type": "string",
                      "value": "[if(parameters('enableIngress'), reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName'))).configuration.ingress.fqdn, '')]",
                      "metadata": {
                        "description": "If ingress is enabled, this is the FQDN that the Container App is exposed on"
                      }
                    },
                    "userAssignedIdPrincipalId": {
                      "type": "string",
                      "value": "[if(parameters('createUserManagedId'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), '2022-01-31-preview').principalId, '')]",
                      "metadata": {
                        "description": "The Principal Id of the Container Apps Managed Identity"
                      }
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppFQDN": {
              "type": "string",
              "value": "[if(parameters('enableIngress'), if(empty(parameters('azureContainerRegistry')), reference(resourceId('Microsoft.Resources/deployments', parameters('containerAppName')), '2020-10-01').outputs.containerAppFQDN.value, reference(resourceId('Microsoft.Resources/deployments', format('{0}-acr', parameters('containerAppName'))), '2020-10-01').outputs.containerAppFQDN.value), '')]",
              "metadata": {
                "description": "If ingress is enabled, this is the FQDN that the Container App is exposed on"
              }
            },
            "userAssignedIdPrincipalId": {
              "type": "string",
              "value": "[if(empty(parameters('azureContainerRegistry')), reference(resourceId('Microsoft.Resources/deployments', parameters('containerAppName')), '2020-10-01').outputs.userAssignedIdPrincipalId.value, reference(resourceId('Microsoft.Resources/deployments', format('{0}-acr', parameters('containerAppName'))), '2020-10-01').outputs.userAssignedIdPrincipalId.value)]",
              "metadata": {
                "description": "The PrinicpalId of the Container Apps Managed Identity"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', parameters('containerAppEnvName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "statePyApp",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "containerAppName": {
            "value": "[parameters('clientAppName')]"
          },
          "containerAppEnvName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', parameters('containerAppEnvName'))).outputs.containerAppEnvironmentName.value]"
          },
          "containerImage": {
            "value": "ghcr.io/dapr/samples/hello-k8s-python:latest"
          },
          "enableIngress": {
            "value": false
          },
          "createUserManagedId": {
            "value": false
          },
          "daprAppProtocol": {
            "value": ""
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "18066693510890011191"
            }
          },
          "parameters": {
            "containerAppName": {
              "type": "string",
              "defaultValue": "[format('containerapp-{0}', uniqueString(resourceGroup().id))]",
              "metadata": {
                "description": "Specifies the name of the container app."
              }
            },
            "containerAppEnvName": {
              "type": "string",
              "metadata": {
                "description": "Specifies the name of the container app environment to target, must be in the same resourceGroup."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Specifies the location for all resources."
              }
            },
            "containerImage": {
              "type": "string",
              "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "metadata": {
                "description": "Specifies the docker container image to deploy."
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 80,
              "metadata": {
                "description": "Specifies the container port."
              }
            },
            "daprAppPort": {
              "type": "int",
              "defaultValue": "[parameters('targetPort')]",
              "metadata": {
                "description": "Specifies the dapr app port."
              }
            },
            "daprAppProtocol": {
              "type": "string",
              "defaultValue": "http",
              "metadata": {
                "description": "Tells Dapr which protocol your application is using. Valid options are http and grpc. Default is http"
              },
              "allowedValues": [
                "http",
                "grpc",
                ""
              ]
            },
            "revisionMode": {
              "type": "string",
              "defaultValue": "Single",
              "metadata": {
                "description": "Controls how active revisions are handled for the Container app"
              },
              "allowedValues": [
                "Single",
                "Multiple"
              ]
            },
            "cpuCore": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "Number of CPU cores the container can use. Can be with a maximum of two decimals places. Max of 2.0. Valid values include, 0.5 1.25 1.4"
              }
            },
            "memorySize": {
              "type": "string",
              "defaultValue": "1",
              "metadata": {
                "description": "Amount of memory (in gibibytes, GiB) allocated to the container up to 4GiB. Can be with a maximum of two decimals. Ratio with CPU cores must be equal to 2."
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "maxValue": 25,
              "minValue": 0,
              "metadata": {
                "description": "Minimum number of replicas that will be deployed"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "maxValue": 25,
              "minValue": 0,
              "metadata": {
                "description": "Maximum number of replicas that will be deployed"
              }
            },
            "externalIngress": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Should the app be exposed on an external endpoint"
              }
            },
            "enableIngress": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Does the app expect traffic, or should it operate headless"
              }
            },
            "revisionSuffix": {
              "type": "string",
              "defaultValue": "[uniqueString(utcNow())]",
              "metadata": {
                "description": "Revisions to the container app need to be unique"
              }
            },
            "environmentVariables": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Any environment variables that your container needs"
              }
            },
            "azureContainerRegistry": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "An ACR name can be optionally passed if thats where the container app image is homed"
              }
            },
            "createUserManagedId": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Will create a user managed identity for the application to access other Azure resoruces as"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Any tags that are to be applied to the Container App"
              }
            }
          },
          "resources": [
            {
              "condition": "[empty(parameters('azureContainerRegistry'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[parameters('containerAppName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "containerAppEnvName": {
                    "value": "[parameters('containerAppEnvName')]"
                  },
                  "containerAppName": {
                    "value": "[parameters('containerAppName')]"
                  },
                  "containerImage": {
                    "value": "[parameters('containerImage')]"
                  },
                  "cpuCore": {
                    "value": "[parameters('cpuCore')]"
                  },
                  "createUserManagedId": {
                    "value": "[parameters('createUserManagedId')]"
                  },
                  "daprAppPort": {
                    "value": "[parameters('daprAppPort')]"
                  },
                  "daprAppProtocol": {
                    "value": "[parameters('daprAppProtocol')]"
                  },
                  "enableIngress": {
                    "value": "[parameters('enableIngress')]"
                  },
                  "environmentVariables": {
                    "value": "[parameters('environmentVariables')]"
                  },
                  "externalIngress": {
                    "value": "[parameters('externalIngress')]"
                  },
                  "maxReplicas": {
                    "value": "[parameters('maxReplicas')]"
                  },
                  "memorySize": {
                    "value": "[parameters('memorySize')]"
                  },
                  "minReplicas": {
                    "value": "[parameters('minReplicas')]"
                  },
                  "revisionMode": {
                    "value": "[parameters('revisionMode')]"
                  },
                  "revisionSuffix": {
                    "value": "[parameters('revisionSuffix')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "targetPort": {
                    "value": "[parameters('targetPort')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "7009689267588982199"
                    }
                  },
                  "parameters": {
                    "containerAppName": {
                      "type": "string",
                      "defaultValue": "[format('containerapp-{0}', uniqueString(resourceGroup().id))]",
                      "metadata": {
                        "description": "Specifies the name of the container app."
                      }
                    },
                    "containerAppEnvName": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the name of the container app environment to target, must be in the same resourceGroup."
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the location for all resources."
                      }
                    },
                    "containerImage": {
                      "type": "string",
                      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
                      "metadata": {
                        "description": "Specifies the docker container image to deploy."
                      }
                    },
                    "targetPort": {
                      "type": "int",
                      "defaultValue": 80,
                      "metadata": {
                        "description": "Specifies the container port."
                      }
                    },
                    "daprAppPort": {
                      "type": "int",
                      "defaultValue": "[parameters('targetPort')]",
                      "metadata": {
                        "description": "Specifies the dapr app port."
                      }
                    },
                    "daprAppProtocol": {
                      "type": "string",
                      "defaultValue": "http",
                      "metadata": {
                        "description": "Tells Dapr which protocol your application is using. Valid options are http and grpc. Default is http"
                      },
                      "allowedValues": [
                        "http",
                        "grpc",
                        ""
                      ]
                    },
                    "revisionMode": {
                      "type": "string",
                      "defaultValue": "Single",
                      "metadata": {
                        "description": "Controls how active revisions are handled for the Container app"
                      },
                      "allowedValues": [
                        "Single",
                        "Multiple"
                      ]
                    },
                    "cpuCore": {
                      "type": "string",
                      "defaultValue": "0.5",
                      "metadata": {
                        "description": "Number of CPU cores the container can use. Can be with a maximum of two decimals places. Max of 2.0. Valid values include, 0.5 1.25 1.4"
                      }
                    },
                    "memorySize": {
                      "type": "string",
                      "defaultValue": "1",
                      "metadata": {
                        "description": "Amount of memory (in gibibytes, GiB) allocated to the container up to 4GiB. Can be with a maximum of two decimals. Ratio with CPU cores must be equal to 2."
                      }
                    },
                    "minReplicas": {
                      "type": "int",
                      "defaultValue": 1,
                      "maxValue": 25,
                      "minValue": 0,
                      "metadata": {
                        "description": "Minimum number of replicas that will be deployed"
                      }
                    },
                    "maxReplicas": {
                      "type": "int",
                      "defaultValue": 3,
                      "maxValue": 25,
                      "minValue": 0,
                      "metadata": {
                        "description": "Maximum number of replicas that will be deployed"
                      }
                    },
                    "externalIngress": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Should the app be exposed on an external endpoint"
                      }
                    },
                    "enableIngress": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Does the app expect traffic, or should it operate headless"
                      }
                    },
                    "revisionSuffix": {
                      "type": "string",
                      "defaultValue": "[uniqueString(utcNow())]",
                      "metadata": {
                        "description": "Revisions to the container app need to be unique"
                      }
                    },
                    "environmentVariables": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Any environment variables that your container needs"
                      }
                    },
                    "createUserManagedId": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Will create a user managed identity for the application to access other Azure resoruces as"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Any tags that are to be applied to the Container App"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.App/containerApps",
                      "apiVersion": "2022-06-01-preview",
                      "name": "[parameters('containerAppName')]",
                      "location": "[parameters('location')]",
                      "identity": "[if(parameters('createUserManagedId'), createObject('type', 'UserAssigned', 'userAssignedIdentities', createObject(format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))), createObject())), createObject('type', 'None'))]",
                      "properties": {
                        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppEnvName'))]",
                        "configuration": {
                          "ingress": "[if(parameters('enableIngress'), createObject('external', parameters('externalIngress'), 'targetPort', parameters('targetPort'), 'allowInsecure', false(), 'traffic', createArray(createObject('latestRevision', true(), 'weight', 100))), null())]",
                          "dapr": {
                            "appId": "[parameters('containerAppName')]",
                            "appProtocol": "[if(not(empty(parameters('daprAppProtocol'))), parameters('daprAppProtocol'), null())]",
                            "appPort": "[if(equals(parameters('enableIngress'), true()), parameters('daprAppPort'), null())]",
                            "enabled": true
                          },
                          "activeRevisionsMode": "[parameters('revisionMode')]"
                        },
                        "template": {
                          "revisionSuffix": "[parameters('revisionSuffix')]",
                          "containers": [
                            {
                              "name": "[parameters('containerAppName')]",
                              "image": "[parameters('containerImage')]",
                              "resources": {
                                "cpu": "[json(parameters('cpuCore'))]",
                                "memory": "[format('{0}Gi', parameters('memorySize'))]"
                              },
                              "env": "[parameters('environmentVariables')]"
                            }
                          ],
                          "scale": {
                            "minReplicas": "[parameters('minReplicas')]",
                            "maxReplicas": "[parameters('maxReplicas')]"
                          }
                        }
                      },
                      "tags": "[parameters('tags')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('createUserManagedId')]",
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2022-01-31-preview",
                      "name": "[format('id-{0}', parameters('containerAppName'))]",
                      "location": "[parameters('location')]"
                    }
                  ],
                  "outputs": {
                    "containerAppFQDN": {
                      "type": "string",
                      "value": "[if(parameters('enableIngress'), reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName'))).configuration.ingress.fqdn, '')]",
                      "metadata": {
                        "description": "If ingress is enabled, this is the FQDN that the Container App is exposed on"
                      }
                    },
                    "userAssignedIdPrincipalId": {
                      "type": "string",
                      "value": "[if(parameters('createUserManagedId'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), '2022-01-31-preview').principalId, '')]",
                      "metadata": {
                        "description": "The Principal Id of the Container Apps Managed Identity"
                      }
                    }
                  }
                }
              }
            },
            {
              "condition": "[not(empty(parameters('azureContainerRegistry')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-acr', parameters('containerAppName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "containerAppEnvName": {
                    "value": "[parameters('containerAppEnvName')]"
                  },
                  "azureContainerRegistry": {
                    "value": "[parameters('azureContainerRegistry')]"
                  },
                  "containerAppName": {
                    "value": "[parameters('containerAppName')]"
                  },
                  "containerImage": {
                    "value": "[parameters('containerImage')]"
                  },
                  "cpuCore": {
                    "value": "[parameters('cpuCore')]"
                  },
                  "createUserManagedId": {
                    "value": "[parameters('createUserManagedId')]"
                  },
                  "daprAppPort": {
                    "value": "[parameters('daprAppPort')]"
                  },
                  "daprAppProtocol": {
                    "value": "[parameters('daprAppProtocol')]"
                  },
                  "enableIngress": {
                    "value": "[parameters('enableIngress')]"
                  },
                  "environmentVariables": {
                    "value": "[parameters('environmentVariables')]"
                  },
                  "externalIngress": {
                    "value": "[parameters('externalIngress')]"
                  },
                  "maxReplicas": {
                    "value": "[parameters('maxReplicas')]"
                  },
                  "memorySize": {
                    "value": "[parameters('memorySize')]"
                  },
                  "minReplicas": {
                    "value": "[parameters('minReplicas')]"
                  },
                  "revisionMode": {
                    "value": "[parameters('revisionMode')]"
                  },
                  "revisionSuffix": {
                    "value": "[parameters('revisionSuffix')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "targetPort": {
                    "value": "[parameters('targetPort')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "1021504825763956878"
                    }
                  },
                  "parameters": {
                    "containerAppName": {
                      "type": "string",
                      "defaultValue": "[format('containerapp-{0}', uniqueString(resourceGroup().id))]",
                      "metadata": {
                        "description": "Specifies the name of the container app."
                      }
                    },
                    "containerAppEnvName": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the name of the container app environment to target, must be in the same resourceGroup."
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the location for all resources."
                      }
                    },
                    "containerImage": {
                      "type": "string",
                      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
                      "metadata": {
                        "description": "Specifies the docker container image to deploy."
                      }
                    },
                    "targetPort": {
                      "type": "int",
                      "defaultValue": 80,
                      "metadata": {
                        "description": "Specifies the container port."
                      }
                    },
                    "daprAppPort": {
                      "type": "int",
                      "defaultValue": "[parameters('targetPort')]",
                      "metadata": {
                        "description": "Specifies the dapr app port."
                      }
                    },
                    "daprAppProtocol": {
                      "type": "string",
                      "defaultValue": "http",
                      "metadata": {
                        "description": "Tells Dapr which protocol your application is using. Valid options are http and grpc. Default is http"
                      },
                      "allowedValues": [
                        "http",
                        "grpc",
                        ""
                      ]
                    },
                    "revisionMode": {
                      "type": "string",
                      "defaultValue": "Single",
                      "metadata": {
                        "description": "Controls how active revisions are handled for the Container app"
                      },
                      "allowedValues": [
                        "Single",
                        "Multiple"
                      ]
                    },
                    "cpuCore": {
                      "type": "string",
                      "defaultValue": "0.5",
                      "metadata": {
                        "description": "Number of CPU cores the container can use. Can be with a maximum of two decimals places. Max of 2.0. Valid values include, 0.5 1.25 1.4"
                      }
                    },
                    "memorySize": {
                      "type": "string",
                      "defaultValue": "1",
                      "metadata": {
                        "description": "Amount of memory (in gibibytes, GiB) allocated to the container up to 4GiB. Can be with a maximum of two decimals. Ratio with CPU cores must be equal to 2."
                      }
                    },
                    "minReplicas": {
                      "type": "int",
                      "defaultValue": 1,
                      "maxValue": 25,
                      "minValue": 0,
                      "metadata": {
                        "description": "Minimum number of replicas that will be deployed"
                      }
                    },
                    "maxReplicas": {
                      "type": "int",
                      "defaultValue": 3,
                      "maxValue": 25,
                      "minValue": 0,
                      "metadata": {
                        "description": "Maximum number of replicas that will be deployed"
                      }
                    },
                    "externalIngress": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Should the app be exposed on an external endpoint"
                      }
                    },
                    "enableIngress": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Does the app expect traffic, or should it operate headless"
                      }
                    },
                    "revisionSuffix": {
                      "type": "string",
                      "defaultValue": "[uniqueString(utcNow())]",
                      "metadata": {
                        "description": "Revisions to the container app need to be unique"
                      }
                    },
                    "environmentVariables": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Any environment variables that your container needs"
                      }
                    },
                    "azureContainerRegistry": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "An ACR name can be optionally passed if thats where the container app image is homed"
                      }
                    },
                    "createUserManagedId": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Will create a user managed identity for the application to access other Azure resoruces as"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Any tags that are to be applied to the Container App"
                      }
                    }
                  },
                  "variables": {
                    "acrPullRole": "[resourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.App/containerApps",
                      "apiVersion": "2022-06-01-preview",
                      "name": "[parameters('containerAppName')]",
                      "location": "[parameters('location')]",
                      "identity": "[if(parameters('createUserManagedId'), createObject('type', 'UserAssigned', 'userAssignedIdentities', createObject(format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))), createObject())), createObject('type', 'None'))]",
                      "properties": {
                        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppEnvName'))]",
                        "configuration": {
                          "ingress": "[if(parameters('enableIngress'), createObject('external', parameters('externalIngress'), 'targetPort', parameters('targetPort'), 'allowInsecure', false(), 'traffic', createArray(createObject('latestRevision', true(), 'weight', 100))), null())]",
                          "dapr": {
                            "appId": "[parameters('containerAppName')]",
                            "appProtocol": "[if(not(empty(parameters('daprAppProtocol'))), parameters('daprAppProtocol'), null())]",
                            "appPort": "[if(equals(parameters('enableIngress'), true()), parameters('daprAppPort'), null())]",
                            "enabled": true
                          },
                          "activeRevisionsMode": "[parameters('revisionMode')]",
                          "registries": [
                            {
                              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))]",
                              "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('azureContainerRegistry')), '2022-02-01-preview').loginServer]"
                            }
                          ]
                        },
                        "template": {
                          "revisionSuffix": "[parameters('revisionSuffix')]",
                          "containers": [
                            {
                              "name": "[parameters('containerAppName')]",
                              "image": "[parameters('containerImage')]",
                              "resources": {
                                "cpu": "[json(parameters('cpuCore'))]",
                                "memory": "[format('{0}Gi', parameters('memorySize'))]"
                              },
                              "env": "[parameters('environmentVariables')]"
                            }
                          ],
                          "scale": {
                            "minReplicas": "[parameters('minReplicas')]",
                            "maxReplicas": "[parameters('maxReplicas')]"
                          }
                        }
                      },
                      "tags": "[parameters('tags')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', format('wait-{0}', parameters('containerAppName')))]",
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('createUserManagedId')]",
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2022-01-31-preview",
                      "name": "[format('id-{0}', parameters('containerAppName'))]",
                      "location": "[parameters('location')]"
                    },
                    {
                      "condition": "[and(parameters('createUserManagedId'), not(empty(parameters('azureContainerRegistry'))))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('azureContainerRegistry'))]",
                      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('azureContainerRegistry')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), variables('acrPullRole'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('acrPullRole')]",
                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), '2022-01-31-preview').principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName')))]"
                      ],
                      "metadata": {
                        "description": "This allows the managed identity of the container app to access the registry"
                      }
                    },
                    {
                      "condition": "[and(parameters('createUserManagedId'), not(empty(parameters('azureContainerRegistry'))))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('wait-{0}', parameters('containerAppName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "waitSeconds": {
                            "value": 30
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.8.9.13224",
                              "templateHash": "2218759242619531802"
                            }
                          },
                          "parameters": {
                            "waitSeconds": {
                              "type": "int",
                              "metadata": {
                                "description": "The number of seconds to wait for"
                              },
                              "maxValue": 180,
                              "minValue": 1
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]",
                              "metadata": {
                                "description": "The location to deploy the resources to"
                              }
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deploymentScripts",
                              "apiVersion": "2020-10-01",
                              "name": "DeployDelay",
                              "location": "[parameters('location')]",
                              "kind": "AzurePowerShell",
                              "properties": {
                                "retentionInterval": "PT1H",
                                "azPowerShellVersion": "6.4",
                                "cleanupPreference": "OnSuccess",
                                "environmentVariables": [
                                  {
                                    "name": "waitSeconds",
                                    "value": "[format('{0}', parameters('waitSeconds'))]"
                                  }
                                ],
                                "scriptContent": "write-output \"Sleeping for $Env:waitSeconds\"; start-sleep -Seconds $Env:waitSeconds"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.ContainerRegistry/registries', parameters('azureContainerRegistry')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('azureContainerRegistry')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), variables('acrPullRole')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "containerAppFQDN": {
                      "type": "string",
                      "value": "[if(parameters('enableIngress'), reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName'))).configuration.ingress.fqdn, '')]",
                      "metadata": {
                        "description": "If ingress is enabled, this is the FQDN that the Container App is exposed on"
                      }
                    },
                    "userAssignedIdPrincipalId": {
                      "type": "string",
                      "value": "[if(parameters('createUserManagedId'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}', parameters('containerAppName'))), '2022-01-31-preview').principalId, '')]",
                      "metadata": {
                        "description": "The Principal Id of the Container Apps Managed Identity"
                      }
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppFQDN": {
              "type": "string",
              "value": "[if(parameters('enableIngress'), if(empty(parameters('azureContainerRegistry')), reference(resourceId('Microsoft.Resources/deployments', parameters('containerAppName')), '2020-10-01').outputs.containerAppFQDN.value, reference(resourceId('Microsoft.Resources/deployments', format('{0}-acr', parameters('containerAppName'))), '2020-10-01').outputs.containerAppFQDN.value), '')]",
              "metadata": {
                "description": "If ingress is enabled, this is the FQDN that the Container App is exposed on"
              }
            },
            "userAssignedIdPrincipalId": {
              "type": "string",
              "value": "[if(empty(parameters('azureContainerRegistry')), reference(resourceId('Microsoft.Resources/deployments', parameters('containerAppName')), '2020-10-01').outputs.userAssignedIdPrincipalId.value, reference(resourceId('Microsoft.Resources/deployments', format('{0}-acr', parameters('containerAppName'))), '2020-10-01').outputs.userAssignedIdPrincipalId.value)]",
              "metadata": {
                "description": "The PrinicpalId of the Container Apps Managed Identity"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', parameters('containerAppEnvName'))]"
      ]
    }
  ]
}