{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "hciResourceProviderObjectID": {
      "defaultValue": "f0e0e122-3f80-44ed-95d2-f56e6fdc514c",
      "minLength": 1,
      "type": "String",
      "metadata": {
        "description": "Object ID of HCI Resource Provider"
      }
    },
    "location": {
      "defaultValue": "[resourceGroup().location]",
      "type": "String"
    }
  },
  "resources": {
    "arcMachineRoleAssignment": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "AzureStackHCIDeviceManagementRole-RoleAssignment",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "arcNodeResourceIds1": {
              "type": "array"
            }
          },
          "variables": {},
          "resources": [
            {
              "copy": {
              "name": "DVMroleAssignmentCopy",
              "count": "[length(parameters('arcNodeResourceIds1'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[concat('DMR-Role-Assignment-', copyIndex(), '-', guid(concat('DMR-', parameters('arcNodeResourceIds1')[copyIndex()])))]",
              "properties": {
              "mode": "Incremental",
              "roleDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/roleDefinitions/', '865ae368-6a45-4bd1-8fbf-0d5151f56fc1')]",
              "principalId": "[reference(parameters('arcNodeResourceIds1')[copyIndex()], '2023-10-03-preview', 'full').identity.principalId]",
              "scope": "[resourceGroup().id]",
              "description": "[concat(substring(parameters('arcNodeResourceIds1')[copyIndex()],lastIndexOf(parameters('arcNodeResourceIds1')[copyIndex()],'/')),'- Azure Stack HCI Device Management Role')]"
              }
            }
          ]
        },
        "parameters": {
          "arcNodeResourceIds1": {
            "value": "[parameters('arcNodeResourceIds')]"
          }
        }
      },
      "subscriptionId": "[subscription().subscriptionId]",
      "resourceGroup": "[resourceGroup().name]"
    }
  }
}