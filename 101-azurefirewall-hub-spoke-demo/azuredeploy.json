{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "string",
            "defaultValue": "azfw",
            "metadata": {
              "description": "Username for the Virtual Machine."
            }
          },
          "adminPassword": {
            "type": "securestring",
            "metadata": {
              "description": "Password for the Virtual Machine."
            }
          },
          "windowsOSVersion": {
            "type": "string",
            "defaultValue": "2019-Datacenter",
            "allowedValues": [
              "2016-Datacenter",
              "2019-Datacenter"
            ],
            "metadata": {
              "description": "The Windows version for the VM. This will pick a fully patched image of this given Windows version."
            }
          },
          "virtualMachineSize": {
            "type": "string",
            "defaultValue": "Standard_DS3s_v2",
            "metadata": {
              "description": "Virtual machine size"
            }
        },
          "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
              "description": "Location for all resources."
            }
          }
        
    },
    "variables": {
        "virtualMachines_onprem_name": "onprem",
        "virtualMachines_spokevm1_name": "spokevm1",
        "virtualMachines_spokevm2_name": "spokevm2",
        "virtualNetworks_azfw_hub_name": "azfw-hub",
        
        "connections_hub_to_onprem_name": "hub-to-onprem",
        "connections_onprem_to_hub_name": "onprem-to-hub",
        
        "azureFirewalls_azfw_demo_fw_name": "azfw-demo-fw",
        
        "bastionHosts_onprem_bastion_name": "onprem-bastion",
        "bastionHosts_spoke1_bastion_name": "spoke1-bastion",
        "bastionHosts_spoke2_bastion_name": "spoke2-bastion",
        "bastionHosts_azfw_hub_bastion_name": "azfw-hub-bastion-subnet",
        
        "networkInterfaces_onprem_name":  "onpremnic",
        "networkInterfaces_spokevm1_name": "spokevm1nic",
        "networkInterfaces_spokevm2_name": "spokevm2nic",
        
        "virtualNetworks_azfw_spoke1_name": "azfw-spoke1-vnet",
        "virtualNetworks_azfw_spoke2_name": "azfw-spoke2-vnet",
        "virtualNetworks_azfw_on_prem_name": "azfw-on-prem-vnet",
        "storageAccounts_azfwdemodiag_name": "[uniquestring(resourceGroup().id)]",
        
        "publicIPAddresses_azfw_hub_ip_name": "azfw-hub-ip",
        "publicIPAddresses_azfw_spoke1_ip_name": "azfw-spoke1-ip",
        "publicIPAddresses_azfw_spoke2_ip_name": "azfw-spoke2-ip",
        "publicIPAddresses_azfw_demo_pubip_name": "azfw-demo-pubip",    
        "publicIPAddresses_azfw_on_prem_ip_name": "azfw-on-prem-ip",
        "publicIPAddresses_azfw_hub_gw_pub_ip_name": "azfw-hub-gw-pub-ip",
        "publicIPAddresses_azfw_on_prem_gw_pub_ip_name": "azfw-on-prem-gw-pub-ip",
    
        "routeTables_azfw_all_to_fw_name": "azfw-all-to-fw",
        "routeTables_azfw_spokes_via_fw_name": "azfw-spokes-via-fw",
    
        "virtualNetworkGateways_azfw_hub_gw_name": "azfw-hub-gw",
        "virtualNetworkGateways_azfw_on_prem_gw_name": "azfw-on-prem-gw"    
    },
    "resources": [
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_azfw_demo_pubip_name')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4                
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_azfw_hub_gw_pub_ip_name')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Basic"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Dynamic",
                "idleTimeoutInMinutes": 4                
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_azfw_hub_ip_name')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4                
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_azfw_on_prem_gw_pub_ip_name')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Basic"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Dynamic",
                "idleTimeoutInMinutes": 4
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_azfw_on_prem_ip_name')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_azfw_spoke1_ip_name')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_azfw_spoke2_ip_name')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4               
            }
        },
        {
            "type": "Microsoft.Network/routeTables",
            "apiVersion": "2019-09-01",
            "name": "[variables('routeTables_azfw_all_to_fw_name')]",
            "location": "[parameters('location')]",
            "properties": {
                "disableBgpRoutePropagation": true,
                "routes": [
                    {
                        "name": "internet",
                        "properties": {
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "10.100.0.132"
                        }
                    },
                    {
                        "name": "onpremviafw",
                        "properties": {
                            "addressPrefix": "172.16.0.0/24",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "10.100.0.132"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/routeTables",
            "apiVersion": "2019-09-01",
            "name": "[variables('routeTables_azfw_spokes_via_fw_name')]",
            "location": "[parameters('location')]",
            "properties": {
                "disableBgpRoutePropagation": false,
                "routes": [
                    {
                        "name": "spokes-via-fw",
                        "properties": {
                            "addressPrefix": "192.168.1.0/24",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "10.100.0.132"
                        }
                    },
                    {
                        "name": "spoke2-via-fw",
                        "properties": {
                            "addressPrefix": "192.168.2.0/24",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "10.100.0.132"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworks_azfw_on_prem_name')]",
            "location": "[parameters('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "172.16.0.0/24"
                    ]
                },
                "subnets": [
                    {
                        "name": "GatewaySubnet",
                        "properties": {
                            "addressPrefix": "172.16.0.224/27",
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    },
                    {
                        "name": "AzureBastionSubnet",
                        "properties": {
                            "addressPrefix": "172.16.0.192/27",
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    },
                    {
                        "name": "default",
                        "properties": {
                            "addressPrefix": "172.16.0.0/25",
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    }
                ],
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2019-04-01",
            "name": "[variables('storageAccounts_azfwdemodiag_name')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "kind": "Storage",
            "properties": {
                "networkAcls": {
                    "bypass": "AzureServices",
                    "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                    "services": {
                        "file": {
                            "enabled": true
                        },
                        "blob": {
                            "enabled": true
                        }
                    },
                    "keySource": "Microsoft.Storage"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkInterfaces_onprem_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_on_prem_name'), 'default')]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAddress": "172.16.0.4",
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_on_prem_name'), 'default')]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "dnsSettings": {
                },
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkInterfaces_spokevm1_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_spoke1_name'), 'default')]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAddress": "192.168.1.4",
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_spoke1_name'), 'default')]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "dnsSettings": {
                    
                },
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkInterfaces_spokevm2_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_spoke2_name'), 'default')]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAddress": "192.168.2.4",
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_spoke2_name'), 'default')]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "dnsSettings": {
                    
                },
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false
            }
        },
        {
            "type": "Microsoft.Network/routeTables/routes",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('routeTables_azfw_all_to_fw_name'), '/internet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
            ],
            "properties": {
                "addressPrefix": "0.0.0.0/0",
                "nextHopType": "VirtualAppliance",
                "nextHopIpAddress": "10.100.0.132"
            }
        },
        {
            "type": "Microsoft.Network/routeTables/routes",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('routeTables_azfw_all_to_fw_name'), '/onpremviafw')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.0.0/24",
                "nextHopType": "VirtualAppliance",
                "nextHopIpAddress": "10.100.0.132"
            }
        },
        {
            "type": "Microsoft.Network/routeTables/routes",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('routeTables_azfw_spokes_via_fw_name'), '/spoke2-via-fw')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_spokes_via_fw_name'))]"
            ],
            "properties": {
                "addressPrefix": "192.168.2.0/24",
                "nextHopType": "VirtualAppliance",
                "nextHopIpAddress": "10.100.0.132"
            }
        },
        {
            "type": "Microsoft.Network/routeTables/routes",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('routeTables_azfw_spokes_via_fw_name'), '/spokes-via-fw')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_spokes_via_fw_name'))]"
            ],
            "properties": {
                "addressPrefix": "192.168.1.0/24",
                "nextHopType": "VirtualAppliance",
                "nextHopIpAddress": "10.100.0.132"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_hub_name'), '/AzureBastionSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]"
            ],
            "properties": {
                "addressPrefix": "10.100.0.192/27",
                 
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_on_prem_name'), '/AzureBastionSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_on_prem_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.0.192/27",
                 
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_spoke1_name'), '/AzureBastionSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke1_name'))]"
            ],
            "properties": {
                "addressPrefix": "192.168.1.192/27",
                 
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_spoke2_name'), '/AzureBastionSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke2_name'))]"
            ],
            "properties": {
                "addressPrefix": "192.168.2.192/27",
                 
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_hub_name'), '/AzureFirewallSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]"
            ],
            "properties": {
                "addressPrefix": "10.100.0.128/26",
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_hub_name'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]"
            ],
            "properties": {
                "addressPrefix": "10.100.0.0/25",
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_on_prem_name'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_on_prem_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.0.0/25",
                 
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_on_prem_name'), '/GatewaySubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_on_prem_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.0.224/27",
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices",
            "apiVersion": "2019-04-01",
            "name": "[concat(variables('storageAccounts_azfwdemodiag_name'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccounts_azfwdemodiag_name'))]"
            ],
            "properties": {
                "cors": {
                 },
                "deleteRetentionPolicy": {
                    "enabled": false
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-03-01",
            "name": "[variables('virtualMachines_onprem_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_onprem_name'))]",
                "[resourceId('Microsoft.Storage/StorageAccounts', variables('storageAccounts_azfwdemodiag_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('virtualMachineSize')]"
                },
                "storageProfile": {
                    "imageReference": {
                      "publisher": "MicrosoftWindowsServer",
                      "offer": "WindowsServer",
                      "sku": "[parameters('windowsOSVersion')]",
                      "version": "latest"
                    },
                    "osDisk": {
                      "createOption": "FromImage"
                    },
                    "dataDisks": [
                      
                    ]
                  },
                "osProfile": {
                    "computerName": "[variables('virtualMachines_onprem_name')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true
                    },
                    "allowExtensionOperations": true
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_onprem_name'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[concat('https://', variables('storageAccounts_azfwdemodiag_name'), '.blob.core.windows.net/')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-03-01",
            "name": "[variables('virtualMachines_spokevm1_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_spokevm1_name'))]",
                "[resourceId('Microsoft.Storage/StorageAccounts', variables('storageAccounts_azfwdemodiag_name'))]"
            ],
                        
            "properties": {
                "hardwareProfile": {
                    "vmSize":  "[parameters('virtualMachineSize')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "[parameters('windowsOSVersion')]",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage"
                      },
                      "dataDisks": [
                        
                      ]
                },
                "osProfile": {
                    "computerName": "[variables('virtualMachines_spokevm1_name')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true
                    },
                     
                    "allowExtensionOperations": true
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_spokevm1_name'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[concat('https://', variables('storageAccounts_azfwdemodiag_name'), '.blob.core.windows.net/')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-03-01",
            "name": "[variables('virtualMachines_spokevm2_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_spokevm2_name'))]",
                "[resourceId('Microsoft.Storage/StorageAccounts', variables('storageAccounts_azfwdemodiag_name'))]"
            ],
           
            "properties": {
                "hardwareProfile": {
                    "vmSize":  "[parameters('virtualMachineSize')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "[parameters('windowsOSVersion')]",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage"
                      },
                      "dataDisks": [
                        
                      ]
                },
                "osProfile": {
                    "computerName": "[variables('virtualMachines_spokevm2_name')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true
                    },
                     
                    "allowExtensionOperations": true
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_spokevm2_name'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[concat('https://', variables('storageAccounts_azfwdemodiag_name'), '.blob.core.windows.net/')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/azureFirewalls",
            "apiVersion": "2019-09-01",
            "name": "[variables('azureFirewalls_azfw_demo_fw_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_demo_pubip_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_hub_name'), 'AzureFirewallSubnet')]"
            ],
            "properties": {
                "sku": {
                    "name": "AZFW_VNet",
                    "tier": "Standard"
                },
                "threatIntelMode": "Alert",
                "additionalProperties": {},
                "ipConfigurations": [
                    {
                        "name": "IpConf",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_demo_pubip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_hub_name'), 'AzureFirewallSubnet')]"
                            }
                        }
                    }
                ],
                "networkRuleCollections": [
                    {
                        "name": "spoke-to-spoke",
                        "properties": {
                            "priority": 100,
                            "action": {
                                "type": "Allow"
                            },
                            "rules": [
                                {
                                    "name": "spoke2-spoke1",
                                    "protocols": [
                                        "Any"
                                    ],
                                    "sourceAddresses": [
                                        "192.168.2.0/24"
                                    ],
                                    "destinationAddresses": [
                                        "192.168.1.0/24"
                                    ],                                    
                                    "destinationPorts": [
                                        "*"
                                    ]
                                },
                                {
                                    "name": "spoke1-spoke2",
                                    "protocols": [
                                        "Any"
                                    ],
                                    "sourceAddresses": [
                                        "192.168.1.0/24"
                                    ],
                                    "destinationAddresses": [
                                        "192.168.2.0/24"
                                    ],
                                    "destinationPorts": [
                                        "*"
                                    ]
                                },
                                {
                                    "name": "spoke1-onprem",
                                    "protocols": [
                                        "Any"
                                    ],
                                    "sourceAddresses": [
                                        "192.168.1.0/24"
                                    ],
                                    "destinationAddresses": [
                                        "172.16.0.0/24"
                                    ],
                                    "destinationPorts": [
                                        "*"
                                    ]
                                },
                                {
                                    "name": "spoke2-onprem",
                                    "protocols": [
                                        "Any"
                                    ],
                                    "sourceAddresses": [
                                        "192.168.2.0/24"
                                    ],
                                    "destinationAddresses": [
                                        "172.16.0.0/24"
                                    ],
                                    "destinationPorts": [
                                        "*"
                                    ]
                                },
                                {
                                    "name": "fwtest-to-onprem",
                                    "protocols": [
                                        "Any"
                                    ],
                                    "sourceAddresses": [
                                        "10.100.0.4"
                                    ],
                                    "destinationAddresses": [
                                        "172.16.0.0/24"
                                    ],
                                    "destinationPorts": [
                                        "*"
                                    ]
                                },
                                {
                                    "name": "onprem-spoke1",
                                    "protocols": [
                                        "Any"
                                    ],
                                    "sourceAddresses": [
                                        "172.16.0.0/24"
                                    ],
                                    "destinationAddresses": [
                                        "192.168.1.0/24"
                                    ],
                                    "destinationPorts": [
                                        "*"
                                    ]
                                },
                                {
                                    "name": "onprem-spoke2",
                                    "protocols": [
                                        "Any"
                                    ],
                                    "sourceAddresses": [
                                        "172.16.0.0/24"
                                    ],
                                    "destinationAddresses": [
                                        "192.168.2.0/24"
                                    ],
                                    "destinationPorts": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "applicationRuleCollections": [
                    {
                        "name": "allow-google",
                        "properties": {
                            "priority": 100,
                            "action": {
                                "type": "Allow"
                            },
                            "rules": [
                                {
                                    "name": "google",
                                    "protocols": [
                                        {
                                            "protocolType": "Http",
                                            "port": 80
                                        },
                                        {
                                            "protocolType": "Https",
                                            "port": 443
                                        }
                                    ],
                                    "targetFqdns": [
                                        "www.google.com"
                                    ],
                                    "sourceAddresses": [
                                        "192.168.1.0/24"
                                    ]
                                },
                                {
                                    "name": "onprem",
                                    "protocols": [
                                        {
                                            "protocolType": "Http",
                                            "port": 80
                                        },
                                        {
                                            "protocolType": "Https",
                                            "port": 443
                                        }
                                    ],
                                    "targetFqdns": [
                                        "172.16.0.4"
                                    ],
                                    "sourceAddresses": [
                                        "*"
                                    ]
                                },
                                {
                                    "name": "googlefromonprem",
                                    "protocols": [
                                        {
                                            "protocolType": "Http",
                                            "port": 80
                                        },
                                        {
                                            "protocolType": "Https",
                                            "port": 443
                                        }
                                    ],
                                    "targetFqdns": [
                                        "www.google.com"
                                    ],
                                    "sourceAddresses": [
                                        "172.16.0.4"
                                    ]
                                },
                                {
                                    "name": "allowall",
                                    "protocols": [
                                        {
                                            "protocolType": "Http",
                                            "port": 80
                                        },
                                        {
                                            "protocolType": "Https",
                                            "port": 443
                                        }
                                    ],
                                    "targetFqdns": [
                                        "*"
                                    ],
                                    "sourceAddresses": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/bastionHosts",
            "apiVersion": "2019-09-01",
            "name": "[variables('bastionHosts_azfw_hub_bastion_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_hub_ip_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_hub_name'), 'AzureBastionSubnet')]"
            ],
            "properties": {
                "dnsName": "bst-88091e28-bfb2-40d7-a372-17daafc8cbc1.bastion.azure.com",
                "ipConfigurations": [
                    {
                        "name": "IpConf",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_hub_ip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_hub_name'), 'AzureBastionSubnet')]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/bastionHosts",
            "apiVersion": "2019-09-01",
            "name": "[variables('bastionHosts_onprem_bastion_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_on_prem_ip_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_on_prem_name'), 'AzureBastionSubnet')]"
            ],
            "properties": {
                "dnsName": "bst-bc2e730d-498d-4f4d-828c-92888981428a.bastion.azure.com",
                "ipConfigurations": [
                    {
                        "name": "IpConf",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_on_prem_ip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_on_prem_name'), 'AzureBastionSubnet')]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/bastionHosts",
            "apiVersion": "2019-09-01",
            "name": "[variables('bastionHosts_spoke1_bastion_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_spoke1_ip_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_spoke1_name'), 'AzureBastionSubnet')]"
            ],
            "properties": {
                "dnsName": "bst-fd97b18a-2f11-4105-84f4-5dc4f4a912f1.bastion.azure.com",
                "ipConfigurations": [
                    {
                        "name": "IpConf",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_spoke1_ip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_spoke1_name'), 'AzureBastionSubnet')]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/bastionHosts",
            "apiVersion": "2019-09-01",
            "name": "[variables('bastionHosts_spoke2_bastion_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_spoke2_ip_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_spoke2_name'), 'AzureBastionSubnet')]"
            ],
            "properties": {
                "dnsName": "bst-dd620c26-35a0-4473-ae4b-64c84600a8c8.bastion.azure.com",
                "ipConfigurations": [
                    {
                        "name": "IpConf",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_spoke2_ip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_spoke2_name'), 'AzureBastionSubnet')]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/connections",
            "apiVersion": "2019-09-01",
            "name": "[variables('connections_hub_to_onprem_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_hub_gw_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_on_prem_gw_name'))]"
            ],
            "properties": {
                "virtualNetworkGateway1": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_hub_gw_name'))]"
                },
                "virtualNetworkGateway2": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_on_prem_gw_name'))]"
                },
                "connectionType": "Vnet2Vnet",
                "connectionProtocol": "IKEv2",
                "routingWeight": 0,
                "enableBgp": true,
                "usePolicyBasedTrafficSelectors": false,
                "expressRouteGatewayBypass": false
            }
        },
        {
            "type": "Microsoft.Network/connections",
            "apiVersion": "2019-09-01",
            "name": "[variables('connections_onprem_to_hub_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_on_prem_gw_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_hub_gw_name'))]"
            ],
            "properties": {
                "virtualNetworkGateway1": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_on_prem_gw_name'))]"
                },
                "virtualNetworkGateway2": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_hub_gw_name'))]"
                },
                "connectionType": "Vnet2Vnet",
                "connectionProtocol": "IKEv2",
                "routingWeight": 0,
                "enableBgp": true,
                "usePolicyBasedTrafficSelectors": false,
                "expressRouteGatewayBypass": false
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworkGateways",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworkGateways_azfw_hub_gw_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_hub_gw_pub_ip_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_hub_name'), 'GatewaySubnet')]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "default",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_hub_gw_pub_ip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_hub_name'), 'GatewaySubnet')]"
                            }
                        }
                    }
                ],
                "sku": {
                    "name": "VpnGw1",
                    "tier": "VpnGw1"
                },
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": true,
                "activeActive": false,
                "vpnClientConfiguration": {
                    "vpnClientProtocols": [
                        "OpenVPN",
                        "IkeV2"
                    ]
                },
                "bgpSettings": {
                    "asn": 65515,
                    "bgpPeeringAddress": "10.100.0.254",
                    "peerWeight": 0
                },
                "vpnGatewayGeneration": "Generation1"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworkGateways",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworkGateways_azfw_on_prem_gw_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_on_prem_gw_pub_ip_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_on_prem_name'), 'GatewaySubnet')]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "default",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_azfw_on_prem_gw_pub_ip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_azfw_on_prem_name'), 'GatewaySubnet')]"
                            }
                        }
                    }
                ],
                "sku": {
                    "name": "VpnGw1",
                    "tier": "VpnGw1"
                },
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": true,
                "activeActive": false,
                "vpnClientConfiguration": {
                    "vpnClientProtocols": [
                        "OpenVPN",
                        "IkeV2"
                    ]
                },
                "bgpSettings": {
                    "asn": 65516,
                    "bgpPeeringAddress": "172.16.0.254",
                    "peerWeight": 0
                },
                "vpnGatewayGeneration": "Generation1"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworks_azfw_spoke1_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "192.168.1.0/24"
                    ]
                },
                "subnets": [
                    {
                        "name": "AzureBastionSubnet",
                        "properties": {
                            "addressPrefix": "192.168.1.192/27",
                             
                             
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    },
                    {
                        "name": "default",
                        "properties": {
                            "addressPrefix": "192.168.1.0/25",
                            "routeTable": {
                                "id": "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
                            },
                             
                             
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    }
                ],
               
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworks_azfw_spoke2_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "192.168.2.0/24"
                    ]
                },
                "subnets": [
                    {
                        "name": "AzureBastionSubnet",
                        "properties": {
                            "addressPrefix": "192.168.2.192/27",
                             
                             
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    },
                    {
                        "name": "default",
                        "properties": {
                            "addressPrefix": "192.168.2.0/25",
                            "routeTable": {
                                "id": "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
                            },
                             
                             
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    }
                ],
                
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_spoke1_name'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke1_name'))]",
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
            ],
            "properties": {
                "addressPrefix": "192.168.1.0/25",
                "routeTable": {
                    "id": "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
                },
                 
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_spoke2_name'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke2_name'))]",
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
            ],
            "properties": {
                "addressPrefix": "192.168.2.0/25",
                "routeTable": {
                    "id": "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_all_to_fw_name'))]"
                },
                 
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_hub_name'), '/GatewaySubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]",
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_spokes_via_fw_name'))]"
            ],
            "properties": {
                "addressPrefix": "10.100.0.224/27",
                "routeTable": {
                    "id": "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_spokes_via_fw_name'))]"
                },
                 
                 
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_hub_name'), '/hub-spoke1')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke1_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_hub_gw_name'))]"
            ],
            "properties": {
                "peeringState": "Connected",
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke1_name'))]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": false,
                "allowGatewayTransit": true,
                "useRemoteGateways": false,
                "remoteAddressSpace": {
                    "addressPrefixes": [
                        "192.168.1.0/24"
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_hub_name'), '/hub-spoke2')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke2_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_hub_gw_name'))]"
            ],
            "properties": {
                "peeringState": "Connected",
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke2_name'))]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": false,
                "allowGatewayTransit": true,
                "useRemoteGateways": false,
                "remoteAddressSpace": {
                    "addressPrefixes": [
                        "192.168.2.0/24"
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_spoke1_name'), '/spoke1-hub')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke1_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_hub_gw_name'))]"
            ],
            "properties": {
                "peeringState": "Connected",
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": true,
                "remoteAddressSpace": {
                    "addressPrefixes": [
                        "10.100.0.0/24"
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_azfw_spoke2_name'), '/spoke2-hub')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke2_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_azfw_hub_gw_name'))]"
            ],
            "properties": {
                "peeringState": "Connected",
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_hub_name'))]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": true,
                "remoteAddressSpace": {
                    "addressPrefixes": [
                       "10.100.0.0/24"
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworks_azfw_hub_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_spokes_via_fw_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke1_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_azfw_spoke2_name'))]"
            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.100.0.0/24"
                    ]
                },
                "subnets": [
                    {
                        "name": "AzureBastionSubnet",
                        "properties": {
                            "addressPrefix": "10.100.0.192/27",
                             
                             
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    },
                    {
                        "name": "default",
                        "properties": {
                            "addressPrefix": "10.100.0.0/25",
                             
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    },
                    {
                        "name": "AzureFirewallSubnet",
                        "properties": {
                            "addressPrefix": "10.100.0.128/26",
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    },
                    {
                        "name": "GatewaySubnet",
                        "properties": {
                            "addressPrefix": "10.100.0.224/27",
                            "routeTable": {
                                "id": "[resourceId('Microsoft.Network/routeTables', variables('routeTables_azfw_spokes_via_fw_name'))]"
                            },
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    }
                ],
                
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        }
    ]
}