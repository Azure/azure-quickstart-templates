{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "westus",
      "allowedValues": [
        "westus",
        "eastus",
        "centralus"
      ],
      "metadata": {
        "description": "Location where all the resources deploy"
      }
    },
    "vmAdminNameTrendDSM": {
      "type": "string",
      "defaultValue": "trend",
      "metadata": {
        "description": "TrendMicro Deep Security Manager Virtual Machine admin username"
      }
    },
    "vmAdminPasswordTrendDSM": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "TrendMicro Deep Security Manager Virtual Machine admin password"
      }
    },
    "vmSizeTrendDSM": {
      "type": "string",
      "defaultValue": "Standard_D2_v2",
      "allowedValues": [
        "Standard_D2_v2",
        "Standard_D3_v2",
        "Standard_D4_v2",
        "Standard_D5_v2"
      ],
      "metadata": {
        "description": "TrendMicro Deep Security Manager Virtual Machine size"
      }
    },
    "dsmAdminName": {
      "type": "string",
      "defaultValue": "trend",
      "metadata": {
        "description": "TrendMicro Deep Security Manager application username (To login to Trend DSM from browser)"
      }
    },
    "dsmAdminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "TrendMicro Deep Security Manager application password (To login to Trend DSM from browser)"
      }
    },
    "dbName": {
      "type": "string",
      "defaultValue": "dsm",
      "metadata": {
        "description": "TrendMicro Deep Security Manager database name"
      }
    },
    "dbAdminName": {
      "type": "string",
      "defaultValue": "trend",
      "metadata": {
        "description": "TrendMicro Deep Security Manager database admin user"
      }
    },
    "dbAdminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "TrendMicro Deep Security Manager database admin password"
      }
    },
    "publicIPDomainNameLabelTrendDSM": {
      "type": "string",
      "defaultValue": "publicdnstrenddsm",
      "metadata": {
        "description": "TrendMicro Deep Security Manager unique public DNS prefix"
      }
    },
    "managerPortTrendDSM": {
      "type": "string",
      "defaultValue": "443",
      "metadata": {
        "description": "TrendMicro Deep Security Manager management port"
      }
    },
    "heartbeatPortTrendDSM": {
      "type": "string",
      "defaultValue": "4120",
      "metadata": {
        "description": "TrendMicro Deep Security Manager heartbeat port"
      }
    },
    "vmAdminUsernameOrchServer": {
      "defaultValue": "trend",
      "type": "string",
      "metadata": {
        "description": "Orchestrator Server Virtual Machine admin username"
      }
    },
    "vmAdminPasswordOrchServer": {
      "defaultValue": "",
      "type": "securestring",
      "metadata": {
        "description": "Orchestrator Server Virtual Machine admin password"
      }
    },
    "publicIPDomainNameLabelOrchServer": {
      "defaultValue": "publicdnsorcserver",
      "type": "string",
      "metadata": {
        "description": "Orchestrator Server unique public DNS prefix"
      }
    },
    "vmAdminUsernameChefServer": {
      "defaultValue": "trend",
      "type": "string",
      "metadata": {
        "description": "Chef Server Virtual Machine admin username"
      }
    },
    "vmAdminPasswordChefServer": {
      "defaultValue": "",
      "type": "SecureString",
      "metadata": {
        "description": "Chef Server Virtual Machine admin password"
      }
    },
    "vmSizeChefServer": {
      "type": "string",
      "defaultValue": "Standard_D2",
      "allowedValues": [
        "Standard_D2",
        "Standard_D3",
        "Standard_D4",
        "Standard_D2_v2",
        "Standard_D3_v2",
        "Standard_D4_v2"
      ],
      "metadata": {
        "description": "Chef Server Virtual Machine size"
      }
    },
    "publicIPDomainNameLabelChefServer": {
      "type": "string",
      "defaultValue": "publicdnschefserver",
      "metadata": {
        "description": "Chef Server unique public DNS prefix"
      }
    },
    "chefUserName": {
      "type": "string",
      "defaultValue": "chefuser",
      "metadata": {
        "description": "Chef user name"
      }
    },
    "chefUserFirstName": {
      "type": "string",
      "defaultValue": "chef",
      "metadata": {
        "description": "Chef user first name"
      }
    },
    "chefUserLastName": {
      "type": "string",
      "defaultValue": "user",
      "metadata": {
        "description": "Chef user last name"
      }
    },
    "chefUserEmail": {
      "type": "string",
      "defaultValue": "chef@noone.com",
      "metadata": {
        "description": "Chef user email"
      }
    },
    "chefUserPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Chef user password"
      }
    },
    "chefOrgShortName": {
      "type": "string",
      "defaultValue": "ct",
      "metadata": {
        "description": "Chef org short name"
      }
    },
    "chefOrgFullName": {
      "type": "string",
      "defaultValue": "Chef Test Inc",
      "metadata": {
        "description": "Chef Org full name"
      }
    },
    "vmAdminUsernameSplunkEnterprise": {
      "defaultValue": "trend",
      "type": "string",
      "metadata": {
        "description": "Splunk Enterprise Virtual Machine admin username"
      }
    },
    "vmAdminPasswordSplunkEnterprise": {
      "defaultValue": "",
      "type": "SecureString",
      "metadata": {
        "description": "Splunk Enterprise Virtual Machine admin password"
      }
    },
    "splunkAdminPassword": {
      "defaultValue": "",
      "type": "SecureString",
      "metadata": {
        "description": "Splunk Enterprise Virtual Machine admin password"
      }
    },
    "vmSizeSplunk": {
      "type": "string",
      "defaultValue": "Standard_D4_v2",
      "allowedValues": [
        "Standard_D4_v2"
      ],
      "metadata": {
        "description": "Splunk Enterprise Virtual Machine size"
      }
    },
    "publicIPDomainNameLabelSplunkEnterprise": {
      "type": "string",
      "defaultValue": "publicdnssplunkenterprise",
      "metadata": {
        "description": "Splunk Enterprise unique public DNS prefix"
      }
    },
    "adminUsernameChefWorkstation": {
      "type": "string",
      "defaultValue": "trend",
      "metadata": {
        "description": "Chef Workstation Virtual Machine admin username"
      }
    },
    "adminPasswordChefWorkstation": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Chef Workstation Virtual Machine admin password"
      }
    },
    "vmSizeChefWorkstation": {
      "type": "string",
      "defaultValue": "Standard_D2_v2",
      "allowedValues": [
        "Standard_D2_v2",
        "Standard_D3_v2",
        "Standard_D4_v2"
      ],
      "metadata": {
        "description": "Chef Workstation Virtual Machine size"
      }
    },
    "publicIPDomainNameLabelChefWorkstation": {
      "type": "string",
      "defaultValue": "publicdnschefws",
      "metadata": {
        "description": "Chef Workstation unique public DNS prefix"
      }
    },
    "adminUsernameDSAgentWindows": {
      "type": "string",
      "defaultValue": "trend",
      "metadata": {
        "description": "Windows Deep Security Agent Virtual Machine admin username"
      }
    },
    "adminPasswordDSAgentWindows": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Windows Deep Security Agent Virtual Machine admin password"
      }
    },
    "publicIPDomainNameLabelDSAgentWindows": {
      "type": "string",
      "defaultValue": "dnsdsagentwindow",
      "metadata": {
        "description": "Windows Deep Security Agent unique public DNS prefix"
      }
    },
    "windowsvmcount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Count of Windows Deep Security Agents to deploy"
      }
    },
    "adminUsernameDSAgent": {
      "type": "string",
      "defaultValue": "trend",
      "metadata": {
        "description": "Linux Deep Security Agent Virtual Machine admin username"
      }
    },
    "adminPasswordDSAgent": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Linux Deep Security Agent Virtual Machine admin password"
      }
    },
    "publicIPDomainNameLabelDSAgent": {
      "type": "string",
      "defaultValue": "dnsdsagentlinux",
      "metadata": {
        "description": "Linux Deep Security Agent unique public DNS prefix"
      }
    },
    "linuxvmcount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Count of Linux Deep Security Agents to deploy"
      }
    },
    "baseUrl": {
      "type": "string",
      "metadata": {
        "description": "The base URL for dependent deployment files",
        "artifactsBaseUrl": ""
      },
      "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/trend-chef-splunk-security"
    }
  },
  "variables": {
    "location": "[parameters('location')]",
    "vmNameTrendDSM": "trendMicroDSM",
    "vmNameChefServer": "chefServer",
    "vmNameSplunkEnterprise": "splunkEnterprise",
    "vmNameChefWorkstation": "chefWS",
    "vmNameDSAWindows": "dsawindows",
    "vmNameDSAgent": "dsalinux",
    "vmNameOrchServer": "orchestratorServer",
    "nicNameTrendDSM": "[concat(variables('vmNameTrendDSM'),'-nic')]",
    "networkInterfaceNameChefServer": "[concat(variables('vmNameChefServer'),'-nic')]",
    "networkInterfaceNameSplunkEnterprise": "[concat(variables('vmNameSplunkEnterprise'),'-nic')]",
    "networkInterfaceNameOrchServer": "[concat(variables('vmNameOrchServer'),'-nic')]",
    "securityGroupNameTrendDSM": "[concat(variables('nicNameTrendDSM'),'-nsg')]",
    "networkSecurityGroupNameChefServer": "[concat(variables('networkInterfaceNameChefServer'),'-nsg')]",
    "networkSecurityGroupNameSplunkEnterprise": "[concat(variables('networkInterfaceNameSplunkEnterprise'),'-nsg')]",
    "networkSecurityGroupNameOrchServer": "[concat(variables('networkInterfaceNameOrchServer'),'-nsg')]",
    "virtualNetworkName": "trendMicroP2PVnet",
    "vnetAddressPrefix": "10.7.0.0/16",
    "subnet1Name": "trendMicroDSMsubnet",
    "subnet1Prefix": "10.7.0.0/24",
    "subnet2Name": "chefServersubnet",
    "subnet2Prefix": "10.7.1.0/24",
    "subnet3Name": "splunkEnterprisesubnet",
    "subnet3Prefix": "10.7.2.0/24",
    "subnet3StartAddress": "10.7.2.5",
    "subnet4Name": "vmsubnet",
    "subnet4Prefix": "10.7.3.0/24",
    "publicIPAddressType": "Dynamic",
    "publicIPAddressNameTrendDSM": "publicIPTrendDSM",
    "publicIPAddressNameChefServer": "publicIPChefServer",
    "publicIPAddressNameSplunkEnterprise": "publicIPSplunkEnterprise",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
    "subnet1Ref": "[concat(variables('vnetID'),'/subnets/',variables('subnet1Name'))]",
    "subnet2Ref": "[concat(variables('vnetID'),'/subnets/',variables('subnet2Name'))]",
    "subnet3Ref": "[concat(variables('vnetID'),'/subnets/',variables('subnet3Name'))]",
    "subnet4Ref": "[concat(variables('vnetID'),'/subnets/',variables('subnet4Name'))]",
    "storageAccountName": "[tolower(concat(trim(substring(concat(variables('vmNameTrendDSM'),'       '),0,6)),uniquestring(resourceGroup().id)))]",
    "storageAccountType": "Standard_LRS",
    "vmStorageAccountContainerName": "vhds",
    "newsqlServerName": "[tolower(concat(variables('vmNameTrendDSM'),uniquestring(resourceGroup().id),'-sql'))]",
    "storage-api-version": "2015-06-15",
    "deployment-api-version": "2015-11-01",
    "deployment-api-version2": "2015-01-01",
    "network-api-version": "2015-06-15",
    "compute-api-version": "2015-06-15",
    "automation-api-version": "2015-01-01-preview",
    "automation-api-version2": "2015-10-31",
    "publisherTrendDSM": "trendmicro",
    "publisherChefServer": "chef-software",
    "licenseMode": "10",
    "databaseOption": "new",
    "offerChoosedTrendDSM": "[variables(concat('offer', parameters('vmSizeTrendDSM')))]",
    "offerChoosedChefServer": "[variables(concat('offer', parameters('vmSizeChefServer')))]",
    "offerStandard_D2_v2": {
      "vmSize": "Standard_D2_v2",
      "vmSku": "dxxn25d2v2",
      "product": "deep-security-vm"
    },
    "offerStandard_D3_v2": {
      "vmSize": "Standard_D3_v2",
      "vmSku": "dxxn50d3v2",
      "product": "deep-security-vm"
    },
    "offerStandard_D4_v2": {
      "vmSize": "Standard_D4_v2",
      "vmSku": "dxxn100d4v2",
      "product": "deep-security-vm"
    },
    "offerStandard_D5_v2": {
      "vmSize": "Standard_D5_v2",
      "vmSku": "dxxn200d5v2",
      "product": "deep-security-vm"
    },
    "offerBYOL": {
      "vmSize": "[parameters('vmSizeTrendDSM')]",
      "vmSku": "dxxnbyol",
      "product": "deep-security-vm-byol"
    },
    "offerStandard_D2": {
      "vmSize": "Standard_D2",
      "vmSku": "azure_marketplace_25",
      "product": "chef-server"
    },
    "availabilitySetSettings": {
      "name": "[concat(variables('virtualNetworkName'), '-aset')]",
      "count": "[variables('tshirtSizeSplunk').availabilitySetCount]",
      "fdCount": 3,
      "udCount": 5
    },
    "sshFrom": "0.0.0.0/0",
    "forwardedDataFrom": "0.0.0.0/0",
    "deploymentSizeSplunk": "Standalone",
    "emptyTemplateUrl": "[concat(parameters('baseUrl'),'/nested/empty-resources.json')]",
    "tshirtSizeSplunk": "[variables(concat('tshirtSizeSplunk', variables('deploymentSizeSplunk')))]",
    "tshirtSizeSplunkStandalone": {
      "vmSize": "[parameters('vmSizeSplunk')]",
      "vmSizeClusterMaster": "Standard_D3",
      "diskSize": 1023,
      "standaloneTemplateUrl": "[concat(parameters('baseUrl'), '/nested/trendp2p-splunkenterprise.json')]",
      "clusterMasterTemplateUrl": "[variables('emptyTemplateUrl')]",
      "clusterSearchheadTemplateUrl": "[variables('emptyTemplateUrl')]",
      "clusterPeersTemplateUrl": "[variables('emptyTemplateUrl')]",
      "clusterPeersCount": 0,
      "availabilitySetCount": 1,
      "publicIPAddress": {
        "name": "[variables('publicIPAddressNameSplunkEnterprise')]",
        "domainNamePrefix": "[concat(parameters('publicIPDomainNameLabelSplunkEnterprise'),variables('uniqueString'))]",
        "count": 1,
        "map": [
          ""
        ]
      }
    },
    "osSettingsSplunk": {
      "imageReference": {
        "publisher": "splunk",
        "offer": "splunk-enterprise-base-image",
        "sku": "splunk-on-ubuntu-14-04-lts",
        "version": "1.0.8"
      },
      "scripts": [
        "[concat(parameters('baseUrl'), '/scripts/', 'vm-disk-utils-0.1.sh')]",
        "[concat(parameters('baseUrl'), '/scripts/', 'node-setup.sh')]",
        "[concat(parameters('baseUrl'), '/scripts/', 'splunkscript.sh')]"
      ]
    },
    "networkSettingsSplunk": {
      "virtualNetworkName": "[variables('virtualNetworkName')]",
      "subnet": {
        "sh": {
          "name": "[variables('subnet1Name')]",
          "prefix": "[variables('subnet1Prefix')]",
          "vnet": "[variables('virtualNetworkName')]"
        },
        "idx": {
          "name": "[variables('subnet2Name')]",
          "prefix": "[variables('subnet2Prefix')]",
          "vnet": "[variables('virtualNetworkName')]"
        }
      },
      "statics": {
        "standaloneIp": "[variables('subnet3StartAddress')]",
        "clusterSearchheadIp": "[variables('subnet3StartAddress')]",
        "clusterMasterIp": "[variables('subnet3StartAddress')]"
      }
    },
    "linuxConfigurationChoosenTrendDSM": "[variables(concat('linuxConfiguration', variables('vmAuthTypeTrendDSM')))]",
    "linuxConfigurationpassword": {
      "disablePasswordAuthentication": "false"
    },
    "linuxConfigurationsshPublicKey": {
      "disablePasswordAuthentication": "true",
      "ssh": {
        "publicKeys": [
          {
            "path": "[concat('/home/',parameters('vmAdminNameTrendDSM'),'/.ssh/authorized_keys')]",
            "keyData": "[variables('vmAdminSshPublicKeyTrendDSM')]"
          }
        ]
      }
    },
    "imagePublisherWindows": "MicrosoftWindowsServer",
    "imageOfferWindows": "WindowsServer",
    "imagePublisherLinux": "Canonical",
    "imageOfferLinux": "UbuntuServer",
    "TenantIdentifier": "NA",
    "TenantActivationPassword": "NA",
    "tagvalues": {
      "program": "p2p",
      "project": "TrendMicro"
    },
    "vmAuthTypeTrendDSM": "password",
    "vmAdminSshPublicKeyTrendDSM": "",
    "existingSQLServerName": "",
    "networkExists": "new",
    "ManagerAddress": "[concat(parameters('publicIPDomainNameLabelTrendDSM'),variables('uniqueString'),'.',parameters('location'),'.cloudapp.azure.com')]",
    "udpPort": "5005",
    "chefServerScriptUrl": "[concat(parameters('baseUrl'),'/scripts/chefserver.sh')]",
    "chefprefix": "chef",
    "vmSizeDSAWindows": "Standard_D1",
    "windowsOSVersion": "2012-R2-Datacenter",
    "vmSizeDSAgent": "Standard_D1",
    "ubuntuOSVersion": "14.04.2-LTS",
    "uniqueString": "[uniquestring(resourceGroup().id)]",
    "keyName": "validatorkey",
    "resourcegroupName": "[resourceGroup().name]",
    "kmServerUrl": "[concat(parameters('publicIPDomainNameLabelOrchServer'),variables('uniqueString'),'.',variables('location'),'.cloudapp.azure.com')]",
    "chef_node_name": "chefnodedsagent",
    "chef_server_url": "[concat('https://',parameters('publicIPDomainNameLabelChefServer'),variables('uniqueString'),'.',parameters('location'),'.cloudapp.azure.com/organizations/',parameters('chefOrgShortName'))]",
    "validation_client_name": "[concat(parameters('chefOrgShortName'),'-validator')]",
    "validation_key_format": "base64encoded",
    "runlist": "recipe[trendmicro]",
    "vmSizeOrcServer": "Standard_D1",
    "orcServerubuntuOSVersion": "14.04.2-LTS",
    "installOrchTemplateurl": "[concat(parameters('baseUrl'),'/nested/orchestrator-server-setup-trend.json')]",
    "chefnodeCustomScripturl": "[concat(parameters('baseUrl'),'/scripts/p2pchefnodebootstrap.sh')]",
    "trendmicroTags":{
      "type":"object",
      "provider":"F0253A01-8156-4D41-BD91-E182158D4972"
    },
    "chefSoftwareTags":{
      "type":"object",
      "provider":"33194f91-eb5f-4110-827a-e95f640a9e46"
    },
    "splunkTags":{
      "type":"object",
      "provider":"7d69ff10-1a05-4353-b69d-0e87c3382e96"
    },
    "quickstartTags":{
      "type":"object",
      "name":"trend-chef-splunk-security"
    } 
  },
  "resources": [
    {
      "comments": "Gene",
      "name": "vnetstorage",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deployment-api-version2')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('baseUrl'), '/nested/trendp2p-vnetstorage.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "storage-api-version": {
            "value": "[variables('storage-api-version')]"
          },
          "storageAccountType": {
            "value": "[variables('storageAccountType')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "virtualNetworkName": {
            "value": "[variables('virtualNetworkName')]"
          },
          "vnetAddressPrefix": {
            "value": "[variables('vnetAddressPrefix')]"
          },
          "subnet1Name": {
            "value": "[variables('subnet1Name')]"
          },
          "subnet1Prefix": {
            "value": "[variables('subnet1Prefix')]"
          },
          "subnet2Name": {
            "value": "[variables('subnet2Name')]"
          },
          "subnet2Prefix": {
            "value": "[variables('subnet2Prefix')]"
          },
          "subnet3Name": {
            "value": "[variables('subnet3Name')]"
          },
          "subnet3Prefix": {
            "value": "[variables('subnet3Prefix')]"
          },
          "subnet4Name": {
            "value": "[variables('subnet4Name')]"
          },
          "subnet4Prefix": {
            "value": "[variables('subnet4Prefix')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "availabilitySetSettings": {
            "value": "[variables('availabilitySetSettings')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "splunkTags": {
            "value": "[variables('splunkTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "name": "trendmicrodsm",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deployment-api-version2')]",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('baseUrl'), '/nested/trendp2p-trenddsm.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "publicIPDomainNameLabelTrendDSM": {
            "value": "[concat(parameters('publicIPDomainNameLabelTrendDSM'),variables('uniqueString'))]"
          },
          "publicIPAddressType": {
            "value": "[variables('publicIPAddressType')]"
          },
          "publicIPAddressNameTrendDSM": {
            "value": "[variables('publicIPAddressNameTrendDSM')]"
          },
          "nicNameTrendDSM": {
            "value": "[variables('nicNameTrendDSM')]"
          },
          "virtualNetworkName": {
            "value": "[variables('virtualNetworkName')]"
          },
          "subnet1Ref": {
            "value": "[variables('subnet1Ref')]"
          },
          "securityGroupNameTrendDSM": {
            "value": "[variables('securityGroupNameTrendDSM')]"
          },
          "managerPortTrendDSM": {
            "value": "[parameters('managerPortTrendDSM')]"
          },
          "heartbeatPortTrendDSM": {
            "value": "[parameters('heartbeatPortTrendDSM')]"
          },
          "vmNameTrendDSM": {
            "value": "[variables('vmNameTrendDSM')]"
          },
          "publisherTrendDSM": {
            "value": "[variables('publisherTrendDSM')]"
          },
          "offerChoosedTrendDSM": {
            "value": "[variables('offerChoosedTrendDSM')]"
          },
          "vmAdminNameTrendDSM": {
            "value": "[parameters('vmAdminNameTrendDSM')]"
          },
          "vmAdminPasswordTrendDSM": {
            "value": "[parameters('vmAdminPasswordTrendDSM')]"
          },
          "linuxConfigurationChoosenTrendDSM": {
            "value": "[variables('linuxConfigurationChoosenTrendDSM')]"
          },
          "deployment-api-version": {
            "value": "[variables('deployment-api-version')]"
          },
          "baseUrl": {
            "value": "[parameters('baseUrl')]"
          },
          "databaseOption": {
            "value": "[variables('databaseOption')]"
          },
          "newsqlServerName": {
            "value": "[variables('newsqlServerName')]"
          },
          "existingSQLServerName": {
            "value": "[variables('existingSQLServerName')]"
          },
          "dbAdminName": {
            "value": "[parameters('dbAdminName')]"
          },
          "dbAdminPassword": {
            "value": "[parameters('dbAdminPassword')]"
          },
          "dbName": {
            "value": "[parameters('dbName')]"
          },
          "dsmAdminName": {
            "value": "[parameters('dsmAdminName')]"
          },
          "dsmAdminPassword": {
            "value": "[parameters('dsmAdminPassword')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "splunkTags": {
            "value": "[variables('splunkTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "name": "orchestrator",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deployment-api-version2')]",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('baseUrl'), '/nested/trendp2p-orchestrator.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "deployment-api-version2": {
            "value": "[variables('deployment-api-version2')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "publicIPDomainNameLabelOrchServer": {
            "value": "[concat(parameters('publicIPDomainNameLabelOrchServer'),variables('uniqueString'))]"
          },
          "vmNameOrchServer": {
            "value": "[variables('vmNameOrchServer')]"
          },
          "networkInterfaceNameOrchServer": {
            "value": "[variables('networkInterfaceNameOrchServer')]"
          },
          "networkSecurityGroupNameOrchServer": {
            "value": "[variables('networkSecurityGroupNameOrchServer')]"
          },
          "vmAdminUsernameOrchServer": {
            "value": "[parameters('vmAdminUsernameOrchServer')]"
          },
          "vmAdminPasswordOrchServer": {
            "value": "[parameters('vmAdminPasswordOrchServer')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "imagePublisherLinux": {
            "value": "[variables('imagePublisherLinux')]"
          },
          "imageOfferLinux": {
            "value": "[variables('imageOfferLinux')]"
          },
          "orcServerubuntuOSVersion": {
            "value": "[variables('orcServerubuntuOSVersion')]"
          },
          "vmSizeOrcServer": {
            "value": "[variables('vmSizeOrcServer')]"
          },
          "subnet2Ref": {
            "value": "[variables('subnet2Ref')]"
          },
          "installOrchTemplateurl": {
            "value": "[variables('installOrchTemplateurl')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "splunkTags": {
            "value": "[variables('splunkTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "name": "chefserver",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deployment-api-version2')]",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']",
        "['Microsoft.Resources/deployments/trendmicrodsm']",
        "['Microsoft.Resources/deployments/orchestrator']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('baseUrl'), '/nested/trendp2p-chefserver.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "publicIPAddressNameChefServer": {
            "value": "[variables('publicIPAddressNameChefServer')]"
          },
          "publicIPDomainNameLabelChefServer": {
            "value": "[concat(parameters('publicIPDomainNameLabelChefServer'),variables('uniqueString'))]"
          },
          "networkSecurityGroupNameChefServer": {
            "value": "[variables('networkSecurityGroupNameChefServer')]"
          },
          "networkInterfaceNameChefServer": {
            "value": "[variables('networkInterfaceNameChefServer')]"
          },
          "vmNameChefServer": {
            "value": "[variables('vmNameChefServer')]"
          },
          "vmAdminUsernameChefServer": {
            "value": "[parameters('vmAdminUsernameChefServer')]"
          },
          "vmAdminPasswordChefServer": {
            "value": "[parameters('vmAdminPasswordChefServer')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "publisherChefServer": {
            "value": "[variables('publisherChefServer')]"
          },
          "offerChoosedChefServer": {
            "value": "[variables('offerChoosedChefServer')]"
          },
          "subnet2Ref": {
            "value": "[variables('subnet2Ref')]"
          },
          "publicIPAddressType": {
            "value": "[variables('publicIPAddressType')]"
          },
          "chefUserName": {
            "value": "[parameters('chefUserName')]"
          },
          "chefUserFirstName": {
            "value": "[parameters('chefUserFirstName')]"
          },
          "chefUserLastName": {
            "value": "[parameters('chefUserLastName')]"
          },
          "chefUserEmail": {
            "value": "[parameters('chefUserEmail')]"
          },
          "chefUserPassword": {
            "value": "[parameters('chefUserPassword')]"
          },
          "chefOrgShortName": {
            "value": "[parameters('chefOrgShortName')]"
          },
          "chefOrgFullName": {
            "value": "[parameters('chefOrgFullName')]"
          },
          "chefServerScriptUrl": {
            "value": "[variables('chefServerScriptUrl')]"
          },
          "publicIPDomainNameLabelOrchServer": {
            "value": "[concat(parameters('publicIPDomainNameLabelOrchServer'),variables('uniqueString'))]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "splunkTags": {
            "value": "[variables('splunkTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('deployment-api-version2')]",
      "type": "Microsoft.Resources/deployments",
      "name": "splunkstandalonedeployment",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('tshirtSizeSplunk').standaloneTemplateUrl]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "vmNameSplunkEnterprise": {
            "value": "[variables('vmNameSplunkEnterprise')]"
          },
          "vmAdminUsernameSplunkEnterprise": {
            "value": "[parameters('vmAdminUsernameSplunkEnterprise')]"
          },
          "vmAdminPasswordSplunkEnterprise": {
            "value": "[parameters('vmAdminPasswordSplunkEnterprise')]"
          },
          "splunkAdminPassword": {
            "value": "[parameters('splunkAdminPassword')]"
          },
          "publicIPAddressSettingsSplunk": {
            "value": "[variables('tshirtSizeSplunk').publicIPAddress]"
          },
          "networkSecurityGroupNameSplunkEnterprise": {
            "value": "[variables('networkSecurityGroupNameSplunkEnterprise')]"
          },
          "networkInterfaceNameSplunkEnterprise": {
            "value": "[variables('networkInterfaceNameSplunkEnterprise')]"
          },
          "machineSettings": {
            "value": {
              "vmSize": "[variables('tshirtSizeSplunk').vmSize]",
              "diskSize": "[variables('tshirtSizeSplunk').diskSize]",
              "staticIp": "[variables('networkSettingsSplunk').statics.standaloneIp]",
              "clusterMasterIp": "NA",
              "publicIPName": "[concat(variables('tshirtSizeSplunk').publicIPAddress.name, '')]",
              "sshFrom": "[concat(variables('sshFrom'), '')]",
              "forwardedDataFrom": "[concat(variables('forwardedDataFrom'), '')]",
              "availabilitySet": "[concat(variables('availabilitySetSettings').name, '0')]"
            }
          },
          "subnet3Ref": {
            "value": "[variables('subnet3Ref')]"
          },
          "osSettingsSplunk": {
            "value": "[variables('osSettingsSplunk')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "udpPort": {
            "value": "[variables('udpPort')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "splunkTags": {
            "value": "[variables('splunkTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('deployment-api-version2')]",
      "type": "Microsoft.Resources/deployments",
      "name": "dsagents",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']",
        "['Microsoft.Resources/deployments/trendmicrodsm']",
        "['Microsoft.Resources/deployments/chefserver']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('baseUrl'), '/nested/trendp2p-dsagents.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "vmNameDSAWindows": {
            "value": "[variables('vmNameDSAWindows')]"
          },
          "vmSizeDSAWindows": {
            "value": "[variables('vmSizeDSAWindows')]"
          },
          "adminUsernameDSAgentWindows": {
            "value": "[parameters('adminUsernameDSAgentWindows')]"
          },
          "adminPasswordDSAgentWindows": {
            "value": "[parameters('adminPasswordDSAgentWindows')]"
          },
          "publicIPDomainNameLabelDSAgentWindows": {
            "value": "[concat(parameters('publicIPDomainNameLabelDSAgentWindows'),variables('uniqueString'))]"
          },
          "windowsOSVersion": {
            "value": "[variables('windowsOSVersion')]"
          },
          "windowsvmcount": {
            "value": "[parameters('windowsvmcount')]"
          },
          "vmNameDSAgent": {
            "value": "[variables('vmNameDSAgent')]"
          },
          "vmSizeDSAgent": {
            "value": "[variables('vmSizeDSAgent')]"
          },
          "adminUsernameDSAgent": {
            "value": "[parameters('adminUsernameDSAgent')]"
          },
          "adminPasswordDSAgent": {
            "value": "[parameters('adminPasswordDSAgent')]"
          },
          "publicIPDomainNameLabelDSAgent": {
            "value": "[concat(parameters('publicIPDomainNameLabelDSAgent'),variables('uniqueString'))]"
          },
          "ubuntuOSVersion": {
            "value": "[variables('ubuntuOSVersion')]"
          },
          "linuxvmcount": {
            "value": "[parameters('linuxvmcount')]"
          },
          "ManagerAddress": {
            "value": "[variables('ManagerAddress')]"
          },
          "subnet4Ref": {
            "value": "[variables('subnet4Ref')]"
          },
          "imagePublisherWindows": {
            "value": "[variables('imagePublisherWindows')]"
          },
          "imageOfferWindows": {
            "value": "[variables('imageOfferWindows')]"
          },
          "imagePublisherLinux": {
            "value": "[variables('imagePublisherLinux')]"
          },
          "imageOfferLinux": {
            "value": "[variables('imageOfferLinux')]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "ActivationPort": {
            "value": "[parameters('heartbeatPortTrendDSM')]"
          },
          "TenantIdentifier": {
            "value": "[variables('TenantIdentifier')]"
          },
          "TenantActivationPassword": {
            "value": "[variables('TenantActivationPassword')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "splunkTags": {
            "value": "[variables('splunkTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('deployment-api-version2')]",
      "type": "Microsoft.Resources/deployments",
      "name": "chefnodes",
      "dependsOn": [
        "['Microsoft.Resources/deployments/vnetstorage']",
        "['Microsoft.Resources/deployments/trendmicrodsm']",
        "['Microsoft.Resources/deployments/chefserver']"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('baseUrl'), '/nested/trendp2p-chefnodes.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "network-api-version": {
            "value": "[variables('network-api-version')]"
          },
          "compute-api-version": {
            "value": "[variables('compute-api-version')]"
          },
          "deployment-api-version2": {
            "value": "[variables('deployment-api-version2')]"
          },
          "vmNameChefWorkstation": {
            "value": "[variables('vmNameChefWorkstation')]"
          },
          "vmSizeChefWorkstation": {
            "value": "[parameters('vmSizeChefWorkstation')]"
          },
          "adminUsernameChefWorkstation": {
            "value": "[parameters('adminUsernameChefWorkstation')]"
          },
          "adminPasswordChefWorkstation": {
            "value": "[parameters('adminPasswordChefWorkstation')]"
          },
          "publicIPDomainNameLabelChefWorkstation": {
            "value": "[concat(parameters('publicIPDomainNameLabelChefWorkstation'),variables('uniqueString'))]"
          },
          "vmNameDSAWindows": {
            "value": "[variables('vmNameDSAWindows')]"
          },
          "vmSizeDSAWindows": {
            "value": "[variables('vmSizeDSAWindows')]"
          },
          "adminUsernameDSAgentWindows": {
            "value": "[parameters('adminUsernameDSAgentWindows')]"
          },
          "adminPasswordDSAgentWindows": {
            "value": "[parameters('adminPasswordDSAgentWindows')]"
          },
          "publicIPDomainNameLabelDSAgentWindows": {
            "value": "[concat(parameters('publicIPDomainNameLabelDSAgentWindows'),variables('uniqueString'))]"
          },
          "windowsOSVersion": {
            "value": "[variables('windowsOSVersion')]"
          },
          "windowsvmcount": {
            "value": "[parameters('windowsvmcount')]"
          },
          "vmNameDSAgent": {
            "value": "[variables('vmNameDSAgent')]"
          },
          "vmSizeDSAgent": {
            "value": "[variables('vmSizeDSAgent')]"
          },
          "adminUsernameDSAgent": {
            "value": "[parameters('adminUsernameDSAgent')]"
          },
          "adminPasswordDSAgent": {
            "value": "[parameters('adminPasswordDSAgent')]"
          },
          "publicIPDomainNameLabelDSAgent": {
            "value": "[concat(parameters('publicIPDomainNameLabelDSAgent'),variables('uniqueString'))]"
          },
          "ubuntuOSVersion": {
            "value": "[variables('ubuntuOSVersion')]"
          },
          "linuxvmcount": {
            "value": "[parameters('linuxvmcount')]"
          },
          "ManagerAddress": {
            "value": "[variables('ManagerAddress')]"
          },
          "subnet4Ref": {
            "value": "[variables('subnet4Ref')]"
          },
          "imagePublisherWindows": {
            "value": "[variables('imagePublisherWindows')]"
          },
          "imageOfferWindows": {
            "value": "[variables('imageOfferWindows')]"
          },
          "imagePublisherLinux": {
            "value": "[variables('imagePublisherLinux')]"
          },
          "imageOfferLinux": {
            "value": "[variables('imageOfferLinux')]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "vmStorageAccountContainerName": {
            "value": "[variables('vmStorageAccountContainerName')]"
          },
          "ActivationPort": {
            "value": "[parameters('heartbeatPortTrendDSM')]"
          },
          "TenantIdentifier": {
            "value": "[variables('TenantIdentifier')]"
          },
          "TenantActivationPassword": {
            "value": "[variables('TenantActivationPassword')]"
          },
          "tagvalues": {
            "value": "[variables('tagvalues')]"
          },
          "chefprefix": {
            "value": "[variables('chefprefix')]"
          },
          "keyName": {
            "value": "[variables('keyName')]"
          },
          "kmServerUrl": {
            "value": "[variables('kmServerUrl')]"
          },
          "chef_node_name": {
            "value": "[variables('chef_node_name')]"
          },
          "chef_server_url": {
            "value": "[variables('chef_server_url')]"
          },
          "validation_client_name": {
            "value": "[variables('validation_client_name')]"
          },
          "validation_key_format": {
            "value": "[variables('validation_key_format')]"
          },
          "runlist": {
            "value": "[variables('runlist')]"
          },
          "resourcegroupName": {
            "value": "[variables('resourcegroupName')]"
          },
          "chefnodeCustomScripturl": {
            "value": "[variables('chefnodeCustomScripturl')]"
          },
          "trendmicroTags": {
            "value": "[variables('trendmicroTags')]"
          },
          "chefSoftwareTags": {
            "value": "[variables('chefSoftwareTags')]"
          },
          "splunkTags": {
            "value": "[variables('splunkTags')]"
          },
          "quickstartTags": {
            "value": "[variables('quickstartTags')]"
          }
        }
      }
    }
  ],
  "outputs": {
    "TrendMicro DSM URI": {
      "type": "string",
      "value": "[reference('trendmicrodsm').outputs.trendmicrodsmUri.value]"
    },
    "Chef Server URI": {
      "type": "string",
      "value": "[reference('chefserver').outputs.chefserverUri.value]"
    },
    "Splunk Server URI": {
      "type": "string",
      "value": "[reference('splunkstandalonedeployment').outputs.splunkenterpriseUri.value]"
    }
  }
}
